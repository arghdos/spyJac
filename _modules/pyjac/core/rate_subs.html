
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pyjac.core.rate_subs &#8212; pyJac 2.0.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pyjac.core.rate_subs</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Module for writing species/reaction rate subroutines.</span>

<span class="sd">This is kept separate from Jacobian creation module in order</span>
<span class="sd">to create only the rate subroutines if desired.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Python 2 compatibility</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="c1"># Standard libraries</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="k">import</span> <span class="n">Template</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>

<span class="c1"># Non-standard librarys</span>
<span class="kn">import</span> <span class="nn">loopy</span> <span class="k">as</span> <span class="nn">lp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">loopy.kernel.data</span> <span class="k">import</span> <span class="n">AddressSpace</span> <span class="k">as</span> <span class="n">scopes</span>

<span class="c1"># Local imports</span>
<span class="kn">from</span> <span class="nn">pyjac</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">pyjac.core</span> <span class="k">import</span> <span class="n">chem_model</span> <span class="k">as</span> <span class="n">chem</span>
<span class="kn">from</span> <span class="nn">pyjac.core.enum_types</span> <span class="k">import</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">falloff_form</span><span class="p">,</span> <span class="n">thd_body_type</span><span class="p">,</span>\
    <span class="n">RateSpecialization</span><span class="p">,</span> <span class="n">KernelType</span>
<span class="kn">from</span> <span class="nn">pyjac.core</span> <span class="k">import</span> <span class="n">instruction_creator</span> <span class="k">as</span> <span class="n">ic</span>
<span class="kn">from</span> <span class="nn">pyjac.core</span> <span class="k">import</span> <span class="n">array_creator</span> <span class="k">as</span> <span class="n">arc</span>
<span class="kn">from</span> <span class="nn">pyjac.core.array_creator</span> <span class="k">import</span> <span class="p">(</span><span class="n">global_ind</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">default_inds</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyjac.loopy_utils</span> <span class="k">import</span> <span class="n">preambles_and_manglers</span> <span class="k">as</span> <span class="n">lp_pregen</span>
<span class="kn">from</span> <span class="nn">pyjac.kernel_utils</span> <span class="k">import</span> <span class="n">kernel_gen</span> <span class="k">as</span> <span class="n">k_gen</span>


<div class="viewcode-block" id="inputs_and_outputs"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.inputs_and_outputs">[docs]</a><span class="k">def</span> <span class="nf">inputs_and_outputs</span><span class="p">(</span><span class="n">conp</span><span class="p">,</span> <span class="n">ktype</span><span class="o">=</span><span class="n">KernelType</span><span class="o">.</span><span class="n">species_rates</span><span class="p">,</span> <span class="n">output_full_rop</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A convenience method such that kernel inputs / output argument names are</span>
<span class="sd">    available for inspection</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    conp: bool</span>
<span class="sd">        If true, use constant-pressure formulation, else constant-volume</span>
<span class="sd">    ktype: :class:`KernelType`</span>
<span class="sd">        The kernel type to return the arguments for -- if unspecified, defaults to</span>
<span class="sd">        species rates</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    input_args: list of str</span>
<span class="sd">        The input arguments to kernels generated in this file</span>
<span class="sd">    output_args: list of str</span>
<span class="sd">        The output arguments to kernels generated in this file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ktype</span> <span class="o">==</span> <span class="n">KernelType</span><span class="o">.</span><span class="n">species_rates</span><span class="p">:</span>
        <span class="n">input_args</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">kernel_argument_ordering</span><span class="p">(</span>
            <span class="p">[</span><span class="n">arc</span><span class="o">.</span><span class="n">state_vector</span><span class="p">,</span> <span class="n">arc</span><span class="o">.</span><span class="n">pressure_array</span> <span class="k">if</span> <span class="n">conp</span> <span class="k">else</span> <span class="n">arc</span><span class="o">.</span><span class="n">volume_array</span><span class="p">],</span>
            <span class="n">ktype</span><span class="p">)</span>
        <span class="n">output_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">arc</span><span class="o">.</span><span class="n">state_vector_rate_of_change</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">ktype</span> <span class="o">==</span> <span class="n">KernelType</span><span class="o">.</span><span class="n">chem_utils</span><span class="p">:</span>
        <span class="n">input_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">arc</span><span class="o">.</span><span class="n">state_vector</span><span class="p">]</span>
        <span class="n">output_args</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">kernel_argument_ordering</span><span class="p">(</span>
            <span class="p">[</span><span class="n">arc</span><span class="o">.</span><span class="n">enthalpy_array</span><span class="p">,</span> <span class="n">arc</span><span class="o">.</span><span class="n">constant_pressure_specific_heat</span><span class="p">,</span>
             <span class="n">arc</span><span class="o">.</span><span class="n">rate_const_thermo_coeff_array</span><span class="p">]</span> <span class="k">if</span> <span class="n">conp</span> <span class="k">else</span> <span class="p">[</span>
             <span class="n">arc</span><span class="o">.</span><span class="n">internal_energy_array</span><span class="p">,</span> <span class="n">arc</span><span class="o">.</span><span class="n">constant_volume_specific_heat</span><span class="p">,</span>
             <span class="n">arc</span><span class="o">.</span><span class="n">rate_const_thermo_coeff_array</span><span class="p">],</span> <span class="n">ktype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">output_full_rop</span><span class="p">:</span>
        <span class="n">output_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;rop_fwd&#39;</span><span class="p">,</span> <span class="s1">&#39;rop_rev&#39;</span><span class="p">,</span> <span class="s1">&#39;pres_mod&#39;</span><span class="p">,</span> <span class="s1">&#39;rop_net&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">input_args</span><span class="p">,</span> <span class="n">output_args</span></div>


<div class="viewcode-block" id="assign_rates"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.assign_rates">[docs]</a><span class="k">def</span> <span class="nf">assign_rates</span><span class="p">(</span><span class="n">reacs</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">rate_spec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From a given set of reactions, determine the rate types for evaluation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reacs : list of `ReacInfo`</span>
<span class="sd">        The reactions in the mechanism</span>
<span class="sd">    specs : list of `SpecInfo`</span>
<span class="sd">        The species in the mechanism</span>
<span class="sd">    rate_spec : `RateSpecialization` enum</span>
<span class="sd">        The specialization option specified</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    For simple Arrhenius evaluations, the rate type keys are:</span>

<span class="sd">    if rate_spec == RateSpecialization.full</span>
<span class="sd">        0 -&gt; kf = A</span>
<span class="sd">        1 -&gt; kf = A * T * T * T ...</span>
<span class="sd">        2 -&gt; kf = exp(logA + b * logT)</span>
<span class="sd">        3 -&gt; kf = exp(logA - Ta / T)</span>
<span class="sd">        4 -&gt; kf = exp(logA + b * logT - Ta / T)</span>

<span class="sd">    if rate_spec = RateSpecialization.hybrid</span>
<span class="sd">        0 -&gt; kf = A</span>
<span class="sd">        1 -&gt; kf = A * T * T * T ...</span>
<span class="sd">        2 -&gt; kf = exp(logA + b * logT - Ta / T)</span>

<span class="sd">    if rate_spec == RateSpecialization.fixed</span>
<span class="sd">        0 -&gt; kf = exp(logA + b * logT - Ta / T)</span>

<span class="sd">    Note that the reactions in &#39;fall&#39;, &#39;chem&#39; and &#39;thd&#39; are also in</span>
<span class="sd">            &#39;simple&#39;</span>
<span class="sd">        Further, there are duplicates between &#39;thd&#39; and &#39;fall&#39; / &#39;chem&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rate_info : dict of parameters</span>
<span class="sd">        Keys are &#39;simple&#39;, &#39;plog&#39;, &#39;cheb&#39;, &#39;fall&#39;, &#39;chem&#39;, &#39;thd&#39;</span>
<span class="sd">        Values are further dictionaries including addtional rate info, number,</span>
<span class="sd">        offset, maps, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">rate_spec</span> <span class="ow">in</span> <span class="n">RateSpecialization</span>
    <span class="c1"># determine specialization</span>
    <span class="n">full</span> <span class="o">=</span> <span class="n">rate_spec</span> <span class="o">==</span> <span class="n">RateSpecialization</span><span class="o">.</span><span class="n">full</span>
    <span class="c1"># hybrid = rate_spec == RateSpecialization.hybrid</span>
    <span class="n">fixed</span> <span class="o">=</span> <span class="n">rate_spec</span> <span class="o">==</span> <span class="n">RateSpecialization</span><span class="o">.</span><span class="n">fixed</span>

    <span class="c1"># find fwd / reverse rate parameters</span>
    <span class="c1"># first, the number of each</span>
    <span class="n">rev_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">rev</span><span class="p">],</span>
                       <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
    <span class="n">num_rev</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rev_map</span><span class="p">)</span>
    <span class="c1"># next, find the species / nu values</span>
    <span class="n">nu_sum</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">net_num_spec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">net_spec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">net_nu</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">reac_has_ns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ns_nu</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i_rxn</span><span class="p">,</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reacs</span><span class="p">):</span>
        <span class="c1"># get list of species in reaction</span>
        <span class="n">spec_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="p">[:]</span> <span class="o">+</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">[:]))</span>
        <span class="c1"># add species / num</span>
        <span class="n">net_spec</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">spec_list</span><span class="p">)</span>
        <span class="n">net_num_spec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec_list</span><span class="p">))</span>
        <span class="c1"># get fwd / reverse nu for species</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">spec_list</span><span class="p">:</span>
            <span class="c1"># get reactant index</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">spec</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">reac_nu</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>

            <span class="c1"># get product index</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">spec</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">prod_nu</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod_nu</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>

            <span class="c1"># and add nu values</span>
            <span class="n">net_nu</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">prod_nu</span><span class="p">,</span> <span class="n">reac_nu</span><span class="p">])</span>

        <span class="c1"># and nu sum for equilibrium constants</span>
        <span class="n">nu_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">utils</span><span class="o">.</span><span class="n">get_nu</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">rxn</span><span class="p">)</span> <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="n">spec_list</span><span class="p">]))</span>

        <span class="c1"># handle fwd / rev nu for last species indicator</span>
        <span class="n">ns_reac_ind</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">reac</span><span class="p">[:])</span>
                            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ns_reac_nu</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reac_nu</span><span class="p">[</span><span class="n">ns_reac_ind</span><span class="p">]</span> <span class="k">if</span> <span class="n">ns_reac_ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">ns_prod_ind</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">prod</span><span class="p">[:])</span>
                            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ns_prod_nu</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">prod_nu</span><span class="p">[</span><span class="n">ns_prod_ind</span><span class="p">]</span> <span class="k">if</span> <span class="n">ns_prod_ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">ns_reac_nu</span> <span class="ow">or</span> <span class="n">ns_prod_nu</span><span class="p">:</span>
            <span class="n">reac_has_ns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_rxn</span><span class="p">)</span>
            <span class="n">ns_nu</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ns_prod_nu</span><span class="p">,</span> <span class="n">ns_reac_nu</span><span class="p">])</span>

    <span class="c1"># create numpy versions</span>
    <span class="n">reac_has_ns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reac_has_ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
    <span class="n">net_nu_integer</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">is_integer</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span> <span class="k">for</span> <span class="n">nu</span> <span class="ow">in</span> <span class="n">net_nu</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">net_nu_integer</span><span class="p">:</span>
        <span class="n">nu_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nu_sum</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
        <span class="n">net_nu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">net_nu</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
        <span class="n">ns_nu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ns_nu</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nu_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nu_sum</span><span class="p">)</span>
        <span class="n">net_nu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">net_nu</span><span class="p">)</span>
        <span class="n">ns_nu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ns_nu</span><span class="p">)</span>
    <span class="n">net_num_spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">net_num_spec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
    <span class="n">net_spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">net_spec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>

    <span class="c1"># sometimes we need the net properties forumlated per species rather than</span>
    <span class="c1"># per reaction as above</span>
    <span class="n">spec_to_reac</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spec_nu</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spec_reac_count</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spec_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ispec</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
        <span class="c1"># first, find all non-zero nu reactions</span>
        <span class="n">reac_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">irxn</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_nu</span><span class="p">(</span><span class="n">ispec</span><span class="p">,</span> <span class="n">rxn</span><span class="p">))</span>
                                 <span class="k">for</span> <span class="n">irxn</span><span class="p">,</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reacs</span><span class="p">)]</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">reac_list</span><span class="p">:</span>
            <span class="n">reac_list</span><span class="p">,</span> <span class="n">nu_list</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">reac_list</span><span class="p">)</span>
            <span class="n">spec_to_reac</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">reac_list</span><span class="p">)</span>
            <span class="n">spec_nu</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nu_list</span><span class="p">)</span>
            <span class="n">spec_reac_count</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reac_list</span><span class="p">))</span>
            <span class="n">spec_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ispec</span><span class="p">)</span>

    <span class="n">spec_to_reac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spec_to_reac</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">net_nu_integer</span><span class="p">:</span>
        <span class="n">spec_nu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spec_nu</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spec_nu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spec_nu</span><span class="p">)</span>
    <span class="n">spec_reac_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spec_reac_count</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
    <span class="n">spec_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spec_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__seperate</span><span class="p">(</span><span class="n">reacs</span><span class="p">,</span> <span class="n">matchers</span><span class="p">):</span>
        <span class="c1"># find all reactions / indicies that match this offset</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reacs</span><span class="p">)</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span>
                                                           <span class="n">matchers</span><span class="p">)]</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">rate</span><span class="p">:</span>
            <span class="n">mapping</span><span class="p">,</span> <span class="n">rate</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">rate</span><span class="p">)</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>
            <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rate</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">num</span>

    <span class="c1"># count / seperate reactions with simple arrhenius rates</span>
    <span class="n">simple_rate</span><span class="p">,</span> <span class="n">simple_map</span><span class="p">,</span> <span class="n">num_simple</span> <span class="o">=</span> <span class="n">__seperate</span><span class="p">(</span>
        <span class="n">reacs</span><span class="p">,</span> <span class="p">[</span><span class="n">reaction_type</span><span class="o">.</span><span class="n">elementary</span><span class="p">,</span> <span class="n">reaction_type</span><span class="o">.</span><span class="n">thd</span><span class="p">,</span>
                <span class="n">reaction_type</span><span class="o">.</span><span class="n">fall</span><span class="p">,</span> <span class="n">reaction_type</span><span class="o">.</span><span class="n">chem</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__specialize</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="n">fall</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">fall_types</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rates</span><span class="p">)</span>
        <span class="n">rate_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fall</span><span class="p">:</span>
            <span class="n">fall_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
        <span class="c1"># reaction parameters</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">Ta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">reac</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rates</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">reac</span><span class="o">.</span><span class="n">high</span> <span class="ow">or</span> <span class="n">reac</span><span class="o">.</span><span class="n">low</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fall</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">reac</span><span class="o">.</span><span class="n">high</span><span class="p">:</span>
                    <span class="n">Ai</span><span class="p">,</span> <span class="n">bi</span><span class="p">,</span> <span class="n">Tai</span> <span class="o">=</span> <span class="n">reac</span><span class="o">.</span><span class="n">high</span>
                    <span class="c1"># mark as chemically activated</span>
                    <span class="n">fall_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">reaction_type</span><span class="o">.</span><span class="n">chem</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># we want k0, hence default factor is fine</span>
                    <span class="n">Ai</span><span class="p">,</span> <span class="n">bi</span><span class="p">,</span> <span class="n">Tai</span> <span class="o">=</span> <span class="n">reac</span><span class="o">.</span><span class="n">low</span>
                    <span class="n">fall_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">reaction_type</span><span class="o">.</span><span class="n">fall</span><span class="p">)</span>  <span class="c1"># mark as falloff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># assign rate params</span>
                <span class="n">Ai</span><span class="p">,</span> <span class="n">bi</span><span class="p">,</span> <span class="n">Tai</span> <span class="o">=</span> <span class="n">reac</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">reac</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">reac</span><span class="o">.</span><span class="n">E</span>
            <span class="c1"># generic assign</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Ai</span><span class="p">)</span>
            <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bi</span>
            <span class="n">Ta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tai</span>

            <span class="k">if</span> <span class="n">fixed</span><span class="p">:</span>
                <span class="n">rate_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>
            <span class="c1"># assign rate types</span>
            <span class="k">if</span> <span class="n">bi</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">Tai</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ai</span>
                <span class="n">rate_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">bi</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">bi</span><span class="p">)</span> <span class="ow">and</span> <span class="n">bi</span> <span class="ow">and</span> <span class="n">Tai</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ai</span>
                <span class="n">rate_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">Tai</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">bi</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rate_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="n">bi</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">Tai</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rate_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rate_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">full</span><span class="p">:</span>
                <span class="n">rate_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">rate_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">2</span>

        <span class="c1"># subtract off the falloff type to make this a simple 0/1 comparison</span>
        <span class="k">if</span> <span class="n">fall</span><span class="p">:</span>
            <span class="n">fall_types</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="n">reaction_type</span><span class="o">.</span><span class="n">fall</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rate_type</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ta</span><span class="p">,</span> <span class="n">fall_types</span>

    <span class="n">simple_rate_type</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Ta</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">__specialize</span><span class="p">(</span><span class="n">simple_rate</span><span class="p">)</span>

    <span class="c1"># finally determine the advanced rate evaulation types</span>
    <span class="n">plog_reacs</span><span class="p">,</span> <span class="n">plog_map</span><span class="p">,</span> <span class="n">num_plog</span> <span class="o">=</span> <span class="n">__seperate</span><span class="p">(</span>
        <span class="n">reacs</span><span class="p">,</span> <span class="p">[</span><span class="n">reaction_type</span><span class="o">.</span><span class="n">plog</span><span class="p">])</span>

    <span class="c1"># create the plog arrays</span>
    <span class="n">num_pressures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">plog_params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plog_reacs</span><span class="p">:</span>
        <span class="n">num_pressures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">plog_par</span><span class="p">))</span>
        <span class="n">plog_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">plog_par</span><span class="p">)</span>
    <span class="n">num_pressures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">num_pressures</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>

    <span class="n">cheb_reacs</span><span class="p">,</span> <span class="n">cheb_map</span><span class="p">,</span> <span class="n">num_cheb</span> <span class="o">=</span> <span class="n">__seperate</span><span class="p">(</span>
        <span class="n">reacs</span><span class="p">,</span> <span class="p">[</span><span class="n">reaction_type</span><span class="o">.</span><span class="n">cheb</span><span class="p">])</span>

    <span class="c1"># create the chebyshev arrays</span>
    <span class="n">cheb_n_pres</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cheb_n_temp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cheb_plim</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cheb_tlim</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cheb_coeff</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cheb</span> <span class="ow">in</span> <span class="n">cheb_reacs</span><span class="p">:</span>
        <span class="n">cheb_n_pres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cheb</span><span class="o">.</span><span class="n">cheb_n_pres</span><span class="p">)</span>
        <span class="n">cheb_n_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cheb</span><span class="o">.</span><span class="n">cheb_n_temp</span><span class="p">)</span>
        <span class="n">cheb_coeff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cheb</span><span class="o">.</span><span class="n">cheb_par</span><span class="p">)</span>
        <span class="n">cheb_plim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cheb</span><span class="o">.</span><span class="n">cheb_plim</span><span class="p">)</span>
        <span class="n">cheb_tlim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cheb</span><span class="o">.</span><span class="n">cheb_tlim</span><span class="p">)</span>
    <span class="n">cheb_n_pres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cheb_n_pres</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
    <span class="n">cheb_n_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cheb_n_temp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
    <span class="n">cheb_plim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cheb_plim</span><span class="p">)</span>
    <span class="n">cheb_tlim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cheb_tlim</span><span class="p">)</span>
    <span class="n">cheb_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cheb_coeff</span><span class="p">)</span>

    <span class="c1"># find falloff types</span>
    <span class="n">fall_reacs</span><span class="p">,</span> <span class="n">fall_map</span><span class="p">,</span> <span class="n">num_fall</span> <span class="o">=</span> <span class="n">__seperate</span><span class="p">(</span>
        <span class="n">reacs</span><span class="p">,</span> <span class="p">[</span><span class="n">reaction_type</span><span class="o">.</span><span class="n">fall</span><span class="p">,</span> <span class="n">reaction_type</span><span class="o">.</span><span class="n">chem</span><span class="p">])</span>
    <span class="n">fall_rate_type</span><span class="p">,</span> <span class="n">fall_A</span><span class="p">,</span> <span class="n">fall_b</span><span class="p">,</span> <span class="n">fall_Ta</span><span class="p">,</span> <span class="n">fall_types</span> <span class="o">=</span> <span class="n">__specialize</span><span class="p">(</span>
        <span class="n">fall_reacs</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="c1"># find blending type</span>
    <span class="n">blend_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">next</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">type</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">falloff_form</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fall_reacs</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
    <span class="c1"># seperate parameters based on blending type</span>
    <span class="c1"># lindeman</span>
    <span class="n">lind_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">blend_type</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">falloff_form</span><span class="o">.</span><span class="n">lind</span><span class="p">))[</span>
        <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
    <span class="c1"># sri</span>
    <span class="n">sri_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">blend_type</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">falloff_form</span><span class="o">.</span><span class="n">sri</span><span class="p">))[</span>
        <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
    <span class="n">sri_reacs</span> <span class="o">=</span> <span class="p">[</span><span class="n">reacs</span><span class="p">[</span><span class="n">fall_map</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sri_map</span><span class="p">]</span>
    <span class="n">sri_par</span> <span class="o">=</span> <span class="p">[</span><span class="n">reac</span><span class="o">.</span><span class="n">sri_par</span> <span class="k">for</span> <span class="n">reac</span> <span class="ow">in</span> <span class="n">sri_reacs</span><span class="p">]</span>
    <span class="c1"># now fill in defaults as needed</span>
    <span class="k">for</span> <span class="n">par_set</span> <span class="ow">in</span> <span class="n">sri_par</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_set</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">par_set</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sri_par</span><span class="p">):</span>
        <span class="n">sri_a</span><span class="p">,</span> <span class="n">sri_b</span><span class="p">,</span> <span class="n">sri_c</span><span class="p">,</span> <span class="n">sri_d</span><span class="p">,</span> <span class="n">sri_e</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">sri_par</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sri_a</span><span class="p">,</span> <span class="n">sri_b</span><span class="p">,</span> <span class="n">sri_c</span><span class="p">,</span> <span class="n">sri_d</span><span class="p">,</span> <span class="n">sri_e</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
    <span class="c1"># and troe</span>
    <span class="n">troe_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">blend_type</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">falloff_form</span><span class="o">.</span><span class="n">troe</span><span class="p">))[</span>
        <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
    <span class="n">troe_reacs</span> <span class="o">=</span> <span class="p">[</span><span class="n">reacs</span><span class="p">[</span><span class="n">fall_map</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">troe_map</span><span class="p">]</span>
    <span class="n">troe_par</span> <span class="o">=</span> <span class="p">[</span><span class="n">reac</span><span class="o">.</span><span class="n">troe_par</span> <span class="k">for</span> <span class="n">reac</span> <span class="ow">in</span> <span class="n">troe_reacs</span><span class="p">]</span>
    <span class="c1"># now fill in defaults as needed</span>
    <span class="k">for</span> <span class="n">par_set</span> <span class="ow">in</span> <span class="n">troe_par</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_set</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">par_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">troe_a</span><span class="p">,</span> <span class="n">troe_T3</span><span class="p">,</span> <span class="n">troe_T1</span><span class="p">,</span> <span class="n">troe_T2</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">troe_par</span><span class="p">)]</span>
        <span class="c1"># and invert</span>
        <span class="n">troe_T1</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">troe_T1</span>
        <span class="n">troe_T3</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">troe_T3</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">troe_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">troe_T3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">troe_T1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">troe_T2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># find third-body types</span>
    <span class="n">thd_reacs</span><span class="p">,</span> <span class="n">thd_map</span><span class="p">,</span> <span class="n">num_thd</span> <span class="o">=</span> <span class="n">__seperate</span><span class="p">(</span>
        <span class="n">reacs</span><span class="p">,</span> <span class="p">[</span><span class="n">reaction_type</span><span class="o">.</span><span class="n">fall</span><span class="p">,</span> <span class="n">reaction_type</span><span class="o">.</span><span class="n">chem</span><span class="p">,</span> <span class="n">reaction_type</span><span class="o">.</span><span class="n">thd</span><span class="p">])</span>
    <span class="c1"># find third body type</span>
    <span class="n">thd_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">next</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">type</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">thd_body_type</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">thd_reacs</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>

    <span class="c1"># first, we must do some surgery to get _our_ form of the thd-body</span>
    <span class="c1"># efficiencies</span>
    <span class="n">last_spec</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">thd_spec_num</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">thd_spec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">thd_eff</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">thd_has_ns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">thd_ns_eff</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">thd_reacs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">thd_body_type</span><span class="o">.</span><span class="n">species</span><span class="p">):</span>
            <span class="n">thd_spec_num</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">thd_spec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">pdep_sp</span><span class="p">)</span>
            <span class="n">thd_eff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">pdep_sp</span> <span class="o">==</span> <span class="n">last_spec</span><span class="p">:</span>
                <span class="n">thd_has_ns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">thd_ns_eff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">thd_body_type</span><span class="o">.</span><span class="n">unity</span><span class="p">):</span>
            <span class="n">thd_spec_num</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thd_spec_num</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">thd_body_eff</span><span class="p">))</span>
            <span class="n">spec</span><span class="p">,</span> <span class="n">eff</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">thd_body_eff</span><span class="p">)</span>
            <span class="n">thd_spec</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">thd_eff</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">eff</span><span class="p">)</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">ind</span> <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">last_spec</span><span class="p">),</span>
                       <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">thd_has_ns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">thd_ns_eff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eff</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>

    <span class="n">thd_spec_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thd_spec_num</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
    <span class="n">thd_spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thd_spec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
    <span class="n">thd_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thd_eff</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">thd_has_ns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thd_has_ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">arc</span><span class="o">.</span><span class="n">kint_type</span><span class="p">)</span>
    <span class="n">thd_ns_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thd_ns_eff</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1"># thermo properties</span>
    <span class="n">poly_dim</span> <span class="o">=</span> <span class="n">specs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hi</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>

    <span class="c1"># pick out a values and T_mid</span>
    <span class="n">a_lo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ns</span><span class="p">,</span> <span class="n">poly_dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">a_hi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ns</span><span class="p">,</span> <span class="n">poly_dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">T_mid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ns</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
        <span class="n">a_lo</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">lo</span><span class="p">[:]</span>
        <span class="n">a_hi</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">hi</span><span class="p">[:]</span>
        <span class="n">T_mid</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">Trange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># post processing</span>

    <span class="c1"># chebyshev parameter reordering</span>
    <span class="n">pp_cheb_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pp_cheb_plim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pp_cheb_tlim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_cheb</span><span class="p">:</span>
        <span class="n">pp_cheb_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_cheb</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cheb_n_temp</span><span class="p">)),</span>
                                  <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cheb_n_pres</span><span class="p">))))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cheb_coeff</span><span class="p">):</span>
            <span class="n">pp_cheb_coeff</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">cheb_n_temp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">:</span><span class="n">cheb_n_pres</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="p">:]</span>

        <span class="c1"># limits for cheby polys</span>
        <span class="n">pp_cheb_plim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cheb_plim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
        <span class="n">pp_cheb_tlim</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cheb_tlim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1"># plog parameter reorder</span>
    <span class="n">pp_plog_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">maxP</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">num_plog</span><span class="p">:</span>
        <span class="c1"># max # of parameters for sizing</span>
        <span class="n">maxP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">num_pressures</span><span class="p">)</span>
        <span class="c1"># for simplicity, we&#39;re going to use a padded form</span>
        <span class="n">pp_plog_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_plog</span><span class="p">,</span> <span class="n">maxP</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">numP</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">num_pressures</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numP</span><span class="p">):</span>
                    <span class="n">pp_plog_params</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">plog_params</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>

        <span class="c1"># take the log of P and A</span>
        <span class="n">hold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">pp_plog_params</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pp_plog_params</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
        <span class="n">pp_plog_params</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pp_plog_params</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
        <span class="n">pp_plog_params</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">pp_plog_params</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="o">**</span><span class="n">hold</span><span class="p">)</span>

    <span class="c1"># molecular weights</span>
    <span class="n">mws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">spec</span><span class="o">.</span><span class="n">mw</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">])</span>
    <span class="n">mw_post</span> <span class="o">=</span> <span class="n">mws</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">mws</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;simple&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">A</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span> <span class="s1">&#39;Ta&#39;</span><span class="p">:</span> <span class="n">Ta</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">simple_rate_type</span><span class="p">,</span>
                       <span class="s1">&#39;num&#39;</span><span class="p">:</span> <span class="n">num_simple</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">:</span> <span class="n">simple_map</span><span class="p">},</span>
            <span class="s1">&#39;plog&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;map&#39;</span><span class="p">:</span> <span class="n">plog_map</span><span class="p">,</span> <span class="s1">&#39;num&#39;</span><span class="p">:</span> <span class="n">num_plog</span><span class="p">,</span>
                     <span class="s1">&#39;num_P&#39;</span><span class="p">:</span> <span class="n">num_pressures</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">plog_params</span><span class="p">,</span>
                     <span class="s1">&#39;max_P&#39;</span><span class="p">:</span> <span class="n">maxP</span><span class="p">,</span>
                     <span class="s1">&#39;post_process&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">pp_plog_params</span><span class="p">},</span>
                     <span class="p">},</span>
            <span class="s1">&#39;cheb&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;map&#39;</span><span class="p">:</span> <span class="n">cheb_map</span><span class="p">,</span> <span class="s1">&#39;num&#39;</span><span class="p">:</span> <span class="n">num_cheb</span><span class="p">,</span>
                     <span class="s1">&#39;num_P&#39;</span><span class="p">:</span> <span class="n">cheb_n_pres</span><span class="p">,</span> <span class="s1">&#39;num_T&#39;</span><span class="p">:</span> <span class="n">cheb_n_temp</span><span class="p">,</span>
                     <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">cheb_coeff</span><span class="p">,</span> <span class="s1">&#39;Tlim&#39;</span><span class="p">:</span> <span class="n">cheb_tlim</span><span class="p">,</span>
                     <span class="s1">&#39;Plim&#39;</span><span class="p">:</span> <span class="n">cheb_plim</span><span class="p">,</span>
                     <span class="s1">&#39;post_process&#39;</span><span class="p">:</span> <span class="p">{</span>
                         <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">pp_cheb_coeff</span><span class="p">,</span>
                         <span class="s1">&#39;Plim&#39;</span><span class="p">:</span> <span class="n">pp_cheb_plim</span><span class="p">,</span>
                         <span class="s1">&#39;Tlim&#39;</span><span class="p">:</span> <span class="n">pp_cheb_tlim</span>
                     <span class="p">}},</span>
            <span class="s1">&#39;fall&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;map&#39;</span><span class="p">:</span> <span class="n">fall_map</span><span class="p">,</span> <span class="s1">&#39;num&#39;</span><span class="p">:</span> <span class="n">num_fall</span><span class="p">,</span>
                     <span class="s1">&#39;ftype&#39;</span><span class="p">:</span> <span class="n">fall_types</span><span class="p">,</span> <span class="s1">&#39;blend&#39;</span><span class="p">:</span> <span class="n">blend_type</span><span class="p">,</span>
                     <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">fall_A</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">fall_b</span><span class="p">,</span> <span class="s1">&#39;Ta&#39;</span><span class="p">:</span> <span class="n">fall_Ta</span><span class="p">,</span>
                     <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">fall_rate_type</span><span class="p">,</span>
                     <span class="s1">&#39;sri&#39;</span><span class="p">:</span>
                     <span class="p">{</span><span class="s1">&#39;map&#39;</span><span class="p">:</span> <span class="n">sri_map</span><span class="p">,</span>
                         <span class="s1">&#39;num&#39;</span><span class="p">:</span> <span class="n">sri_map</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                         <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">sri_a</span><span class="p">,</span>
                         <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">sri_b</span><span class="p">,</span>
                         <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">sri_c</span><span class="p">,</span>
                         <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="n">sri_d</span><span class="p">,</span>
                         <span class="s1">&#39;e&#39;</span><span class="p">:</span> <span class="n">sri_e</span>
                      <span class="p">},</span>
                     <span class="s1">&#39;troe&#39;</span><span class="p">:</span>
                     <span class="p">{</span><span class="s1">&#39;map&#39;</span><span class="p">:</span> <span class="n">troe_map</span><span class="p">,</span>
                         <span class="s1">&#39;num&#39;</span><span class="p">:</span> <span class="n">troe_map</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                         <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">troe_a</span><span class="p">,</span>
                         <span class="s1">&#39;T3&#39;</span><span class="p">:</span> <span class="n">troe_T3</span><span class="p">,</span>
                         <span class="s1">&#39;T1&#39;</span><span class="p">:</span> <span class="n">troe_T1</span><span class="p">,</span>
                         <span class="s1">&#39;T2&#39;</span><span class="p">:</span> <span class="n">troe_T2</span>
                      <span class="p">},</span>
                     <span class="s1">&#39;lind&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;map&#39;</span><span class="p">:</span> <span class="n">lind_map</span><span class="p">,</span>
                              <span class="s1">&#39;num&#39;</span><span class="p">:</span> <span class="n">lind_map</span><span class="o">.</span><span class="n">size</span><span class="p">}</span>
                     <span class="p">},</span>
            <span class="s1">&#39;thd&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;map&#39;</span><span class="p">:</span> <span class="n">thd_map</span><span class="p">,</span> <span class="s1">&#39;num&#39;</span><span class="p">:</span> <span class="n">num_thd</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">thd_type</span><span class="p">,</span> <span class="s1">&#39;spec_num&#39;</span><span class="p">:</span> <span class="n">thd_spec_num</span><span class="p">,</span>
                    <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="n">thd_spec</span><span class="p">,</span> <span class="s1">&#39;eff&#39;</span><span class="p">:</span> <span class="n">thd_eff</span><span class="p">,</span>
                    <span class="s1">&#39;has_ns&#39;</span><span class="p">:</span> <span class="n">thd_has_ns</span><span class="p">,</span> <span class="s1">&#39;eff_ns&#39;</span><span class="p">:</span> <span class="n">thd_ns_eff</span><span class="p">},</span>
            <span class="s1">&#39;fwd&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;map&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">)),</span> <span class="s1">&#39;num&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">)},</span>
            <span class="s1">&#39;rev&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;map&#39;</span><span class="p">:</span> <span class="n">rev_map</span><span class="p">,</span> <span class="s1">&#39;num&#39;</span><span class="p">:</span> <span class="n">num_rev</span><span class="p">},</span>
            <span class="s1">&#39;net&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;num_reac_to_spec&#39;</span><span class="p">:</span> <span class="n">net_num_spec</span><span class="p">,</span> <span class="s1">&#39;nu_sum&#39;</span><span class="p">:</span> <span class="n">nu_sum</span><span class="p">,</span>
                    <span class="s1">&#39;nu&#39;</span><span class="p">:</span> <span class="n">net_nu</span><span class="p">,</span> <span class="s1">&#39;reac_to_spec&#39;</span><span class="p">:</span> <span class="n">net_spec</span><span class="p">,</span>
                    <span class="s1">&#39;allint&#39;</span><span class="p">:</span> <span class="n">net_nu_integer</span><span class="p">},</span>
            <span class="s1">&#39;net_per_spec&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;reac_count&#39;</span><span class="p">:</span> <span class="n">spec_reac_count</span><span class="p">,</span> <span class="s1">&#39;nu&#39;</span><span class="p">:</span> <span class="n">spec_nu</span><span class="p">,</span>
                             <span class="s1">&#39;reacs&#39;</span><span class="p">:</span> <span class="n">spec_to_reac</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">:</span> <span class="n">spec_list</span><span class="p">,</span>
                             <span class="s1">&#39;allint&#39;</span><span class="p">:</span> <span class="n">net_nu_integer</span><span class="p">},</span>
            <span class="s1">&#39;Nr&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">reacs</span><span class="p">),</span>
            <span class="s1">&#39;Ns&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">specs</span><span class="p">),</span>
            <span class="s1">&#39;thermo&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;a_lo&#39;</span><span class="p">:</span> <span class="n">a_lo</span><span class="p">,</span>
                <span class="s1">&#39;a_hi&#39;</span><span class="p">:</span> <span class="n">a_hi</span><span class="p">,</span>
                <span class="s1">&#39;T_mid&#39;</span><span class="p">:</span> <span class="n">T_mid</span>
    <span class="p">},</span>
        <span class="s1">&#39;mws&#39;</span><span class="p">:</span> <span class="n">mws</span><span class="p">,</span>
        <span class="s1">&#39;mw_post&#39;</span><span class="p">:</span> <span class="n">mw_post</span><span class="p">,</span>
        <span class="s1">&#39;reac_has_ns&#39;</span><span class="p">:</span> <span class="n">reac_has_ns</span><span class="p">,</span>
        <span class="s1">&#39;ns_nu&#39;</span><span class="p">:</span> <span class="n">ns_nu</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="reset_arrays"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.reset_arrays">[docs]</a><span class="k">def</span> <span class="nf">reset_arrays</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Resets the dphi and wdot arrays for use in the rate evaluations</span>

<span class="sd">    kernel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not none, this kernel is being used for testing.</span>
<span class="sd">        Hence we need to size the arrays accordingly</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl_list : list of :class:`knl_info`</span>
<span class="sd">        The generated infos for feeding into the kernel generator for both</span>
<span class="sd">        equation types</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__create</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">nrange</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># create reset kernel</span>
        <span class="n">mapstore</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">nrange</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>

        <span class="c1"># first, create all arrays</span>
        <span class="n">kernel_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># add problem size</span>
        <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span>
            <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

        <span class="c1"># need arrays</span>
        <span class="n">arr_lp</span><span class="p">,</span> <span class="n">arr_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>
        <span class="n">kernel_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr_lp</span><span class="p">)</span>
        <span class="n">instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                ${arr_str} = 0d {id=set}</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>

        <span class="c1"># currently both reset arrays are atomic (if used)</span>
        <span class="n">can_vectorize</span><span class="p">,</span> <span class="n">vec_spec</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">get_deep_specializer</span><span class="p">(</span>
            <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">init_ids</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                              <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
                              <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                              <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                              <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">,</span>
                              <span class="n">can_vectorize</span><span class="o">=</span><span class="n">can_vectorize</span><span class="p">,</span>
                              <span class="n">vectorization_specializer</span><span class="o">=</span><span class="n">vec_spec</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">__create</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">n_dot</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">phi_inds</span><span class="p">,</span> <span class="s1">&#39;ndot_reset&#39;</span><span class="p">),</span>
            <span class="n">__create</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">spec_rates</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_specs</span><span class="p">,</span> <span class="s1">&#39;wdot_reset&#39;</span><span class="p">)]</span></div>


<div class="viewcode-block" id="get_concentrations"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.get_concentrations">[docs]</a><span class="k">def</span> <span class="nf">get_concentrations</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">conp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determines concentrations from moles and state variables depending</span>
<span class="sd">    on constant pressure vs constant volue assumption</span>

<span class="sd">    kernel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    conp : bool</span>
<span class="sd">        If true, generate equations using constant pressure assumption</span>
<span class="sd">        If false, use constant volume equations</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not none, this kernel is being used for testing.</span>
<span class="sd">        Hence we need to size the arrays accordingly</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl_list : list of :class:`knl_info`</span>
<span class="sd">        The generated infos for feeding into the kernel generator for both</span>
<span class="sd">        equation types</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mapstore</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_specs_no_ns</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>

    <span class="n">fixed_inds</span> <span class="o">=</span> <span class="p">(</span><span class="n">global_ind</span><span class="p">,)</span>

    <span class="c1"># first, create all arrays</span>
    <span class="n">kernel_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># add problem size</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># need P, V, T and n arrays</span>

    <span class="c1"># add / apply maps</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">n_arr</span><span class="p">,</span>
                                     <span class="n">namestore</span><span class="o">.</span><span class="n">phi_spec_inds</span><span class="p">,</span>
                                     <span class="n">force_inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">conc_arr</span><span class="p">,</span>
                                     <span class="n">namestore</span><span class="o">.</span><span class="n">num_specs_no_ns</span><span class="p">,</span>
                                     <span class="n">force_inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">conc_ns_arr</span><span class="p">,</span>
                                     <span class="n">namestore</span><span class="o">.</span><span class="n">num_specs_no_ns</span><span class="p">,</span>
                                     <span class="n">force_inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">n_arr</span><span class="p">,</span> <span class="n">n_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">n_arr</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>
    <span class="n">P_arr</span><span class="p">,</span> <span class="n">P_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">P_arr</span><span class="p">,</span> <span class="o">*</span><span class="n">fixed_inds</span><span class="p">)</span>
    <span class="n">V_arr</span><span class="p">,</span> <span class="n">V_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">V_arr</span><span class="p">,</span> <span class="o">*</span><span class="n">fixed_inds</span><span class="p">)</span>
    <span class="n">T_arr</span><span class="p">,</span> <span class="n">T_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">T_arr</span><span class="p">,</span> <span class="o">*</span><span class="n">fixed_inds</span><span class="p">)</span>
    <span class="n">conc_arr</span><span class="p">,</span> <span class="n">conc_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">conc_arr</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">conc_ns_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">conc_ns_arr</span><span class="p">,</span> <span class="o">*</span><span class="n">fixed_inds</span><span class="p">)</span>

    <span class="c1"># add arrays</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">n_arr</span><span class="p">,</span> <span class="n">P_arr</span><span class="p">,</span> <span class="n">V_arr</span><span class="p">,</span> <span class="n">T_arr</span><span class="p">,</span> <span class="n">conc_arr</span><span class="p">])</span>

    <span class="n">pre_instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;&lt;&gt;V_inv = 1.0d / ${V_str}</span>
<span class="sd">           &lt;&gt;n_sum = 0 {id=n_init}</span>
<span class="sd">           ${cns_str} = ${P_str} / (R_u * ${T_str}) {id=cns_init}</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
            <span class="n">P_str</span><span class="o">=</span><span class="n">P_str</span><span class="p">,</span>
            <span class="n">V_str</span><span class="o">=</span><span class="n">V_str</span><span class="p">,</span>
            <span class="n">T_str</span><span class="o">=</span><span class="n">T_str</span><span class="p">,</span>
            <span class="n">cns_str</span><span class="o">=</span><span class="n">conc_ns_str</span><span class="p">)</span>

    <span class="n">instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            ${conc_str} = ${n_str} * V_inv {id=cn_init}</span>
<span class="sd">            n_sum = n_sum + ${n_str} {id=n_update, dep=n_init}</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
            <span class="n">conc_str</span><span class="o">=</span><span class="n">conc_str</span><span class="p">,</span>
            <span class="n">n_str</span><span class="o">=</span><span class="n">n_str</span>
    <span class="p">)</span>

    <span class="n">barrier</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">get_barrier</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;break&#39;</span><span class="p">,</span> <span class="n">dep</span><span class="o">=</span><span class="s1">&#39;cns_init&#39;</span><span class="p">)</span>
    <span class="n">post_instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ${barrier}</span>
<span class="sd">        ${conc_ns_str} = ${conc_ns_str} - n_sum * V_inv {id=cns_set,\</span>
<span class="sd">            dep=n_update:break, nosync=cns_init}</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>

    <span class="n">can_vectorize</span><span class="p">,</span> <span class="n">vec_spec</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">get_deep_specializer</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">atomic_ids</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cns_set&#39;</span><span class="p">],</span>
        <span class="n">init_ids</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cns_init&#39;</span><span class="p">,</span> <span class="s1">&#39;cn_init&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;get_concentrations&#39;</span><span class="p">,</span>
                          <span class="n">pre_instructions</span><span class="o">=</span><span class="p">[</span><span class="n">pre_instructions</span><span class="p">],</span>
                          <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
                          <span class="n">post_instructions</span><span class="o">=</span><span class="p">[</span><span class="n">post_instructions</span><span class="p">],</span>
                          <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                          <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                          <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">,</span>
                          <span class="n">can_vectorize</span><span class="o">=</span><span class="n">can_vectorize</span><span class="p">,</span>
                          <span class="n">vectorization_specializer</span><span class="o">=</span><span class="n">vec_spec</span><span class="p">,</span>
                          <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;R_u&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span><span class="p">)})</span></div>


<div class="viewcode-block" id="get_molar_rates"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.get_molar_rates">[docs]</a><span class="k">def</span> <span class="nf">get_molar_rates</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">conp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates instructions, kernel arguements, and data for the</span>
<span class="sd">       molar derivatives</span>
<span class="sd">    kernel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    conp : bool</span>
<span class="sd">        If true, generate equations using constant pressure assumption</span>
<span class="sd">        If false, use constant volume equations</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not none, this kernel is being used for testing.</span>
<span class="sd">        Hence we need to size the arrays accordingly</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl_list : list of :class:`knl_info`</span>
<span class="sd">        The generated infos for feeding into the kernel generator for both</span>
<span class="sd">        equation types</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mapstore</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_specs_no_ns</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>

    <span class="c1"># first, create all arrays</span>
    <span class="n">kernel_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># add problem size</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="n">fixed_inds</span> <span class="o">=</span> <span class="p">(</span><span class="n">global_ind</span><span class="p">,)</span>

    <span class="c1"># wdot, dphi, V</span>

    <span class="c1"># add / apply maps</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">n_dot</span><span class="p">,</span>
                                     <span class="n">namestore</span><span class="o">.</span><span class="n">phi_spec_inds</span><span class="p">)</span>

    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">spec_rates</span><span class="p">,</span>
                                     <span class="n">namestore</span><span class="o">.</span><span class="n">num_specs_no_ns</span><span class="p">)</span>

    <span class="n">wdot_lp</span><span class="p">,</span> <span class="n">wdot_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">spec_rates</span><span class="p">,</span>
                                            <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="n">ndot_lp</span><span class="p">,</span> <span class="n">ndot_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">n_dot</span><span class="p">,</span>
                                            <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="n">V_lp</span><span class="p">,</span> <span class="n">V_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">V_arr</span><span class="p">,</span>
                                      <span class="o">*</span><span class="n">fixed_inds</span><span class="p">)</span>

    <span class="n">V_val</span> <span class="o">=</span> <span class="s1">&#39;V_val&#39;</span>
    <span class="c1"># create a precomputed instruction generator</span>
    <span class="n">precompute</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">PrecomputedInstructions</span><span class="p">()</span>

    <span class="n">pre_instructions</span> <span class="o">=</span> <span class="n">precompute</span><span class="p">(</span><span class="n">V_val</span><span class="p">,</span> <span class="n">V_str</span><span class="p">,</span> <span class="s1">&#39;VAL&#39;</span><span class="p">)</span>

    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">V_lp</span><span class="p">,</span> <span class="n">ndot_lp</span><span class="p">,</span> <span class="n">wdot_lp</span><span class="p">])</span>

    <span class="n">instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ${ndot_str} = ${V_val} * ${wdot_str} {id=set}</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
        <span class="n">ndot_str</span><span class="o">=</span><span class="n">ndot_str</span><span class="p">,</span>
        <span class="n">V_val</span><span class="o">=</span><span class="n">V_val</span><span class="p">,</span>
        <span class="n">wdot_str</span><span class="o">=</span><span class="n">wdot_str</span>
    <span class="p">)</span>

    <span class="n">vec_spec</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">can_vectorize</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">ic</span><span class="o">.</span><span class="n">use_atomics</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">):</span>
        <span class="n">can_vectorize</span><span class="p">,</span> <span class="n">vec_spec</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">get_deep_specializer</span><span class="p">(</span>
            <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">init_ids</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;get_molar_rates&#39;</span><span class="p">,</span>
                          <span class="n">pre_instructions</span><span class="o">=</span><span class="p">[</span><span class="n">pre_instructions</span><span class="p">],</span>
                          <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
                          <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                          <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                          <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">,</span>
                          <span class="n">can_vectorize</span><span class="o">=</span><span class="n">can_vectorize</span><span class="p">,</span>
                          <span class="n">vectorization_specializer</span><span class="o">=</span><span class="n">vec_spec</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_extra_var_rates"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.get_extra_var_rates">[docs]</a><span class="k">def</span> <span class="nf">get_extra_var_rates</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">conp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates instructions, kernel arguements, and data for the</span>
<span class="sd">       derivative of the &quot;extra&quot; variable -- P or V depending on conV/conP</span>
<span class="sd">       assumption respectively</span>
<span class="sd">    kernel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    conp : bool</span>
<span class="sd">        If true, generate equations using constant pressure assumption</span>
<span class="sd">        If false, use constant volume equations</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not none, this kernel is being used for testing.</span>
<span class="sd">        Hence we need to size the arrays accordingly</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl_list : list of :class:`knl_info`</span>
<span class="sd">        The generated infos for feeding into the kernel generator for both</span>
<span class="sd">        equation types</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mapstore</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_specs_no_ns</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>

    <span class="c1"># first, create all arrays</span>
    <span class="n">kernel_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># add problem size</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="n">fixed_inds</span> <span class="o">=</span> <span class="p">(</span><span class="n">global_ind</span><span class="p">,)</span>

    <span class="c1"># get arrays</span>

    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">spec_rates</span><span class="p">,</span>
                                     <span class="n">namestore</span><span class="o">.</span><span class="n">num_specs_no_ns</span><span class="p">,</span>
                                     <span class="n">force_inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">mw_post_arr</span><span class="p">,</span>
                                     <span class="n">namestore</span><span class="o">.</span><span class="n">num_specs_no_ns</span><span class="p">,</span>
                                     <span class="n">force_inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">wdot_lp</span><span class="p">,</span> <span class="n">wdot_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">spec_rates</span><span class="p">,</span>
                                            <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="n">Edot_lp</span><span class="p">,</span> <span class="n">Edot_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">E_dot</span><span class="p">,</span>
                                            <span class="o">*</span><span class="n">fixed_inds</span><span class="p">)</span>

    <span class="n">T_lp</span><span class="p">,</span> <span class="n">T_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">T_arr</span><span class="p">,</span> <span class="o">*</span><span class="n">fixed_inds</span><span class="p">)</span>
    <span class="n">P_lp</span><span class="p">,</span> <span class="n">P_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">P_arr</span><span class="p">,</span> <span class="o">*</span><span class="n">fixed_inds</span><span class="p">)</span>
    <span class="n">Tdot_lp</span><span class="p">,</span> <span class="n">Tdot_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">T_dot</span><span class="p">,</span> <span class="o">*</span><span class="n">fixed_inds</span><span class="p">)</span>
    <span class="n">mw_lp</span><span class="p">,</span> <span class="n">mw_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">mw_post_arr</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">var_name</span><span class="p">,))</span>
    <span class="n">V_lp</span><span class="p">,</span> <span class="n">V_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">V_arr</span><span class="p">,</span> <span class="o">*</span><span class="n">fixed_inds</span><span class="p">)</span>

    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">wdot_lp</span><span class="p">,</span> <span class="n">Edot_lp</span><span class="p">,</span> <span class="n">T_lp</span><span class="p">,</span> <span class="n">P_lp</span><span class="p">,</span> <span class="n">Tdot_lp</span><span class="p">,</span> <span class="n">mw_lp</span><span class="p">])</span>

    <span class="n">dE_init</span> <span class="o">=</span> <span class="s1">&#39;&lt;&gt;dE = 0.0d {id=dE_init}&#39;</span>

    <span class="k">if</span> <span class="n">conp</span><span class="p">:</span>
        <span class="n">pre_instructions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Template</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{Edot_str}</span><span class="s1"> = $</span><span class="si">{V_str}</span><span class="s1"> * $</span><span class="si">{Tdot_str}</span><span class="s1"> / $</span><span class="si">{T_str}</span><span class="s1"> </span><span class="se">\</span>
<span class="s1">                     {id=init}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span>
                <span class="o">**</span><span class="nb">locals</span><span class="p">()),</span>
            <span class="n">dE_init</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pre_instructions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Template</span><span class="p">(</span><span class="s1">&#39;$</span><span class="si">{Edot_str}</span><span class="s1"> = $</span><span class="si">{P_str}</span><span class="s1"> * $</span><span class="si">{Tdot_str}</span><span class="s1"> / $</span><span class="si">{T_str}</span><span class="se">\</span>
<span class="s1">                     {id=init}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span>
                <span class="o">**</span><span class="nb">locals</span><span class="p">()),</span>
            <span class="n">dE_init</span>
        <span class="p">]</span>

    <span class="n">instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            dE = dE + (1.0 - ${mw_str}) * ${wdot_str} {id=sum, dep=dE_init}</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">conp</span><span class="p">:</span>
        <span class="n">kernel_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">V_lp</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ic</span><span class="o">.</span><span class="n">use_atomics</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">):</span>
            <span class="c1"># need to fix the post instructions to work atomically</span>
            <span class="n">pre_instructions</span> <span class="o">=</span> <span class="p">[</span><span class="n">dE_init</span><span class="p">]</span>
            <span class="n">post_instructions</span> <span class="o">=</span> <span class="p">[</span><span class="n">Template</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                temp_sum[0] = ${V_str} * ${Tdot_str} / ${T_str} \</span>
<span class="sd">                    {id=temp_init, dep=*, atomic}</span>
<span class="sd">                ... lbarrier {id=lb1, dep=temp_init}</span>
<span class="sd">                temp_sum[0] = temp_sum[0] + \</span>
<span class="sd">                    ${V_str} * dE * ${T_str} * R_u / ${P_str} \</span>
<span class="sd">                    {id=temp_sum, dep=lb1*:sum, nosync=temp_init, atomic}</span>
<span class="sd">                ... lbarrier {id=lb2, dep=temp_sum}</span>
<span class="sd">                ${Edot_str} = temp_sum[0] \</span>
<span class="sd">                    {id=final, dep=lb2, atomic, nosync=temp_init:temp_sum}</span>
<span class="sd">                &quot;&quot;&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())]</span>
            <span class="n">kernel_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lp</span><span class="o">.</span><span class="n">TemporaryVariable</span><span class="p">(</span><span class="s1">&#39;temp_sum&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
                                                    <span class="n">scope</span><span class="o">=</span><span class="n">scopes</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">post_instructions</span> <span class="o">=</span> <span class="p">[</span><span class="n">Template</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                ${Edot_str} = ${Edot_str} + ${V_str} * dE * ${T_str} * R_u / \</span>
<span class="sd">                    ${P_str} {id=end, dep=sum:init, nosync=init}</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
            <span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ic</span><span class="o">.</span><span class="n">use_atomics</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">):</span>
            <span class="c1"># need to fix the post instructions to work atomically</span>
            <span class="n">pre_instructions</span> <span class="o">=</span> <span class="p">[</span><span class="n">dE_init</span><span class="p">]</span>
            <span class="n">post_instructions</span> <span class="o">=</span> <span class="p">[</span><span class="n">Template</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                temp_sum[0] = ${P_str} * ${Tdot_str} / ${T_str} \</span>
<span class="sd">                    {id=temp_init, dep=*, atomic}</span>
<span class="sd">                ... lbarrier {id=lb1, dep=temp_init}</span>
<span class="sd">                temp_sum[0] = temp_sum[0] + ${T_str} * R_u * dE \</span>
<span class="sd">                    {id=temp_sum, dep=lb1*:sum, nosync=temp_init, atomic}</span>
<span class="sd">                ... lbarrier {id=lb2, dep=temp_sum}</span>
<span class="sd">                ${Edot_str} = temp_sum[0] \</span>
<span class="sd">                    {id=final, dep=lb2, atomic, nosync=temp_init:temp_sum}</span>
<span class="sd">                &quot;&quot;&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())]</span>
            <span class="n">kernel_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lp</span><span class="o">.</span><span class="n">TemporaryVariable</span><span class="p">(</span><span class="s1">&#39;temp_sum&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
                                                    <span class="n">scope</span><span class="o">=</span><span class="n">scopes</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">post_instructions</span> <span class="o">=</span> <span class="p">[</span><span class="n">Template</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                ${Edot_str} = ${Edot_str} + ${T_str} * R_u * dE {id=end, \</span>
<span class="sd">                    dep=sum:init, nosync=init}</span>
<span class="sd">                &quot;&quot;&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())]</span>

    <span class="k">if</span> <span class="n">loopy_opts</span><span class="o">.</span><span class="n">depth</span><span class="p">:</span>
        <span class="n">can_vectorize</span><span class="p">,</span> <span class="n">vec_spec</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">get_deep_specializer</span><span class="p">(</span>
            <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">atomic_ids</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;final&#39;</span><span class="p">,</span> <span class="s1">&#39;temp_sum&#39;</span><span class="p">],</span>
            <span class="n">init_ids</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="s1">&#39;temp_init&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">can_vectorize</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">vec_spec</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">write_race_silencer</span><span class="p">([</span><span class="s1">&#39;end&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;get_extra_var_rates&#39;</span><span class="p">,</span>
                          <span class="n">pre_instructions</span><span class="o">=</span><span class="n">pre_instructions</span><span class="p">,</span>
                          <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
                          <span class="n">post_instructions</span><span class="o">=</span><span class="n">post_instructions</span><span class="p">,</span>
                          <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                          <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                          <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">,</span>
                          <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;R_u&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span><span class="p">)},</span>
                          <span class="n">can_vectorize</span><span class="o">=</span><span class="n">can_vectorize</span><span class="p">,</span>
                          <span class="n">vectorization_specializer</span><span class="o">=</span><span class="n">vec_spec</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_temperature_rate"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.get_temperature_rate">[docs]</a><span class="k">def</span> <span class="nf">get_temperature_rate</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">conp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates instructions, kernel arguements, and data for the</span>
<span class="sd">       temperature derivative</span>
<span class="sd">    kernel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    conp : bool</span>
<span class="sd">        If true, generate equations using constant pressure assumption</span>
<span class="sd">        If false, use constant volume equations</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not none, this kernel is being used for testing.</span>
<span class="sd">        Hence we need to size the arrays accordingly</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl_list : list of :class:`knl_info`</span>
<span class="sd">        The generated infos for feeding into the kernel generator for both</span>
<span class="sd">        equation types</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mapstore</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_specs</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>
    <span class="n">fixed_inds</span> <span class="o">=</span> <span class="p">(</span><span class="n">global_ind</span><span class="p">,)</span>

    <span class="c1"># first, create all arrays</span>
    <span class="n">kernel_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># add problem size</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># add / apply maps</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">spec_rates</span><span class="p">,</span>
                                     <span class="n">namestore</span><span class="o">.</span><span class="n">num_specs</span><span class="p">,</span>
                                     <span class="n">force_inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">conc_arr</span><span class="p">,</span>
                                     <span class="n">namestore</span><span class="o">.</span><span class="n">num_specs</span><span class="p">,</span>
                                     <span class="n">force_inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># add all non-mapped arrays</span>
    <span class="k">if</span> <span class="n">conp</span><span class="p">:</span>
        <span class="n">h_lp</span><span class="p">,</span> <span class="n">h_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>
        <span class="n">cp_lp</span><span class="p">,</span> <span class="n">cp_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cp</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>
        <span class="n">energy_str</span> <span class="o">=</span> <span class="n">h_str</span>
        <span class="n">spec_heat_str</span> <span class="o">=</span> <span class="n">cp_str</span>
        <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">h_lp</span><span class="p">,</span> <span class="n">cp_lp</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">u_lp</span><span class="p">,</span> <span class="n">u_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>
        <span class="n">cv_lp</span><span class="p">,</span> <span class="n">cv_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cv</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>
        <span class="n">energy_str</span> <span class="o">=</span> <span class="n">u_str</span>
        <span class="n">spec_heat_str</span> <span class="o">=</span> <span class="n">cv_str</span>
        <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">u_lp</span><span class="p">,</span> <span class="n">cv_lp</span><span class="p">])</span>

    <span class="n">conc_lp</span><span class="p">,</span> <span class="n">conc_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">conc_arr</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>
    <span class="n">Tdot_lp</span><span class="p">,</span> <span class="n">Tdot_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">T_dot</span><span class="p">,</span> <span class="o">*</span><span class="n">fixed_inds</span><span class="p">)</span>
    <span class="n">wdot_lp</span><span class="p">,</span> <span class="n">wdot_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">spec_rates</span><span class="p">,</span>
                                            <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">conc_lp</span><span class="p">,</span> <span class="n">Tdot_lp</span><span class="p">,</span> <span class="n">wdot_lp</span><span class="p">])</span>

    <span class="n">pre_instructions</span> <span class="o">=</span> <span class="p">[</span><span class="n">Template</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &lt;&gt; upper = 0 {id=uinit}</span>
<span class="sd">        &lt;&gt; lower = 0 {id=linit}</span>
<span class="sd">        # handled by reset_arrays</span>
<span class="sd">        # ${Tdot_str} = 0 {id=init}</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())]</span>
    <span class="n">instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            upper = upper + ${energy_str} * ${wdot_str} {id=sum1, dep=uinit}</span>
<span class="sd">            lower = lower + ${conc_str} * ${spec_heat_str} {id=sum2, dep=linit}</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>

    <span class="n">post_instructions</span> <span class="o">=</span> <span class="p">[</span><span class="n">Template</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ${Tdot_str} = ${Tdot_str} - upper / lower {id=final, dep=sum*}</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())]</span>

    <span class="k">if</span> <span class="n">ic</span><span class="o">.</span><span class="n">use_atomics</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">):</span>
        <span class="c1"># need to fix the post instructions to work atomically</span>
        <span class="n">post_instructions</span> <span class="o">=</span> <span class="p">[</span><span class="n">Template</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            temp_sum[0] = 0 {id=temp_init, atomic}</span>
<span class="sd">            ... lbarrier {id=lb1, dep=temp_init}</span>
<span class="sd">            temp_sum[0] = temp_sum[0] + lower {id=temp_sum, dep=lb1:sum*, \</span>
<span class="sd">                nosync=temp_init, atomic}</span>
<span class="sd">            ... lbarrier {id=lb2, dep=temp_sum}</span>
<span class="sd">            ${Tdot_str} = ${Tdot_str} - upper / temp_sum[0] \</span>
<span class="sd">                {id=final, dep=lb2, nosync=temp_sum:temp_init, atomic}</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())]</span>
        <span class="n">kernel_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lp</span><span class="o">.</span><span class="n">TemporaryVariable</span><span class="p">(</span><span class="s1">&#39;temp_sum&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
                                                <span class="n">scope</span><span class="o">=</span><span class="n">scopes</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)))</span>

    <span class="n">can_vectorize</span><span class="p">,</span> <span class="n">vec_spec</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">get_deep_specializer</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">init_ids</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="s1">&#39;temp_init&#39;</span><span class="p">],</span>
        <span class="n">atomic_ids</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;temp_sum&#39;</span><span class="p">,</span> <span class="s1">&#39;final&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;temperature_rate&#39;</span><span class="p">,</span>
                          <span class="n">pre_instructions</span><span class="o">=</span><span class="n">pre_instructions</span><span class="p">,</span>
                          <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
                          <span class="n">post_instructions</span><span class="o">=</span><span class="n">post_instructions</span><span class="p">,</span>
                          <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                          <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                          <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">,</span>
                          <span class="n">can_vectorize</span><span class="o">=</span><span class="n">can_vectorize</span><span class="p">,</span>
                          <span class="n">vectorization_specializer</span><span class="o">=</span><span class="n">vec_spec</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_spec_rates"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.get_spec_rates">[docs]</a><span class="k">def</span> <span class="nf">get_spec_rates</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">conp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates instructions, kernel arguements, and data for the</span>
<span class="sd">       temperature derivative</span>
<span class="sd">    kernel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    conp : bool</span>
<span class="sd">        If true, generate equations using constant pressure assumption</span>
<span class="sd">        If false, use constant volume equations</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not none, this kernel is being used for testing.</span>
<span class="sd">        Hence we need to size the arrays accordingly</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl_list : list of :class:`knl_info`</span>
<span class="sd">        The generated infos for feeding into the kernel generator for both</span>
<span class="sd">        equation types</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">kernel_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># add problem size</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># various indicies</span>
    <span class="n">spec_ind</span> <span class="o">=</span> <span class="s1">&#39;spec_ind&#39;</span>
    <span class="n">ispec</span> <span class="o">=</span> <span class="s1">&#39;ispec&#39;</span>

    <span class="c1"># create map store</span>
    <span class="n">mapstore</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_reacs</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>

    <span class="c1"># create arrays</span>
    <span class="n">spec_lp</span><span class="p">,</span> <span class="n">spec_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">rxn_to_spec</span><span class="p">,</span>
                                            <span class="n">ispec</span><span class="p">)</span>
    <span class="n">num_spec_offsets_lp</span><span class="p">,</span> \
        <span class="n">num_spec_offsets_str</span> <span class="o">=</span> \
        <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">rxn_to_spec_offsets</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
    <span class="n">num_spec_offsets_next_lp</span><span class="p">,</span> \
        <span class="n">num_spec_offsets_next_str</span> <span class="o">=</span> \
        <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">rxn_to_spec_offsets</span><span class="p">,</span>
                            <span class="n">var_name</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nu_lp</span><span class="p">,</span> <span class="n">prod_nu_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">rxn_to_spec_prod_nu</span><span class="p">,</span> <span class="n">ispec</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="n">ispec</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">reac_nu_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">rxn_to_spec_reac_nu</span><span class="p">,</span> <span class="n">ispec</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="n">ispec</span><span class="p">)</span>
    <span class="n">rop_net_lp</span><span class="p">,</span> <span class="n">rop_net_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">rop_net</span><span class="p">,</span>
                                                  <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>
    <span class="n">wdot_lp</span><span class="p">,</span> <span class="n">wdot_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">spec_rates</span><span class="p">,</span>
                                            <span class="n">global_ind</span><span class="p">,</span> <span class="n">spec_ind</span><span class="p">)</span>

    <span class="c1"># update kernel args</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
        <span class="p">[</span><span class="n">spec_lp</span><span class="p">,</span> <span class="n">num_spec_offsets_lp</span><span class="p">,</span> <span class="n">nu_lp</span><span class="p">,</span> <span class="n">rop_net_lp</span><span class="p">,</span> <span class="n">wdot_lp</span><span class="p">])</span>

    <span class="c1"># now the instructions</span>
    <span class="n">instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &lt;&gt;net_rate = ${rop_net_str} {id=rate_init}</span>
<span class="sd">    &lt;&gt;offset = ${num_spec_offsets_str}</span>
<span class="sd">    &lt;&gt;offset_next = ${num_spec_offsets_next_str}</span>
<span class="sd">    for ispec</span>
<span class="sd">        &lt;&gt; ${spec_ind} = ${spec_str} # (offset handled in wdot str)</span>
<span class="sd">        &lt;&gt; nu = ${prod_nu_str} - ${reac_nu_str}</span>
<span class="sd">        ${wdot_str} = ${wdot_str} + nu * net_rate {id=sum}</span>
<span class="sd">    end</span>
<span class="sd">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>

    <span class="c1"># extra inames</span>
    <span class="n">extra_inames</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;ispec&#39;</span><span class="p">,</span> <span class="s1">&#39;offset &lt;= ispec &lt; offset_next&#39;</span><span class="p">)]</span>

    <span class="n">can_vectorize</span><span class="p">,</span> <span class="n">vec_spec</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">get_deep_specializer</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">atomic_ids</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;spec_rates&#39;</span><span class="p">,</span>
                          <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
                          <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                          <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                          <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">,</span>
                          <span class="n">extra_inames</span><span class="o">=</span><span class="n">extra_inames</span><span class="p">,</span>
                          <span class="n">can_vectorize</span><span class="o">=</span><span class="n">can_vectorize</span><span class="p">,</span>
                          <span class="n">vectorization_specializer</span><span class="o">=</span><span class="n">vec_spec</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_rop_net"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.get_rop_net">[docs]</a><span class="k">def</span> <span class="nf">get_rop_net</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates instructions, kernel arguements, and data for the net</span>
<span class="sd">    Rate of Progress kernels</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not none, this kernel is being used for testing.</span>
<span class="sd">        Hence we need to size the arrays accordingly</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl_list : list of :class:`knl_info`</span>
<span class="sd">        The generated infos for feeding into the kernel generator</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># create net rop kernel</span>

    <span class="n">kernel_data</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;fwd&#39;</span><span class="p">,</span> <span class="p">[])])</span>
    <span class="n">maps</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;fwd&#39;</span><span class="p">,</span>
                         <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_reacs</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))])</span>
    <span class="n">transforms</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fwd&#39;</span><span class="p">:</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_reacs</span><span class="p">}</span>

    <span class="n">separated_kernels</span> <span class="o">=</span> <span class="n">loopy_opts</span><span class="o">.</span><span class="n">rop_net_kernels</span>
    <span class="k">if</span> <span class="n">separated_kernels</span><span class="p">:</span>
        <span class="n">kernel_data</span><span class="p">[</span><span class="s1">&#39;rev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">maps</span><span class="p">[</span><span class="s1">&#39;rev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_rev_reacs</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>
        <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;rev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">namestore</span><span class="o">.</span><span class="n">rev_map</span>
        <span class="n">kernel_data</span><span class="p">[</span><span class="s1">&#39;pres_mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">maps</span><span class="p">[</span><span class="s1">&#39;pres_mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_thd</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>
        <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;pres_mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">namestore</span><span class="o">.</span><span class="n">thd_map</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;rev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">namestore</span><span class="o">.</span><span class="n">rev_mask</span>
        <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;pres_mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">namestore</span><span class="o">.</span><span class="n">thd_mask</span>

    <span class="k">def</span> <span class="nf">__add_data</span><span class="p">(</span><span class="n">knl</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">separated_kernels</span><span class="p">:</span>
            <span class="n">kernel_data</span><span class="p">[</span><span class="n">knl</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kernel_data</span><span class="p">[</span><span class="s1">&#39;fwd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add_to_all</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">kernel</span> <span class="ow">in</span> <span class="n">kernel_data</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">__add_data</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">__add_data</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get_map</span><span class="p">(</span><span class="n">knl</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">separated_kernels</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">maps</span><span class="p">[</span><span class="n">knl</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">maps</span><span class="p">[</span><span class="s1">&#39;fwd&#39;</span><span class="p">]</span>

    <span class="c1"># add transforms</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">separated_kernels</span><span class="p">:</span>
        <span class="c1"># if separate kernels, we&#39;re looping over the rev / pres mod indicies</span>
        <span class="c1"># directly, hence no transforms</span>
        <span class="k">if</span> <span class="n">namestore</span><span class="o">.</span><span class="n">rop_rev</span><span class="p">:</span>
            <span class="n">__get_map</span><span class="p">(</span><span class="s1">&#39;rev&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span>
                <span class="n">namestore</span><span class="o">.</span><span class="n">rop_rev</span><span class="p">,</span> <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;rev&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">namestore</span><span class="o">.</span><span class="n">pres_mod</span><span class="p">:</span>
            <span class="n">__get_map</span><span class="p">(</span><span class="s1">&#39;pres_mod&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span>
                <span class="n">namestore</span><span class="o">.</span><span class="n">pres_mod</span><span class="p">,</span> <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;pres_mod&#39;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">kernel_data</span><span class="p">:</span>
        <span class="c1"># check for map / mask</span>
        <span class="n">__get_map</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">rop_net</span><span class="p">,</span>
                                    <span class="n">transforms</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

    <span class="n">__add_to_all</span><span class="p">(</span>
        <span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># create the fwd rop array / str</span>
    <span class="c1"># this never has a map / mask</span>
    <span class="n">rop_fwd_lp</span><span class="p">,</span> <span class="n">rop_fwd_str</span> <span class="o">=</span> <span class="n">__get_map</span><span class="p">(</span><span class="s1">&#39;fwd&#39;</span><span class="p">)</span><span class="o">.</span>\
        <span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">rop_fwd</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="n">__add_data</span><span class="p">(</span><span class="s1">&#39;fwd&#39;</span><span class="p">,</span> <span class="n">rop_fwd_lp</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">namestore</span><span class="o">.</span><span class="n">rop_rev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># we have reversible reactions</span>

        <span class="c1"># apply the maps</span>
        <span class="n">rop_rev_lp</span><span class="p">,</span> <span class="n">rop_rev_str</span> <span class="o">=</span> <span class="n">__get_map</span><span class="p">(</span><span class="s1">&#39;rev&#39;</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">rop_rev</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

        <span class="c1"># add data</span>
        <span class="n">__add_data</span><span class="p">(</span><span class="s1">&#39;rev&#39;</span><span class="p">,</span> <span class="n">rop_rev_lp</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">namestore</span><span class="o">.</span><span class="n">pres_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># we have pres mod reactions</span>

        <span class="c1"># apply the maps</span>
        <span class="n">pres_mod_lp</span><span class="p">,</span> <span class="n">pres_mod_str</span> <span class="o">=</span> <span class="n">__get_map</span><span class="p">(</span><span class="s1">&#39;pres_mod&#39;</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">pres_mod</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

        <span class="c1"># add data</span>
        <span class="n">__add_data</span><span class="p">(</span><span class="s1">&#39;pres_mod&#39;</span><span class="p">,</span> <span class="n">pres_mod_lp</span><span class="p">)</span>

    <span class="c1"># add rop net to all kernels:</span>
    <span class="n">rop_strs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">kernel_data</span><span class="p">:</span>

        <span class="c1"># apply map</span>
        <span class="n">rop_net_lp</span><span class="p">,</span> <span class="n">rop_net_str</span> <span class="o">=</span> <span class="n">__get_map</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">rop_net</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

        <span class="c1"># and add to data</span>
        <span class="n">__add_data</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rop_net_lp</span><span class="p">)</span>

        <span class="c1"># store rop_net str for later</span>
        <span class="n">rop_strs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rop_net_str</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">separated_kernels</span><span class="p">:</span>
        <span class="c1"># now the instructions</span>
        <span class="n">instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &lt;&gt;net_rate = ${rop_fwd_str} {id=rate_update}</span>
<span class="sd">        ${rev_update}</span>
<span class="sd">        ${pmod_update}</span>
<span class="sd">        ${rop_net_str} = net_rate {dep=rate_update*}</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">rop_fwd_str</span><span class="o">=</span><span class="n">rop_fwd_str</span><span class="p">,</span>
                             <span class="n">rop_net_str</span><span class="o">=</span><span class="n">rop_strs</span><span class="p">[</span><span class="s1">&#39;fwd&#39;</span><span class="p">])</span>

        <span class="c1"># reverse update</span>
        <span class="n">rev_update_instructions</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">get_update_instruction</span><span class="p">(</span>
            <span class="n">__get_map</span><span class="p">(</span><span class="s1">&#39;rev&#39;</span><span class="p">),</span> <span class="n">namestore</span><span class="o">.</span><span class="n">rop_rev</span><span class="p">,</span>
            <span class="n">Template</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            net_rate = net_rate - ${rop_rev_str} \</span>
<span class="sd">                {id=rate_update_rev, dep=rate_update}</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span>
                <span class="n">rop_rev_str</span><span class="o">=</span><span class="n">rop_rev_str</span><span class="p">))</span>

        <span class="c1"># pmod update</span>
        <span class="n">pmod_update_instructions</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">get_update_instruction</span><span class="p">(</span>
            <span class="n">__get_map</span><span class="p">(</span><span class="s1">&#39;pres_mod&#39;</span><span class="p">),</span> <span class="n">namestore</span><span class="o">.</span><span class="n">pres_mod</span><span class="p">,</span>
            <span class="n">Template</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            net_rate = net_rate * ${pres_mod_str} \</span>
<span class="sd">                {id=rate_update_pmod, dep=rate_update${rev_dep}}</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span>
                <span class="n">rev_dep</span><span class="o">=</span><span class="s1">&#39;:rate_update_rev&#39;</span> <span class="k">if</span> <span class="n">namestore</span><span class="o">.</span><span class="n">rop_rev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">pres_mod_str</span><span class="o">=</span><span class="n">pres_mod_str</span><span class="p">))</span>

        <span class="n">instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">instructions</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span>
            <span class="n">rev_update</span><span class="o">=</span><span class="n">rev_update_instructions</span><span class="p">,</span>
            <span class="n">pmod_update</span><span class="o">=</span><span class="n">pmod_update_instructions</span><span class="p">)</span>

        <span class="n">instructions</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">instructions</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()])</span>

        <span class="k">return</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;rop_net_fixed&#39;</span><span class="p">,</span>
                              <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
                              <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                              <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">[</span><span class="s1">&#39;fwd&#39;</span><span class="p">],</span>
                              <span class="n">mapstore</span><span class="o">=</span><span class="n">maps</span><span class="p">[</span><span class="s1">&#39;fwd&#39;</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">infos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">kernel</span> <span class="ow">in</span> <span class="n">kernel_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kernel</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span><span class="p">:</span>
                <span class="n">instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            ${rop_net_str} = ${rop_fwd_str} {id=rop_net_fwd}</span>
<span class="sd">                    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">rop_fwd_str</span><span class="o">=</span><span class="n">rop_fwd_str</span><span class="p">,</span>
                                         <span class="n">rop_net_str</span><span class="o">=</span><span class="n">rop_strs</span><span class="p">[</span><span class="s1">&#39;fwd&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">kernel</span> <span class="o">==</span> <span class="s1">&#39;rev&#39;</span><span class="p">:</span>
                <span class="n">instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            ${rop_net_str} = ${rop_net_str} - ${rop_rev_str} {id=rop_net_rev}</span>
<span class="sd">                    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">rop_rev_str</span><span class="o">=</span><span class="n">rop_rev_str</span><span class="p">,</span>
                                         <span class="n">rop_net_str</span><span class="o">=</span><span class="n">rop_strs</span><span class="p">[</span><span class="s1">&#39;rev&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            ${rop_net_str} = ${rop_net_str} * ${pres_mod_str} {id=rop_net_pres_mod}</span>
<span class="sd">                    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">pres_mod_str</span><span class="o">=</span><span class="n">pres_mod_str</span><span class="p">,</span>
                                         <span class="n">rop_net_str</span><span class="o">=</span><span class="n">rop_strs</span><span class="p">[</span><span class="s1">&#39;pres_mod&#39;</span><span class="p">])</span>

            <span class="n">instructions</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">instructions</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()])</span>
            <span class="n">infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;rop_net_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kernel</span><span class="p">),</span>
                                        <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
                                        <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                                        <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">[</span><span class="n">kernel</span><span class="p">],</span>
                                        <span class="n">mapstore</span><span class="o">=</span><span class="n">maps</span><span class="p">[</span><span class="n">kernel</span><span class="p">],</span>
                                        <span class="n">silenced_warnings</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;write_race(rop_net_</span><span class="si">{}</span><span class="s1">)&#39;</span>
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kernel</span><span class="p">)]))</span>
        <span class="k">return</span> <span class="n">infos</span></div>


<div class="viewcode-block" id="get_rop"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.get_rop">[docs]</a><span class="k">def</span> <span class="nf">get_rop</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">allint</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;net&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span> <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates instructions, kernel arguements, and data for the Rate of Progress</span>
<span class="sd">    kernels</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    allint : dict</span>
<span class="sd">        If allint[&#39;net&#39;] is True, powers of concentrations</span>
<span class="sd">        will be evaluated using multiplications</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not none, this kernel is being used for testing.</span>
<span class="sd">        Hence we need to size the arrays accordingly</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl_list : list of :class:`knl_info`</span>
<span class="sd">        The generated infos for feeding into the kernel generator</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">maps</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># create ROP kernels</span>

    <span class="k">def</span> <span class="nf">__rop_create</span><span class="p">(</span><span class="n">direction</span><span class="p">):</span>
        <span class="n">spec_loop</span> <span class="o">=</span> <span class="s1">&#39;ispec&#39;</span>
        <span class="n">spec_ind</span> <span class="o">=</span> <span class="s1">&#39;spec_ind&#39;</span>

        <span class="c1"># indicies</span>
        <span class="n">kernel_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># add problem size</span>
        <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span>
            <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span><span class="p">:</span>
            <span class="n">inds</span> <span class="o">=</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_reacs</span>
            <span class="n">mapinds</span> <span class="o">=</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_reacs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inds</span> <span class="o">=</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_rev_reacs</span>
            <span class="n">mapinds</span> <span class="o">=</span> <span class="n">namestore</span><span class="o">.</span><span class="n">rev_map</span>

        <span class="n">maps</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>
        <span class="n">themap</span> <span class="o">=</span> <span class="n">maps</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span>

        <span class="c1"># add transforms for the offsets</span>
        <span class="n">themap</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span>
            <span class="n">namestore</span><span class="o">.</span><span class="n">rxn_to_spec_offsets</span><span class="p">,</span> <span class="n">mapinds</span><span class="p">)</span>

        <span class="c1"># we need species lists, nu lists, etc.</span>

        <span class="c1"># offsets are on main loop, no map</span>
        <span class="n">num_spec_offsets_lp</span><span class="p">,</span> <span class="n">num_spec_offsets_str</span> <span class="o">=</span> <span class="n">themap</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
            <span class="n">namestore</span><span class="o">.</span><span class="n">rxn_to_spec_offsets</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>

        <span class="c1"># next offset to calculate num species</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">num_spec_offsets_next_str</span> <span class="o">=</span> <span class="n">themap</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
            <span class="n">namestore</span><span class="o">.</span><span class="n">rxn_to_spec_offsets</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># nu lists are on main loop, no map</span>
        <span class="n">nus</span> <span class="o">=</span> <span class="s1">&#39;rxn_to_spec_reac_nu&#39;</span> <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span>\
            <span class="k">else</span> <span class="s1">&#39;rxn_to_spec_prod_nu&#39;</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">namestore</span><span class="p">,</span> <span class="n">nus</span><span class="p">)</span>
        <span class="n">nu_lp</span><span class="p">,</span> <span class="n">nu_str</span> <span class="o">=</span> <span class="n">themap</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">spec_loop</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="n">spec_loop</span><span class="p">)</span>

        <span class="c1"># species lists are in ispec loop, use that iname</span>
        <span class="n">spec_lp</span><span class="p">,</span> <span class="n">spec_str</span> <span class="o">=</span> <span class="n">themap</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
            <span class="n">namestore</span><span class="o">.</span><span class="n">rxn_to_spec</span><span class="p">,</span> <span class="n">spec_loop</span><span class="p">)</span>

        <span class="c1"># rate constants on main loop, no map</span>
        <span class="n">rateconst</span> <span class="o">=</span> <span class="n">namestore</span><span class="o">.</span><span class="n">kf</span> <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;fwd&#39;</span> <span class="k">else</span> <span class="n">namestore</span><span class="o">.</span><span class="n">kr</span>
        <span class="n">rateconst_arr</span><span class="p">,</span> <span class="n">rateconst_str</span> <span class="o">=</span> <span class="n">themap</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
            <span class="n">rateconst</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

        <span class="c1"># concentrations in ispec loop, also use offset for phi</span>
        <span class="n">concs_lp</span><span class="p">,</span> <span class="n">concs_str</span> <span class="o">=</span> <span class="n">themap</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
            <span class="n">namestore</span><span class="o">.</span><span class="n">conc_arr</span><span class="p">,</span> <span class="n">global_ind</span><span class="p">,</span> <span class="n">spec_ind</span><span class="p">)</span>

        <span class="c1"># and finally the ROP values in the mainloop, no map</span>
        <span class="n">rop</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">namestore</span><span class="p">,</span> <span class="s1">&#39;rop_&#39;</span> <span class="o">+</span> <span class="n">direction</span><span class="p">)</span>
        <span class="n">rop_arr</span><span class="p">,</span> <span class="n">rop_str</span> <span class="o">=</span> <span class="n">themap</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">rop</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

        <span class="c1"># update kernel data</span>
        <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span><span class="n">num_spec_offsets_lp</span><span class="p">,</span> <span class="n">concs_lp</span><span class="p">,</span> <span class="n">nu_lp</span><span class="p">,</span> <span class="n">spec_lp</span><span class="p">,</span>
             <span class="n">rateconst_arr</span><span class="p">,</span> <span class="n">rop_arr</span><span class="p">])</span>

        <span class="c1"># instructions</span>
        <span class="n">rop_instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &lt;&gt;rop_temp = ${rateconst_str} {id=rop_init}</span>
<span class="sd">    &lt;&gt;spec_offset = ${num_spec_offsets_str}</span>
<span class="sd">    &lt;&gt;spec_offset_next = ${num_spec_offsets_next_str}</span>
<span class="sd">    for ${spec_loop}</span>
<span class="sd">        &lt;&gt;${spec_ind} = ${spec_str} {id=spec_ind}</span>
<span class="sd">        ${rop_temp_eval}</span>
<span class="sd">    end</span>
<span class="sd">    ${rop_str} = rop_temp {dep=rop_fin*}</span>
<span class="sd">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">rateconst_str</span><span class="o">=</span><span class="n">rateconst_str</span><span class="p">,</span>
                         <span class="n">rop_str</span><span class="o">=</span><span class="n">rop_str</span><span class="p">,</span>
                         <span class="n">spec_loop</span><span class="o">=</span><span class="n">spec_loop</span><span class="p">,</span>
                         <span class="n">num_spec_offsets_str</span><span class="o">=</span><span class="n">num_spec_offsets_str</span><span class="p">,</span>
                         <span class="n">num_spec_offsets_next_str</span><span class="o">=</span><span class="n">num_spec_offsets_next_str</span><span class="p">,</span>
                         <span class="n">spec_str</span><span class="o">=</span><span class="n">spec_str</span><span class="p">,</span>
                         <span class="n">spec_ind</span><span class="o">=</span><span class="n">spec_ind</span><span class="p">)</span>

        <span class="n">power_func</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">power_function</span><span class="p">(</span><span class="n">loopy_opts</span><span class="o">.</span><span class="n">lang</span><span class="p">,</span>
                                          <span class="n">is_integer_power</span><span class="o">=</span><span class="n">allint</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">])</span>
        <span class="c1"># if all integers, it&#39;s much faster to use multiplication</span>
        <span class="n">roptemp_eval</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    rop_temp = rop_temp * ${power_func}(${concs_str}, ${nu_str}) {id=rop_fin, \</span>
<span class="sd">        dep=rop_init}</span>
<span class="sd">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span>
            <span class="n">nu_str</span><span class="o">=</span><span class="n">nu_str</span><span class="p">,</span>
            <span class="n">concs_str</span><span class="o">=</span><span class="n">concs_str</span><span class="p">,</span>
            <span class="n">power_func</span><span class="o">=</span><span class="n">power_func</span><span class="p">)</span>

        <span class="n">rop_instructions</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">subs_at_indent</span><span class="p">(</span><span class="n">rop_instructions</span><span class="p">,</span>
                                                <span class="n">rop_temp_eval</span><span class="o">=</span><span class="n">roptemp_eval</span><span class="p">)</span>

        <span class="c1"># and finally extra inames</span>
        <span class="n">extra_inames</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">spec_loop</span><span class="p">,</span> <span class="s1">&#39;spec_offset &lt;= </span><span class="si">{}</span><span class="s1"> &lt; spec_offset_next&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec_loop</span><span class="p">))]</span>

        <span class="c1"># and return the rateconst</span>
        <span class="k">return</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;rop_eval_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">direction</span><span class="p">),</span>
                              <span class="n">instructions</span><span class="o">=</span><span class="n">rop_instructions</span><span class="p">,</span>
                              <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                              <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">,</span>
                              <span class="n">extra_inames</span><span class="o">=</span><span class="n">extra_inames</span><span class="p">,</span>
                              <span class="n">mapstore</span><span class="o">=</span><span class="n">maps</span><span class="p">[</span><span class="n">direction</span><span class="p">],</span>
                              <span class="n">manglers</span><span class="o">=</span><span class="n">lp_pregen</span><span class="o">.</span><span class="n">power_function_manglers</span><span class="p">(</span>
                                <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">power_func</span><span class="p">),</span>
                              <span class="n">preambles</span><span class="o">=</span><span class="n">lp_pregen</span><span class="o">.</span><span class="n">power_function_preambles</span><span class="p">(</span>
                                <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">power_func</span><span class="p">))</span>

    <span class="n">infos</span> <span class="o">=</span> <span class="p">[</span><span class="n">__rop_create</span><span class="p">(</span><span class="s1">&#39;fwd&#39;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">namestore</span><span class="o">.</span><span class="n">rop_rev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__rop_create</span><span class="p">(</span><span class="s1">&#39;rev&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">infos</span></div>


<div class="viewcode-block" id="get_rxn_pres_mod"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.get_rxn_pres_mod">[docs]</a><span class="k">def</span> <span class="nf">get_rxn_pres_mod</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates instructions, kernel arguements, and data for pressure</span>
<span class="sd">    modification term of the forward reaction rates.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not none, this kernel is being used for testing.</span>
<span class="sd">        Hence we need to size the arrays accordingly</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl_list : list of :class:`knl_info`</span>
<span class="sd">        The generated infos for feeding into the kernel generator</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check for empty</span>
    <span class="k">if</span> <span class="n">namestore</span><span class="o">.</span><span class="n">thd_only_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">info_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># start developing the ci kernel</span>
        <span class="c1"># rate info and reac ind</span>

        <span class="n">kernel_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># add problem size</span>
        <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span>
            <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

        <span class="c1"># create the third body conc pres-mod kernel</span>

        <span class="n">thd_map</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">thd_only_map</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>

        <span class="c1"># get the third body concs</span>
        <span class="n">thd_lp</span><span class="p">,</span> <span class="n">thd_str</span> <span class="o">=</span> <span class="n">thd_map</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">thd_conc</span><span class="p">,</span>
                                             <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

        <span class="c1"># and the pressure mod term</span>
        <span class="n">pres_mod_lp</span><span class="p">,</span> <span class="n">pres_mod_str</span> <span class="o">=</span> <span class="n">thd_map</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">pres_mod</span><span class="p">,</span>
                                                       <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

        <span class="n">thd_instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        $</span><span class="si">{pres_mod}</span><span class="s2"> = $</span><span class="si">{thd_conc}</span><span class="s2"> {id=set_pres_mod}</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">pres_mod</span><span class="o">=</span><span class="n">pres_mod_str</span><span class="p">,</span>
                             <span class="n">thd_conc</span><span class="o">=</span><span class="n">thd_str</span><span class="p">)</span>

        <span class="c1"># and the args</span>
        <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">thd_lp</span><span class="p">,</span> <span class="n">pres_mod_lp</span><span class="p">])</span>

        <span class="c1"># add to the info list</span>
        <span class="n">info_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ci_thd&#39;</span><span class="p">,</span>
                           <span class="n">instructions</span><span class="o">=</span><span class="n">thd_instructions</span><span class="p">,</span>
                           <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                           <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">,</span>
                           <span class="n">mapstore</span><span class="o">=</span><span class="n">thd_map</span><span class="p">,</span>
                           <span class="n">silenced_warnings</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;write_race(set_pres_mod)&#39;</span><span class="p">])]</span>

    <span class="c1"># check for empty</span>
    <span class="k">if</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_fall</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">info_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># and now the falloff kernel</span>
        <span class="n">kernel_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># add problem size</span>
        <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span>
            <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

        <span class="n">fall_map</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_fall</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>

        <span class="c1"># the pressure mod term uses fall_to_thd_map/mask</span>
        <span class="n">fall_map</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">pres_mod</span><span class="p">,</span>
                                         <span class="n">namestore</span><span class="o">.</span><span class="n">fall_to_thd_map</span><span class="p">)</span>

        <span class="c1"># the falloff vs chemically activated indicator</span>
        <span class="n">fall_type_lp</span><span class="p">,</span> <span class="n">fall_type_str</span> <span class="o">=</span> \
            <span class="n">fall_map</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">fall_type</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>

        <span class="c1"># the blending term</span>
        <span class="n">Fi_lp</span><span class="p">,</span> <span class="n">Fi_str</span> <span class="o">=</span> \
            <span class="n">fall_map</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">Fi</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

        <span class="c1"># the Pr array</span>
        <span class="n">Pr_lp</span><span class="p">,</span> <span class="n">Pr_str</span> <span class="o">=</span> \
            <span class="n">fall_map</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">Pr</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

        <span class="n">pres_mod_lp</span><span class="p">,</span> <span class="n">pres_mod_str</span> <span class="o">=</span> \
            <span class="n">fall_map</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">pres_mod</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

        <span class="c1"># update the args</span>
        <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">Fi_lp</span><span class="p">,</span> <span class="n">Pr_lp</span><span class="p">,</span> <span class="n">fall_type_lp</span><span class="p">,</span> <span class="n">pres_mod_lp</span><span class="p">])</span>

        <span class="n">fall_instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;&gt;ci_temp = $</span><span class="si">{Fi_str}</span><span class="s2"> / (1 + $</span><span class="si">{Pr_str}</span><span class="s2">) {id=ci_decl}</span>
<span class="s2">        if not $</span><span class="si">{fall_type}</span><span class="s2"></span>
<span class="s2">            ci_temp = ci_temp * $</span><span class="si">{Pr_str}</span><span class="s2"> {id=ci_update, dep=ci_decl}</span>
<span class="s2">        end</span>
<span class="s2">        $</span><span class="si">{pres_mod}</span><span class="s2"> = ci_temp {dep=ci_update}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">Fi_str</span><span class="o">=</span><span class="n">Fi_str</span><span class="p">,</span>
                         <span class="n">Pr_str</span><span class="o">=</span><span class="n">Pr_str</span><span class="p">,</span>
                         <span class="n">pres_mod</span><span class="o">=</span><span class="n">pres_mod_str</span><span class="p">,</span>
                         <span class="n">fall_type</span><span class="o">=</span><span class="n">fall_type_str</span>
                         <span class="p">)</span>

        <span class="c1"># add to the info list</span>
        <span class="n">info_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ci_fall&#39;</span><span class="p">,</span>
                           <span class="n">instructions</span><span class="o">=</span><span class="n">fall_instructions</span><span class="p">,</span>
                           <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                           <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">,</span>
                           <span class="n">mapstore</span><span class="o">=</span><span class="n">fall_map</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">info_list</span></div>


<div class="viewcode-block" id="get_rev_rates"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.get_rev_rates">[docs]</a><span class="k">def</span> <span class="nf">get_rev_rates</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">allint</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates instructions, kernel arguements, and data for reverse reaction</span>
<span class="sd">    rates</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    allint : dict</span>
<span class="sd">        Contains keys &#39;fwd&#39;, &#39;rev&#39; and &#39;net&#39;, with booleans corresponding to</span>
<span class="sd">        whether all nu values for that direction are integers.</span>
<span class="sd">        If True, powers of concentrations will be evaluated using</span>
<span class="sd">        multiplications</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not none, this kernel is being used for testing.</span>
<span class="sd">        Hence we need to size the arrays accordingly</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl_list : list of :class:`knl_info`</span>
<span class="sd">        The generated infos for feeding into the kernel generator</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check for empty</span>
    <span class="k">if</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_rev_reacs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># start developing the Kc kernel</span>
    <span class="n">kernel_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spec_ind</span> <span class="o">=</span> <span class="s1">&#39;spec_ind&#39;</span>
    <span class="n">spec_loop</span> <span class="o">=</span> <span class="s1">&#39;ispec&#39;</span>

    <span class="c1"># add problem size</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># add the reverse map</span>
    <span class="n">rev_map</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_rev_reacs</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>

    <span class="c1"># map from reverse reaction index to forward reaction index</span>
    <span class="n">rev_map</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">nu_sum</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">rev_map</span><span class="p">)</span>
    <span class="n">rev_map</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">rxn_to_spec</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">rev_map</span><span class="p">)</span>
    <span class="n">rev_map</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">rxn_to_spec_offsets</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">rev_map</span><span class="p">)</span>
    <span class="n">rev_map</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">kf</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">rev_map</span><span class="p">)</span>

    <span class="c1"># create nu_sum on main loop</span>
    <span class="n">nu_sum_lp</span><span class="p">,</span> <span class="n">nu_sum_str</span> <span class="o">=</span> <span class="n">rev_map</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">nu_sum</span><span class="p">,</span>
                                               <span class="n">var_name</span><span class="p">)</span>

    <span class="c1"># all species in reaction on spec loop</span>
    <span class="n">spec_lp</span><span class="p">,</span> <span class="n">spec_str</span> <span class="o">=</span> <span class="n">rev_map</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">rxn_to_spec</span><span class="p">,</span>
                                           <span class="n">spec_loop</span><span class="p">)</span>

    <span class="c1"># species offsets on main loop</span>
    <span class="n">num_spec_offsets_lp</span><span class="p">,</span> <span class="n">num_spec_offsets_str</span> <span class="o">=</span> <span class="n">rev_map</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">rxn_to_spec_offsets</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>

    <span class="c1"># species offset on main loop with offset of 1</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">num_spec_offsets_next_str</span> <span class="o">=</span> <span class="n">rev_map</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">rxn_to_spec_offsets</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># B array on spec_ind</span>
    <span class="n">B_lp</span><span class="p">,</span> <span class="n">B_str</span> <span class="o">=</span> <span class="n">rev_map</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">global_ind</span><span class="p">,</span> <span class="n">spec_ind</span><span class="p">)</span>

    <span class="c1"># net nu on species loop</span>
    <span class="n">nu_lp</span><span class="p">,</span> <span class="n">prod_nu_str</span> <span class="o">=</span> <span class="n">rev_map</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">rxn_to_spec_prod_nu</span><span class="p">,</span>
                                            <span class="n">spec_loop</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="n">spec_loop</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">reac_nu_str</span> <span class="o">=</span> <span class="n">rev_map</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">rxn_to_spec_reac_nu</span><span class="p">,</span>
                                        <span class="n">spec_loop</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="n">spec_loop</span><span class="p">)</span>

    <span class="c1"># the Kc array on the main loop, no map as this is only reversible</span>
    <span class="n">Kc_lp</span><span class="p">,</span> <span class="n">Kc_str</span> <span class="o">=</span> <span class="n">rev_map</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">Kc</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="c1"># create the kf array / str</span>
    <span class="n">kf_arr</span><span class="p">,</span> <span class="n">kf_str</span> <span class="o">=</span> <span class="n">rev_map</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">kf</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="c1"># create the kr array / str (no map as we&#39;re looping over rev inds)</span>
    <span class="n">kr_arr</span><span class="p">,</span> <span class="n">kr_str</span> <span class="o">=</span> <span class="n">rev_map</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">kr</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="c1"># update kernel data</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">nu_sum_lp</span><span class="p">,</span> <span class="n">spec_lp</span><span class="p">,</span> <span class="n">num_spec_offsets_lp</span><span class="p">,</span>
                        <span class="n">B_lp</span><span class="p">,</span> <span class="n">Kc_lp</span><span class="p">,</span> <span class="n">nu_lp</span><span class="p">,</span> <span class="n">kf_arr</span><span class="p">,</span> <span class="n">kr_arr</span><span class="p">])</span>

    <span class="c1"># get the right power function</span>
    <span class="n">power_func</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">power_function</span><span class="p">(</span><span class="n">loopy_opts</span><span class="o">.</span><span class="n">lang</span><span class="p">,</span>
                                      <span class="n">is_integer_power</span><span class="o">=</span><span class="n">allint</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">])</span>

    <span class="c1"># create the pressure product loop</span>
    <span class="n">pressure_prod</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;&gt; P_sum_end = abs($</span><span class="si">{nu_sum}</span><span class="s2">) {id=P_bound}</span>
<span class="s2">    if $</span><span class="si">{nu_sum}</span><span class="s2"> &gt; 0</span>
<span class="s2">        &lt;&gt; P_val = P_a / R_u {id=P_val_decl}</span>
<span class="s2">    else</span>
<span class="s2">        P_val = R_u / P_a {id=P_val_decl1}</span>
<span class="s2">    end</span>
<span class="s2">    &lt;&gt; P_sum = $</span><span class="si">{power_func}</span><span class="s2">(P_val, P_sum_end) {id=P_accum, dep=P_val_decl*}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">nu_sum</span><span class="o">=</span><span class="n">nu_sum_str</span><span class="p">,</span>
                    <span class="n">power_func</span><span class="o">=</span><span class="n">power_func</span><span class="p">)</span>

    <span class="c1"># and the b sum loop</span>
    <span class="n">Bsum_inst</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;&gt;offset = $</span><span class="si">{spec_offset}</span><span class="s2"> {id=offset}</span>
<span class="s2">    &lt;&gt;spec_end = $</span><span class="si">{spec_offset_next}</span><span class="s2"> {id=B_bound}</span>
<span class="s2">    &lt;&gt;B_sum = 0 {id=B_init}</span>
<span class="s2">    for $</span><span class="si">{spec_loop}</span><span class="s2"></span>
<span class="s2">        &lt;&gt;$</span><span class="si">{spec_ind}</span><span class="s2"> = $</span><span class="si">{spec_mapper}</span><span class="s2"> {dep=offset:B_bound}</span>
<span class="s2">        &lt;&gt;net_nu = $</span><span class="si">{prod_nu_str}</span><span class="s2"> - $</span><span class="si">{reac_nu_str}</span><span class="s2"></span>
<span class="s2">        if net_nu != 0</span>
<span class="s2">            B_sum = B_sum + net_nu * $</span><span class="si">{B_val}</span><span class="s2"> {id=B_accum, dep=B_init}</span>
<span class="s2">        end</span>
<span class="s2">    end</span>
<span class="s2">    B_sum = exp(B_sum) {id=B_final, dep=B_accum}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">spec_offset</span><span class="o">=</span><span class="n">num_spec_offsets_str</span><span class="p">,</span>
                    <span class="n">spec_offset_next</span><span class="o">=</span><span class="n">num_spec_offsets_next_str</span><span class="p">,</span>
                    <span class="n">spec_loop</span><span class="o">=</span><span class="n">spec_loop</span><span class="p">,</span>
                    <span class="n">spec_ind</span><span class="o">=</span><span class="n">spec_ind</span><span class="p">,</span>
                    <span class="n">spec_mapper</span><span class="o">=</span><span class="n">spec_str</span><span class="p">,</span>
                    <span class="n">nu_val</span><span class="o">=</span><span class="n">nu_sum_str</span><span class="p">,</span>
                    <span class="n">prod_nu_str</span><span class="o">=</span><span class="n">prod_nu_str</span><span class="p">,</span>
                    <span class="n">reac_nu_str</span><span class="o">=</span><span class="n">reac_nu_str</span><span class="p">,</span>
                    <span class="n">B_val</span><span class="o">=</span><span class="n">B_str</span>
                    <span class="p">)</span>

    <span class="n">Rate_assign</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;&gt;Kc_temp = P_sum * B_sum {dep=P_accum*:B_final}</span>
<span class="s2">    $</span><span class="si">{Kc_str}</span><span class="s2"> = Kc_temp</span>
<span class="s2">    $</span><span class="si">{kr_str}</span><span class="s2"> = $</span><span class="si">{kf_str}</span><span class="s2"> / Kc_temp</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>

    <span class="n">instructions</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">Bsum_inst</span><span class="p">,</span> <span class="n">pressure_prod</span><span class="p">,</span> <span class="n">Rate_assign</span><span class="p">])</span>

    <span class="c1"># create the extra inames</span>
    <span class="n">extra_inames</span> <span class="o">=</span> <span class="p">[(</span><span class="n">spec_loop</span><span class="p">,</span> <span class="s1">&#39;offset &lt;= </span><span class="si">{}</span><span class="s1"> &lt; spec_end&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec_loop</span><span class="p">))]</span>

    <span class="c1"># and return the rateinfo</span>
    <span class="k">return</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;rateconst_Kc&#39;</span><span class="p">,</span>
                          <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
                          <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                          <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">,</span>
                          <span class="n">mapstore</span><span class="o">=</span><span class="n">rev_map</span><span class="p">,</span>
                          <span class="n">extra_inames</span><span class="o">=</span><span class="n">extra_inames</span><span class="p">,</span>
                          <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
                              <span class="s1">&#39;P_a&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">PA</span><span class="p">),</span>
                              <span class="s1">&#39;R_u&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">RU</span><span class="p">)},</span>
                          <span class="n">manglers</span><span class="o">=</span><span class="n">lp_pregen</span><span class="o">.</span><span class="n">power_function_manglers</span><span class="p">(</span>
                                <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">power_func</span><span class="p">),</span>
                          <span class="n">preambles</span><span class="o">=</span><span class="n">lp_pregen</span><span class="o">.</span><span class="n">power_function_preambles</span><span class="p">(</span>
                                <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">power_func</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_thd_body_concs"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.get_thd_body_concs">[docs]</a><span class="k">def</span> <span class="nf">get_thd_body_concs</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates instructions, kernel arguements, and data for third body</span>
<span class="sd">    concentrations</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not none, this kernel is being used for testing.</span>
<span class="sd">        Hence we need to size the arrays accordingly</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl_list : list of :class:`knl_info`</span>
<span class="sd">        The generated infos for feeding into the kernel generator</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check for empty</span>
    <span class="k">if</span> <span class="n">namestore</span><span class="o">.</span><span class="n">thd_inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">spec_ind</span> <span class="o">=</span> <span class="s1">&#39;spec_ind&#39;</span>
    <span class="n">spec_loop</span> <span class="o">=</span> <span class="s1">&#39;ispec&#39;</span>
    <span class="n">spec_offset</span> <span class="o">=</span> <span class="s1">&#39;offset&#39;</span>

    <span class="c1"># create mapstore over number of third reactions</span>
    <span class="n">mapstore</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">thd_inds</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>

    <span class="c1"># create args</span>

    <span class="c1"># get concentrations</span>
    <span class="c1"># in species loop</span>
    <span class="n">concs_lp</span><span class="p">,</span> <span class="n">concs_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">conc_arr</span><span class="p">,</span> <span class="n">global_ind</span><span class="p">,</span> <span class="n">spec_ind</span><span class="p">)</span>

    <span class="c1"># get third body concentrations (by defn same as third reactions)</span>
    <span class="n">thd_lp</span><span class="p">,</span> <span class="n">thd_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">thd_conc</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="c1"># get T and P arrays</span>
    <span class="n">T_arr</span><span class="p">,</span> <span class="n">T_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">T_arr</span><span class="p">,</span> <span class="n">global_ind</span><span class="p">)</span>
    <span class="n">P_arr</span><span class="p">,</span> <span class="n">P_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">P_arr</span><span class="p">,</span> <span class="n">global_ind</span><span class="p">)</span>

    <span class="c1"># and the third body descriptions</span>

    <span class="c1"># efficiency list</span>
    <span class="n">thd_eff_lp</span><span class="p">,</span> <span class="n">thd_eff_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">thd_eff</span><span class="p">,</span> <span class="n">spec_loop</span><span class="p">)</span>
    <span class="c1"># non-unity species in thd-body conc</span>
    <span class="n">thd_spec_lp</span><span class="p">,</span> <span class="n">thd_spec_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">thd_spec</span><span class="p">,</span> <span class="n">spec_loop</span><span class="p">)</span>
    <span class="c1"># offset to spec / efficiency arrays</span>
    <span class="n">thd_offset_lp</span><span class="p">,</span> <span class="n">thd_offset_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">thd_offset</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
    <span class="c1"># third body type</span>
    <span class="n">thd_type_lp</span><span class="p">,</span> <span class="n">thd_type_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">thd_type</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
    <span class="c1"># get next offset to determine num of thd body eff&#39;s in rxnq</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">thd_offset_next_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">thd_offset</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># kernel data</span>
    <span class="n">kernel_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># add problem size</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># add arrays</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">P_arr</span><span class="p">,</span> <span class="n">T_arr</span><span class="p">,</span> <span class="n">concs_lp</span><span class="p">,</span> <span class="n">thd_lp</span><span class="p">,</span> <span class="n">thd_type_lp</span><span class="p">,</span>
                        <span class="n">thd_eff_lp</span><span class="p">,</span> <span class="n">thd_spec_lp</span><span class="p">,</span> <span class="n">thd_offset_lp</span><span class="p">])</span>

    <span class="c1"># maps</span>
    <span class="c1"># extra loops</span>
    <span class="n">extra_inames</span> <span class="o">=</span> <span class="p">[(</span><span class="n">spec_loop</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> &lt;= </span><span class="si">{}</span><span class="s1"> &lt; spec_end&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">spec_offset</span><span class="p">,</span> <span class="n">spec_loop</span><span class="p">))]</span>

    <span class="c1"># generate instructions and sub in instructions</span>
    <span class="n">instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;int32&gt; not_spec = $</span><span class="si">{thd_type}</span><span class="s2"> != $</span><span class="si">{species}</span><span class="s2"></span>
<span class="s2">&lt;&gt; $</span><span class="si">{offset_name}</span><span class="s2"> = $</span><span class="si">{offset}</span><span class="s2"> {id=offset}</span>
<span class="s2">&lt;&gt; spec_end = $</span><span class="si">{offset_next}</span><span class="s2"> {id=num0}</span>
<span class="s2">&lt;&gt; thd_temp = $</span><span class="si">{P_str}</span><span class="s2"> * not_spec / (R * $</span><span class="si">{T_str}</span><span class="s2">) {id=thd1, dep=num0}</span>
<span class="s2">for $</span><span class="si">{spec_loop}</span><span class="s2"></span>
<span class="s2">    &lt;&gt; $</span><span class="si">{spec_ind}</span><span class="s2"> = $</span><span class="si">{thd_spec}</span><span class="s2"> {id=ind1}</span>
<span class="s2">    thd_temp = thd_temp + ($</span><span class="si">{thd_eff}</span><span class="s2"> - not_spec) * $</span><span class="si">{conc_thd_spec}</span><span class="s2"> {id=thdcalc,</span><span class="se">\</span>
<span class="s2">        dep=ind1:thd1}</span>
<span class="s2">end</span>
<span class="s2">$</span><span class="si">{thd_str}</span><span class="s2"> = thd_temp {dep=thd*}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span>
        <span class="n">offset_name</span><span class="o">=</span><span class="n">spec_offset</span><span class="p">,</span>
        <span class="n">offset</span><span class="o">=</span><span class="n">thd_offset_str</span><span class="p">,</span>
        <span class="n">offset_next</span><span class="o">=</span><span class="n">thd_offset_next_str</span><span class="p">,</span>
        <span class="n">thd_eff</span><span class="o">=</span><span class="n">thd_eff_str</span><span class="p">,</span>
        <span class="n">conc_thd_spec</span><span class="o">=</span><span class="n">concs_str</span><span class="p">,</span>
        <span class="n">thd_str</span><span class="o">=</span><span class="n">thd_str</span><span class="p">,</span>
        <span class="n">spec_loop</span><span class="o">=</span><span class="n">spec_loop</span><span class="p">,</span>
        <span class="n">spec_ind</span><span class="o">=</span><span class="n">spec_ind</span><span class="p">,</span>
        <span class="n">thd_spec</span><span class="o">=</span><span class="n">thd_spec_str</span><span class="p">,</span>
        <span class="n">P_str</span><span class="o">=</span><span class="n">P_str</span><span class="p">,</span>
        <span class="n">T_str</span><span class="o">=</span><span class="n">T_str</span><span class="p">,</span>
        <span class="n">thd_type</span><span class="o">=</span><span class="n">thd_type_str</span><span class="p">,</span>
        <span class="n">species</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">thd_body_type</span><span class="o">.</span><span class="n">species</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># create info</span>
    <span class="k">return</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="s1">&#39;eval_thd_body_concs&#39;</span><span class="p">,</span>
                          <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
                          <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                          <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">,</span>
                          <span class="n">extra_inames</span><span class="o">=</span><span class="n">extra_inames</span><span class="p">,</span>
                          <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="n">chem</span><span class="o">.</span><span class="n">RU</span><span class="p">},</span>
                          <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_cheb_arrhenius_rates"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.get_cheb_arrhenius_rates">[docs]</a><span class="k">def</span> <span class="nf">get_cheb_arrhenius_rates</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">maxP</span><span class="p">,</span> <span class="n">maxT</span><span class="p">,</span>
                             <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates instructions, kernel arguements, and data for cheb rate constants</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    maxP : int</span>
<span class="sd">        The maximum degree of pressure polynomials for chebyshev reactions in</span>
<span class="sd">        this mechanism</span>
<span class="sd">    maxT : int</span>
<span class="sd">        The maximum degree of temperature polynomials for chebyshev reactions</span>
<span class="sd">        in this mechanism</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not none, this kernel is being used for testing.</span>
<span class="sd">        Hence we need to size the arrays accordingly</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl_list : list of :class:`knl_info`</span>
<span class="sd">        The generated infos for feeding into the kernel generator</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check for empty map</span>
    <span class="k">if</span> <span class="n">namestore</span><span class="o">.</span><span class="n">cheb_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># create mapper</span>
    <span class="n">mapstore</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_cheb</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>

    <span class="c1"># max degrees in mechanism</span>
    <span class="n">poly_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">maxP</span><span class="p">,</span> <span class="n">maxT</span><span class="p">))</span>

    <span class="c1"># extra inames</span>
    <span class="n">pres_poly_ind</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
    <span class="n">temp_poly_ind</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
    <span class="n">poly_compute_ind</span> <span class="o">=</span> <span class="s1">&#39;p&#39;</span>
    <span class="n">lim_ind</span> <span class="o">=</span> <span class="s1">&#39;dummy&#39;</span>
    <span class="n">extra_inames</span> <span class="o">=</span> <span class="p">[(</span><span class="n">pres_poly_ind</span><span class="p">,</span> <span class="s1">&#39;0 &lt;= </span><span class="si">{}</span><span class="s1"> &lt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">pres_poly_ind</span><span class="p">,</span> <span class="n">maxP</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">temp_poly_ind</span><span class="p">,</span> <span class="s1">&#39;0 &lt;= </span><span class="si">{}</span><span class="s1"> &lt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">temp_poly_ind</span><span class="p">,</span> <span class="n">maxT</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">poly_compute_ind</span><span class="p">,</span> <span class="s1">&#39;2 &lt;= </span><span class="si">{}</span><span class="s1"> &lt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">poly_compute_ind</span><span class="p">,</span> <span class="n">poly_max</span><span class="p">))]</span>

    <span class="c1"># create arrays</span>

    <span class="c1"># kf is based on the map</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">kf</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">cheb_map</span><span class="p">)</span>

    <span class="n">num_P_lp</span><span class="p">,</span> <span class="n">num_P_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_numP</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
    <span class="n">num_T_lp</span><span class="p">,</span> <span class="n">num_T_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_numT</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
    <span class="n">params_lp</span><span class="p">,</span> <span class="n">params_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_params</span><span class="p">,</span>
                                                <span class="n">var_name</span><span class="p">,</span>
                                                <span class="n">temp_poly_ind</span><span class="p">,</span>
                                                <span class="n">pres_poly_ind</span><span class="p">)</span>
    <span class="n">plim_lp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_Plim</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">lim_ind</span><span class="p">)</span>
    <span class="n">tlim_lp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_Tlim</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">lim_ind</span><span class="p">)</span>

    <span class="c1"># workspace vars are based only on their polynomial indicies</span>
    <span class="n">pres_poly_lp</span><span class="p">,</span> <span class="n">ppoly_k_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_pres_poly</span><span class="p">,</span>
                                                    <span class="n">pres_poly_ind</span><span class="p">)</span>
    <span class="n">temp_poly_lp</span><span class="p">,</span> <span class="n">tpoly_m_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_temp_poly</span><span class="p">,</span>
                                                    <span class="n">temp_poly_ind</span><span class="p">)</span>

    <span class="c1"># create temperature and pressure arrays</span>
    <span class="n">T_arr</span><span class="p">,</span> <span class="n">T_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">T_arr</span><span class="p">,</span> <span class="n">global_ind</span><span class="p">)</span>
    <span class="n">P_arr</span><span class="p">,</span> <span class="n">P_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">P_arr</span><span class="p">,</span> <span class="n">global_ind</span><span class="p">)</span>

    <span class="c1"># get the forward rate constants</span>
    <span class="n">kf_arr</span><span class="p">,</span> <span class="n">kf_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">kf</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="c1"># update kernel data</span>
    <span class="n">kernel_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># add problem size</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">params_lp</span><span class="p">,</span> <span class="n">num_P_lp</span><span class="p">,</span> <span class="n">num_T_lp</span><span class="p">,</span> <span class="n">plim_lp</span><span class="p">,</span> <span class="n">tlim_lp</span><span class="p">,</span>
                        <span class="n">pres_poly_lp</span><span class="p">,</span> <span class="n">temp_poly_lp</span><span class="p">,</span> <span class="n">T_arr</span><span class="p">,</span> <span class="n">P_arr</span><span class="p">,</span> <span class="n">kf_arr</span><span class="p">])</span>

    <span class="c1"># preinstructions</span>
    <span class="n">logP</span> <span class="o">=</span> <span class="s1">&#39;logP&#39;</span>
    <span class="n">Tinv</span> <span class="o">=</span> <span class="s1">&#39;Tinv&#39;</span>
    <span class="c1"># create a precomputed instruction generator</span>
    <span class="n">precompute</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">PrecomputedInstructions</span><span class="p">()</span>

    <span class="n">preinstructs</span> <span class="o">=</span> <span class="p">[</span><span class="n">precompute</span><span class="p">(</span><span class="n">logP</span><span class="p">,</span> <span class="n">P_str</span><span class="p">,</span> <span class="s1">&#39;LOG&#39;</span><span class="p">),</span>
                    <span class="n">precompute</span><span class="p">(</span><span class="n">Tinv</span><span class="p">,</span> <span class="n">T_str</span><span class="p">,</span> <span class="s1">&#39;INV&#39;</span><span class="p">)]</span>

    <span class="c1"># various strings for preindexed limits, params, etc</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">Pmin_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_Plim</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">Pmax_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_Plim</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">Tmin_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_Tlim</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">Tmax_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_Tlim</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">ppoly0_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_pres_poly</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ppoly1_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_pres_poly</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ppolyp_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_pres_poly</span><span class="p">,</span>
                                        <span class="n">poly_compute_ind</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ppolypm1_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_pres_poly</span><span class="p">,</span>
                                          <span class="n">poly_compute_ind</span><span class="p">,</span>
                                          <span class="n">affine</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ppolypm2_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_pres_poly</span><span class="p">,</span>
                                          <span class="n">poly_compute_ind</span><span class="p">,</span>
                                          <span class="n">affine</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">tpoly0_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_temp_poly</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">tpoly1_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_temp_poly</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">tpolyp_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_temp_poly</span><span class="p">,</span>
                                        <span class="n">poly_compute_ind</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">tpolypm1_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_temp_poly</span><span class="p">,</span>
                                          <span class="n">poly_compute_ind</span><span class="p">,</span>
                                          <span class="n">affine</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">tpolypm2_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">cheb_temp_poly</span><span class="p">,</span>
                                          <span class="n">poly_compute_ind</span><span class="p">,</span>
                                          <span class="n">affine</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">exp10fun</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">exp_10_fun</span><span class="p">[</span><span class="n">loopy_opts</span><span class="o">.</span><span class="n">lang</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="s1">&#39;kf_temp&#39;</span><span class="p">)</span>

    <span class="n">instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;&gt;Pmin = $</span><span class="si">{Pmin_str}</span><span class="s2"></span>
<span class="s2">&lt;&gt;Tmin = $</span><span class="si">{Tmin_str}</span><span class="s2"></span>
<span class="s2">&lt;&gt;Pmax = $</span><span class="si">{Pmax_str}</span><span class="s2"></span>
<span class="s2">&lt;&gt;Tmax = $</span><span class="si">{Tmax_str}</span><span class="s2"></span>
<span class="s2">&lt;&gt;Tred = (-Tmax - Tmin + 2 * $</span><span class="si">{Tinv}</span><span class="s2">) / (Tmax - Tmin)</span>
<span class="s2">&lt;&gt;Pred = (-Pmax - Pmin + 2 * $</span><span class="si">{logP}</span><span class="s2">) / (Pmax - Pmin)</span>
<span class="s2">&lt;&gt;numP = $</span><span class="si">{num_P_str}</span><span class="s2"> {id=plim}</span>
<span class="s2">&lt;&gt;numT = $</span><span class="si">{num_T_str}</span><span class="s2"> {id=tlim}</span>
<span class="s2">$</span><span class="si">{ppoly0_str}</span><span class="s2"> = 1 {id=ppoly_init}</span>
<span class="s2">$</span><span class="si">{ppoly1_str}</span><span class="s2"> = Pred {id=ppoly_init1}</span>
<span class="s2">$</span><span class="si">{tpoly0_str}</span><span class="s2"> = 1 {id=tpoly_init}</span>
<span class="s2">$</span><span class="si">{tpoly1_str}</span><span class="s2"> = Tred {id=tpoly_init2}</span>
<span class="s2">#&lt;&gt; poly_end = max(numP, numT)</span>
<span class="s2"># compute polynomial terms</span>
<span class="s2">for p</span>
<span class="s2">    if p &lt; numP</span>
<span class="s2">        $</span><span class="si">{ppolyp_str}</span><span class="s2"> = 2 * Pred * $</span><span class="si">{ppolypm1_str}</span><span class="s2"> - $</span><span class="si">{ppolypm2_str}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">            {id=ppoly, dep=plim:ppoly_init*}</span>
<span class="s2">    end</span>
<span class="s2">    if p &lt; numT</span>
<span class="s2">        $</span><span class="si">{tpolyp_str}</span><span class="s2"> = 2 * Tred * $</span><span class="si">{tpolypm1_str}</span><span class="s2"> - $</span><span class="si">{tpolypm2_str}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">            {id=tpoly, dep=tlim:tpoly_init*}</span>
<span class="s2">    end</span>
<span class="s2">end</span>
<span class="s2">&lt;&gt; kf_temp = 0 {id=kf_init}</span>
<span class="s2">for m</span>
<span class="s2">    &lt;&gt;temp = 0 {id=temp_init}</span>
<span class="s2">    for k</span>
<span class="s2">        if k &lt; numP</span>
<span class="s2">            temp = temp + $</span><span class="si">{ppoly_k_str}</span><span class="s2"> * $</span><span class="si">{params_str}</span><span class="s2"> {id=temp,</span>
<span class="s2">                dep=ppoly:tpoly:kf_init:temp_init}</span>
<span class="s2">        end</span>
<span class="s2">    end</span>
<span class="s2">    if m &lt; numT</span>
<span class="s2">        kf_temp = kf_temp + $</span><span class="si">{tpoly_m_str}</span><span class="s2"> * temp {id=kf, dep=temp:kf_init}</span>
<span class="s2">    end</span>
<span class="s2">end</span>

<span class="s2">$</span><span class="si">{kf_str}</span><span class="s2"> = $</span><span class="si">{exp10fun}</span><span class="s2"> {id=set, dep=kf}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="n">instructions</span> <span class="o">=</span> <span class="n">instructions</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
    <span class="n">vec_spec</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">write_race_silencer</span><span class="p">([</span><span class="s1">&#39;set&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="s1">&#39;rateconst_cheb&#39;</span><span class="p">,</span>
                          <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
                          <span class="n">pre_instructions</span><span class="o">=</span><span class="n">preinstructs</span><span class="p">,</span>
                          <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                          <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">,</span>
                          <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                          <span class="n">extra_inames</span><span class="o">=</span><span class="n">extra_inames</span><span class="p">,</span>
                          <span class="n">vectorization_specializer</span><span class="o">=</span><span class="n">vec_spec</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_plog_arrhenius_rates"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.get_plog_arrhenius_rates">[docs]</a><span class="k">def</span> <span class="nf">get_plog_arrhenius_rates</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">maxP</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates instructions, kernel arguements, and data for p-log rate constants</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    maxP : int</span>
<span class="sd">        The maximum number of pressure interpolations of any reaction in</span>
<span class="sd">        the mechanism.</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not none, this kernel is being used for testing.</span>
<span class="sd">        Hence we need to size the arrays accordingly</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl_list : list of :class:`knl_info`</span>
<span class="sd">        The generated infos for feeding into the kernel generator</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check for empty plog (if so, return empty)</span>
    <span class="k">if</span> <span class="n">namestore</span><span class="o">.</span><span class="n">plog_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># parameter indicies</span>
    <span class="n">arrhen_ind</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
    <span class="n">param_ind</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
    <span class="n">lo_ind</span> <span class="o">=</span> <span class="s1">&#39;lo_ind&#39;</span>
    <span class="n">hi_ind</span> <span class="o">=</span> <span class="s1">&#39;hi_ind&#39;</span>

    <span class="c1"># create mapper</span>
    <span class="n">mapstore</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">plog_map</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>

    <span class="c1"># number of parameter sets per reaction</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">plog_num_param</span><span class="p">,</span>
                                     <span class="n">namestore</span><span class="o">.</span><span class="n">num_plog</span><span class="p">)</span>

    <span class="c1"># plog parameters</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">plog_params</span><span class="p">,</span>
                                     <span class="n">namestore</span><span class="o">.</span><span class="n">num_plog</span><span class="p">)</span>
    <span class="c1"># fwd rate constants</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">kf</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">plog_map</span><span class="p">)</span>

    <span class="n">plog_num_param_lp</span><span class="p">,</span> <span class="n">plog_num_param_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">plog_num_param</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
    <span class="n">plog_params_lp</span><span class="p">,</span> <span class="n">plog_params_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">plog_params</span><span class="p">,</span> <span class="n">arrhen_ind</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">param_ind</span><span class="p">)</span>

    <span class="c1"># temperature / pressure arrays</span>
    <span class="n">T_arr</span><span class="p">,</span> <span class="n">T_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">T_arr</span><span class="p">,</span> <span class="n">global_ind</span><span class="p">)</span>
    <span class="n">P_arr</span><span class="p">,</span> <span class="n">P_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">P_arr</span><span class="p">,</span> <span class="n">global_ind</span><span class="p">)</span>

    <span class="c1"># create temporary storage variables</span>
    <span class="n">low_lp</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">TemporaryVariable</span><span class="p">(</span>
        <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,),</span> <span class="n">scope</span><span class="o">=</span><span class="n">scopes</span><span class="o">.</span><span class="n">PRIVATE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">hi_lp</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">TemporaryVariable</span><span class="p">(</span>
        <span class="s1">&#39;hi&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,),</span> <span class="n">scope</span><span class="o">=</span><span class="n">scopes</span><span class="o">.</span><span class="n">PRIVATE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1"># forward rxn rate constants</span>
    <span class="n">kf_arr</span><span class="p">,</span> <span class="n">kf_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">kf</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="c1"># data</span>
    <span class="n">kernel_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># add problem size</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># update kernel data</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">plog_params_lp</span><span class="p">,</span> <span class="n">plog_num_param_lp</span><span class="p">,</span> <span class="n">T_arr</span><span class="p">,</span>
                        <span class="n">P_arr</span><span class="p">,</span> <span class="n">low_lp</span><span class="p">,</span> <span class="n">hi_lp</span><span class="p">,</span> <span class="n">kf_arr</span><span class="p">])</span>
    <span class="c1"># extra loops</span>
    <span class="n">extra_inames</span> <span class="o">=</span> <span class="p">[(</span><span class="n">param_ind</span><span class="p">,</span> <span class="s1">&#39;0 &lt;= </span><span class="si">{}</span><span class="s1"> &lt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param_ind</span><span class="p">,</span> <span class="n">maxP</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
                    <span class="p">(</span><span class="n">arrhen_ind</span><span class="p">,</span> <span class="s1">&#39;0 &lt;= </span><span class="si">{}</span><span class="s1"> &lt; 4&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arrhen_ind</span><span class="p">))]</span>

    <span class="c1"># specific indexing strings</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">pressure_lo</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">plog_params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">pressure_hi</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">plog_params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="s1">&#39;numP&#39;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">pressure_mid_lo</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">plog_params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">param_ind</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">pressure_mid_hi</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">plog_params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">param_ind</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="p">{</span><span class="n">param_ind</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">pressure_general_lo</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">plog_params</span><span class="p">,</span> <span class="n">arrhen_ind</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">lo_ind</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">pressure_general_hi</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span>
        <span class="n">namestore</span><span class="o">.</span><span class="n">plog_params</span><span class="p">,</span> <span class="n">arrhen_ind</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">hi_ind</span><span class="p">)</span>

    <span class="c1"># precompute names</span>
    <span class="n">logP</span> <span class="o">=</span> <span class="s1">&#39;logP&#39;</span>
    <span class="n">logT</span> <span class="o">=</span> <span class="s1">&#39;logT&#39;</span>
    <span class="n">Tinv</span> <span class="o">=</span> <span class="s1">&#39;Tinv&#39;</span>

    <span class="c1"># instructions</span>
    <span class="n">instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &lt;&gt;lower = ${logP} &lt;= ${pressure_lo} # check below range</span>
<span class="sd">        if lower</span>
<span class="sd">            &lt;&gt;lo_ind = 0 {id=ind00, nosync=ind10}</span>
<span class="sd">            &lt;&gt;hi_ind = 0 {id=ind01, nosync=ind11}</span>
<span class="sd">        end</span>
<span class="sd">        &lt;&gt;numP = ${plog_num_param_str} - 1</span>
<span class="sd">        &lt;&gt;upper = ${logP} &gt; ${pressure_hi} # check above range</span>
<span class="sd">        if upper</span>
<span class="sd">            lo_ind = numP {id=ind10, nosync=ind00}</span>
<span class="sd">            hi_ind = numP {id=ind11, nosync=ind01}</span>
<span class="sd">        end</span>
<span class="sd">        &lt;&gt;oor = lower or upper</span>
<span class="sd">        for k</span>
<span class="sd">            # check that</span>
<span class="sd">            # 1. inside this reactions parameter&#39;s still</span>
<span class="sd">            # 2. inside pressure range</span>
<span class="sd">            &lt;&gt; midcheck = (k &lt; numP) and (${logP} &gt; ${pressure_mid_lo}) \</span>
<span class="sd">                and (${logP} &lt;= ${pressure_mid_hi})</span>
<span class="sd">            if midcheck</span>
<span class="sd">                lo_ind = k {id=ind20, dep=ind10:ind00}</span>
<span class="sd">                hi_ind = k + 1 {id=ind21, dep=ind11:ind01}</span>
<span class="sd">            end</span>
<span class="sd">        end</span>
<span class="sd">        # load pressure and reaction parameters into temp arrays</span>
<span class="sd">        for m</span>
<span class="sd">            low[m] = ${pressure_general_lo} {id=lo, dep=ind*}</span>
<span class="sd">            hi[m] = ${pressure_general_hi} {id=hi, dep=ind*}</span>
<span class="sd">        end</span>
<span class="sd">        # eval logkf&#39;s</span>
<span class="sd">        &lt;&gt;logk1 = low[1] + ${logT} * low[2] - low[3] * ${Tinv}  {id=a1, dep=lo}</span>
<span class="sd">        &lt;&gt;logk2 = hi[1] + ${logT} * hi[2] - hi[3] * ${Tinv} {id=a2, dep=hi}</span>
<span class="sd">        &lt;&gt;kf_temp = logk1 {id=a_oor}</span>
<span class="sd">        if not oor</span>
<span class="sd">            # if not out of bounds, compute interpolant</span>
<span class="sd">            kf_temp = (-logk1 + logk2) * (${logP} - low[0]) / (hi[0] - low[0]) + \</span>
<span class="sd">                kf_temp {id=a_found, dep=a1:a2:a_oor}</span>
<span class="sd">        end</span>
<span class="sd">        ${kf_str} = exp(kf_temp) {id=kf, dep=a_found}</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>

    <span class="n">vec_spec</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">write_race_silencer</span><span class="p">([</span><span class="s1">&#39;kf&#39;</span><span class="p">])</span>

    <span class="c1"># create a precomputed instruction generator</span>
    <span class="n">precompute</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">PrecomputedInstructions</span><span class="p">()</span>

    <span class="c1"># and return</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;rateconst_plog&#39;</span><span class="p">,</span>
                           <span class="n">instructions</span><span class="o">=</span><span class="n">instructions</span><span class="p">,</span>
                           <span class="n">pre_instructions</span><span class="o">=</span><span class="p">[</span>
                               <span class="n">precompute</span><span class="p">(</span><span class="n">Tinv</span><span class="p">,</span> <span class="n">T_str</span><span class="p">,</span> <span class="s1">&#39;INV&#39;</span><span class="p">),</span>
                               <span class="n">precompute</span><span class="p">(</span><span class="n">logT</span><span class="p">,</span> <span class="n">T_str</span><span class="p">,</span> <span class="s1">&#39;LOG&#39;</span><span class="p">),</span>
                               <span class="n">precompute</span><span class="p">(</span><span class="n">logP</span><span class="p">,</span> <span class="n">P_str</span><span class="p">,</span> <span class="s1">&#39;LOG&#39;</span><span class="p">)],</span>
                           <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                           <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">,</span>
                           <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                           <span class="n">extra_inames</span><span class="o">=</span><span class="n">extra_inames</span><span class="p">,</span>
                           <span class="n">vectorization_specializer</span><span class="o">=</span><span class="n">vec_spec</span><span class="p">,</span>
                           <span class="c1"># silence warning about scatter load of plog parameters</span>
                           <span class="c1"># due to varying pressure</span>
                           <span class="n">silenced_warnings</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;vectorize_failed&#39;</span><span class="p">])]</span></div>


<div class="viewcode-block" id="get_reduced_pressure_kernel"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.get_reduced_pressure_kernel">[docs]</a><span class="k">def</span> <span class="nf">get_reduced_pressure_kernel</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates instructions, kernel arguements, and data for the reduced</span>
<span class="sd">    pressure evaluation kernel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not none, this kernel is being used for testing.</span>
<span class="sd">        Hence we need to size the arrays accordingly</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl_list : list of :class:`knl_info`</span>
<span class="sd">        The generated infos for feeding into the kernel generator</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check for empty</span>
    <span class="k">if</span> <span class="n">namestore</span><span class="o">.</span><span class="n">fall_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># create the mapper</span>
    <span class="n">mapstore</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">fall_map</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>

    <span class="c1"># create the various necessary arrays</span>

    <span class="n">kernel_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># add problem size</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>
    <span class="c1"># add maps / masks</span>

    <span class="c1"># kf is over all reactions</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">kf</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">fall_map</span><span class="p">)</span>
    <span class="c1"># kf_fall / Pr / fall type are over falloff reactions</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">kf_fall</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_fall</span><span class="p">)</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">Pr</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_fall</span><span class="p">)</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">fall_type</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_fall</span><span class="p">)</span>
    <span class="c1"># third body concentrations are over thd_map</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">fall_to_thd_map</span><span class="p">,</span>
                                     <span class="n">namestore</span><span class="o">.</span><span class="n">num_fall</span><span class="p">)</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">thd_conc</span><span class="p">,</span>
                                     <span class="n">namestore</span><span class="o">.</span><span class="n">fall_to_thd_map</span><span class="p">)</span>

    <span class="c1"># simple arrhenius rates</span>
    <span class="n">kf_arr</span><span class="p">,</span> <span class="n">kf_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">kf</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>
    <span class="c1"># simple arrhenius rates using falloff (alternate) parameters</span>
    <span class="n">kf_fall_arr</span><span class="p">,</span> <span class="n">kf_fall_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">kf_fall</span><span class="p">,</span>
                                                   <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="c1"># temperatures</span>
    <span class="n">T_arr</span><span class="p">,</span> <span class="n">T_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">T_arr</span><span class="p">,</span> <span class="n">global_ind</span><span class="p">)</span>

    <span class="c1"># create a Pr array</span>
    <span class="n">Pr_arr</span><span class="p">,</span> <span class="n">Pr_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">Pr</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="c1"># third-body concentration</span>
    <span class="n">thd_conc_lp</span><span class="p">,</span> <span class="n">thd_conc_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">thd_conc</span><span class="p">,</span>
                                                    <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>
    <span class="c1"># and finally the falloff types</span>
    <span class="n">fall_type_lp</span><span class="p">,</span> <span class="n">fall_type_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">fall_type</span><span class="p">,</span>
                                                      <span class="n">var_name</span><span class="p">)</span>

    <span class="c1"># append all arrays to the kernel data</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">T_arr</span><span class="p">,</span> <span class="n">thd_conc_lp</span><span class="p">,</span> <span class="n">kf_arr</span><span class="p">,</span> <span class="n">kf_fall_arr</span><span class="p">,</span> <span class="n">Pr_arr</span><span class="p">,</span>
                        <span class="n">fall_type_lp</span><span class="p">])</span>

    <span class="c1"># create instruction set</span>
    <span class="n">pr_instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">if $</span><span class="si">{fall_type_str}</span><span class="s2"></span>
<span class="s2">    # chemically activated</span>
<span class="s2">    &lt;&gt;k0 = $</span><span class="si">{kf_str}</span><span class="s2"> {id=k0_c, nosync=k0_f}</span>
<span class="s2">    &lt;&gt;kinf = $</span><span class="si">{kf_fall_str}</span><span class="s2"> {id=kinf_c, nosync=kinf_f}</span>
<span class="s2">else</span>
<span class="s2">    # fall-off</span>
<span class="s2">    kinf = $</span><span class="si">{kf_str}</span><span class="s2"> {id=kinf_f, nosync=kinf_c}</span>
<span class="s2">    k0 = $</span><span class="si">{kf_fall_str}</span><span class="s2"> {id=k0_f, nosync=k0_c}</span>
<span class="s2">end</span>
<span class="s2"># prevent reduced pressure from ever being truly zero</span>
<span class="s2">$</span><span class="si">{Pr_str}</span><span class="s2"> = fmax(1e-300d, $</span><span class="si">{thd_conc_str}</span><span class="s2"> * k0 / kinf) {id=set, dep=k*}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># sub in strings</span>
    <span class="n">pr_instructions</span> <span class="o">=</span> <span class="n">pr_instructions</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
    <span class="n">vec_spec</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">write_race_silencer</span><span class="p">([</span><span class="s1">&#39;set&#39;</span><span class="p">])</span>

    <span class="c1"># and finally return the resulting info</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="s1">&#39;red_pres&#39;</span><span class="p">,</span>
                           <span class="n">instructions</span><span class="o">=</span><span class="n">pr_instructions</span><span class="p">,</span>
                           <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                           <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">,</span>
                           <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                           <span class="n">vectorization_specializer</span><span class="o">=</span><span class="n">vec_spec</span><span class="p">,</span>
                           <span class="n">manglers</span><span class="o">=</span><span class="p">[</span><span class="n">lp_pregen</span><span class="o">.</span><span class="n">fmax</span><span class="p">()])]</span></div>


<div class="viewcode-block" id="get_troe_kernel"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.get_troe_kernel">[docs]</a><span class="k">def</span> <span class="nf">get_troe_kernel</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates instructions, kernel arguements, and data for the Troe</span>
<span class="sd">    falloff evaluation kernel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not none, this kernel is being used for testing.</span>
<span class="sd">        Hence we need to size the arrays accordingly</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl_list : list of :class:`knl_info`</span>
<span class="sd">        The generated infos for feeding into the kernel generator</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check for empty</span>
    <span class="k">if</span> <span class="n">namestore</span><span class="o">.</span><span class="n">troe_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># rate info and reac ind</span>
    <span class="n">kernel_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># create mapper</span>
    <span class="n">mapstore</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_troe</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>

    <span class="c1"># add problem size</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># add maps / masks</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">Fi</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">troe_map</span><span class="p">)</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">Pr</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">troe_map</span><span class="p">)</span>

    <span class="c1"># create the Pr loopy array / string</span>
    <span class="n">Pr_lp</span><span class="p">,</span> <span class="n">Pr_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">Pr</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="c1"># create Fi loopy array / string</span>
    <span class="n">Fi_lp</span><span class="p">,</span> <span class="n">Fi_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">Fi</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="c1"># create the Fcent loopy array / str</span>
    <span class="n">Fcent_lp</span><span class="p">,</span> <span class="n">Fcent_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">Fcent</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="c1"># create the Atroe loopy array / str</span>
    <span class="n">Atroe_lp</span><span class="p">,</span> <span class="n">Atroe_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">Atroe</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="c1"># create the Btroe loopy array / str</span>
    <span class="n">Btroe_lp</span><span class="p">,</span> <span class="n">Btroe_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">Btroe</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="c1"># create the temperature array</span>
    <span class="n">T_lp</span><span class="p">,</span> <span class="n">T_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">T_arr</span><span class="p">,</span> <span class="n">global_ind</span><span class="p">)</span>

    <span class="c1"># update the kernel_data</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">Pr_lp</span><span class="p">,</span> <span class="n">T_lp</span><span class="p">,</span> <span class="n">Fi_lp</span><span class="p">,</span> <span class="n">Fcent_lp</span><span class="p">,</span> <span class="n">Atroe_lp</span><span class="p">,</span> <span class="n">Btroe_lp</span><span class="p">])</span>

    <span class="c1"># get troe params and create arrays</span>
    <span class="n">troe_a_lp</span><span class="p">,</span> <span class="n">troe_a_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">troe_a</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
    <span class="n">troe_T3_lp</span><span class="p">,</span> <span class="n">troe_T3_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">troe_T3</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
    <span class="n">troe_T1_lp</span><span class="p">,</span> <span class="n">troe_T1_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">troe_T1</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
    <span class="n">troe_T2_lp</span><span class="p">,</span> <span class="n">troe_T2_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">troe_T2</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
    <span class="c1"># update the kernel_data</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">troe_a_lp</span><span class="p">,</span> <span class="n">troe_T3_lp</span><span class="p">,</span> <span class="n">troe_T1_lp</span><span class="p">,</span> <span class="n">troe_T2_lp</span><span class="p">])</span>

    <span class="c1"># get generic power function</span>
    <span class="n">power_func</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">power_function</span><span class="p">(</span><span class="n">loopy_opts</span><span class="o">.</span><span class="n">lang</span><span class="p">,</span> <span class="n">is_integer_power</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">is_positive_power</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># make the instructions</span>
    <span class="n">troe_instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;&gt;Fcent_temp = $</span><span class="si">{troe_a_str}</span><span class="s2"> * exp(-T * $</span><span class="si">{troe_T1_str}</span><span class="s2">) </span><span class="se">\</span>
<span class="s2">        + (1 - $</span><span class="si">{troe_a_str}</span><span class="s2">) * exp(-T * $</span><span class="si">{troe_T3_str}</span><span class="s2">) {id=Fcent_decl}</span>
<span class="s2">    if $</span><span class="si">{troe_T2_str}</span><span class="s2"> != 0</span>
<span class="s2">        Fcent_temp = Fcent_temp + exp(-$</span><span class="si">{troe_T2_str}</span><span class="s2"> / T) </span><span class="se">\</span>
<span class="s2">            {id=Fcent_decl2, dep=Fcent_decl}</span>
<span class="s2">    end</span>
<span class="s2">    $</span><span class="si">{Fcent_str}</span><span class="s2"> = Fcent_temp {id=Fcent_decl3, dep=Fcent_decl2}</span>
<span class="s2">    &lt;&gt;logFcent = log10(fmax(1e-300d, Fcent_temp)) {dep=Fcent_decl3}</span>
<span class="s2">    &lt;&gt;logPr = log10(fmax(1e-300d, $</span><span class="si">{Pr_str}</span><span class="s2">))</span>
<span class="s2">    &lt;&gt;Atroe_temp = -0.67 * logFcent + logPr - 0.4 {dep=Fcent_decl*}</span>
<span class="s2">    &lt;&gt;Btroe_temp = -1.1762 * logFcent - 0.14 * logPr + 0.806 {dep=Fcent_decl*}</span>
<span class="s2">    $</span><span class="si">{Atroe_str}</span><span class="s2"> = Atroe_temp</span>
<span class="s2">    $</span><span class="si">{Btroe_str}</span><span class="s2"> = Btroe_temp</span>
<span class="s2">    $</span><span class="si">{Fi_str}</span><span class="s2"> = $</span><span class="si">{power_func}</span><span class="s2">(Fcent_temp, (1 / (((Atroe_temp * Atroe_temp) / </span><span class="se">\</span>
<span class="s2">        (Btroe_temp * Btroe_temp) + 1)))) {id=Fi, dep=Fcent_decl*}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>

    <span class="n">vec_spec</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">write_race_silencer</span><span class="p">([</span><span class="s1">&#39;Fi&#39;</span><span class="p">])</span>
    <span class="c1"># create a precomputed instruction generator</span>
    <span class="n">precompute</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">PrecomputedInstructions</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="s1">&#39;fall_troe&#39;</span><span class="p">,</span>
                           <span class="n">pre_instructions</span><span class="o">=</span><span class="p">[</span><span class="n">precompute</span><span class="p">(</span>
                               <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">T_str</span><span class="p">,</span> <span class="s1">&#39;VAL&#39;</span><span class="p">)],</span>
                           <span class="n">instructions</span><span class="o">=</span><span class="n">troe_instructions</span><span class="p">,</span>
                           <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                           <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">,</span>
                           <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                           <span class="n">vectorization_specializer</span><span class="o">=</span><span class="n">vec_spec</span><span class="p">,</span>
                           <span class="n">manglers</span><span class="o">=</span><span class="p">[</span><span class="n">lp_pregen</span><span class="o">.</span><span class="n">fmax</span><span class="p">()]</span> <span class="o">+</span>
                           <span class="n">lp_pregen</span><span class="o">.</span><span class="n">power_function_manglers</span><span class="p">(</span>
                                        <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">power_func</span><span class="p">),</span>
                           <span class="n">preambles</span><span class="o">=</span><span class="n">lp_pregen</span><span class="o">.</span><span class="n">power_function_preambles</span><span class="p">(</span>
                                <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">power_func</span><span class="p">))]</span></div>


<div class="viewcode-block" id="get_sri_kernel"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.get_sri_kernel">[docs]</a><span class="k">def</span> <span class="nf">get_sri_kernel</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates instructions, kernel arguements, and data for the SRI</span>
<span class="sd">    falloff evaluation kernel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not none, this kernel is being used for testing.</span>
<span class="sd">        Hence we need to size the arrays accordingly</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl_list : list of :class:`knl_info`</span>
<span class="sd">        The generated infos for feeding into the kernel generator</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check for empty</span>
    <span class="k">if</span> <span class="n">namestore</span><span class="o">.</span><span class="n">sri_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">kernel_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># create mapper</span>
    <span class="n">mapstore</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_sri</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>

    <span class="c1"># add problem size</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># maps and transforms</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">Fi</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">sri_map</span><span class="p">)</span>
    <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">Pr</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">sri_map</span><span class="p">)</span>

    <span class="c1"># Create the temperature array</span>
    <span class="n">T_arr</span><span class="p">,</span> <span class="n">T_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">T_arr</span><span class="p">,</span> <span class="n">global_ind</span><span class="p">)</span>

    <span class="c1"># create Fi array / mapping</span>
    <span class="n">Fi_lp</span><span class="p">,</span> <span class="n">Fi_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">Fi</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>
    <span class="c1"># and Pri array / mapping</span>
    <span class="n">Pr_lp</span><span class="p">,</span> <span class="n">Pr_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">Pr</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">T_arr</span><span class="p">,</span> <span class="n">Fi_lp</span><span class="p">,</span> <span class="n">Pr_lp</span><span class="p">])</span>

    <span class="c1"># create SRI parameters</span>
    <span class="n">X_sri_lp</span><span class="p">,</span> <span class="n">X_sri_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">X_sri</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>
    <span class="n">sri_a_lp</span><span class="p">,</span> <span class="n">sri_a_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">sri_a</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
    <span class="n">sri_b_lp</span><span class="p">,</span> <span class="n">sri_b_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">sri_b</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
    <span class="n">sri_c_lp</span><span class="p">,</span> <span class="n">sri_c_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">sri_c</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
    <span class="n">sri_d_lp</span><span class="p">,</span> <span class="n">sri_d_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">sri_d</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
    <span class="n">sri_e_lp</span><span class="p">,</span> <span class="n">sri_e_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">sri_e</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>

    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
        <span class="p">[</span><span class="n">X_sri_lp</span><span class="p">,</span> <span class="n">sri_a_lp</span><span class="p">,</span> <span class="n">sri_b_lp</span><span class="p">,</span> <span class="n">sri_c_lp</span><span class="p">,</span> <span class="n">sri_d_lp</span><span class="p">,</span> <span class="n">sri_e_lp</span><span class="p">])</span>

    <span class="c1"># precomputes</span>
    <span class="n">Tinv</span> <span class="o">=</span> <span class="s1">&#39;Tinv&#39;</span>
    <span class="n">Tval</span> <span class="o">=</span> <span class="s1">&#39;Tval&#39;</span>

    <span class="c1"># get generic power function</span>
    <span class="n">pos_power_func</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">power_function</span><span class="p">(</span><span class="n">loopy_opts</span><span class="o">.</span><span class="n">lang</span><span class="p">,</span> <span class="n">is_integer_power</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">is_positive_power</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">gen_power_func</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">power_function</span><span class="p">(</span><span class="n">loopy_opts</span><span class="o">.</span><span class="n">lang</span><span class="p">,</span>
                                          <span class="n">is_positive_power</span><span class="o">=</span><span class="nb">isinstance</span><span class="p">(</span>
                                            <span class="n">sri_e_lp</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">))</span>

    <span class="c1"># create instruction set</span>
    <span class="n">sri_instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;&gt;logPr = log10(fmax(1e-300d, $</span><span class="si">{Pr_str}</span><span class="s2">))</span>
<span class="s2">    &lt;&gt;X_temp = 1 / (logPr * logPr + 1) {id=X_decl}</span>
<span class="s2">    &lt;&gt;Fi_temp = $</span><span class="si">{pos_power_func}</span><span class="s2">(($</span><span class="si">{sri_a_str}</span><span class="s2"> * exp(-$</span><span class="si">{sri_b_str}</span><span class="s2"> * $</span><span class="si">{Tinv}</span><span class="s2">) + </span><span class="se">\</span>
<span class="s2">        exp(-$</span><span class="si">{Tval}</span><span class="s2"> / $</span><span class="si">{sri_c_str}</span><span class="s2">)), X_temp) {id=Fi_decl, dep=X_decl}</span>
<span class="s2">    if $</span><span class="si">{sri_d_str}</span><span class="s2"> != 1.0</span>
<span class="s2">        Fi_temp = Fi_temp * $</span><span class="si">{sri_d_str}</span><span class="s2"> {id=Fi_decl1, dep=Fi_decl}</span>
<span class="s2">    end</span>
<span class="s2">    if $</span><span class="si">{sri_e_str}</span><span class="s2"> != 0.0</span>
<span class="s2">        Fi_temp = Fi_temp * $</span><span class="si">{gen_power_func}</span><span class="s2">($</span><span class="si">{Tval}</span><span class="s2">, $</span><span class="si">{sri_e_str}</span><span class="s2">) </span><span class="se">\</span>
<span class="s2">            {id=Fi_decl2, dep=Fi_decl1}</span>
<span class="s2">    end</span>
<span class="s2">    $</span><span class="si">{Fi_str}</span><span class="s2"> = Fi_temp {dep=Fi_decl*}</span>
<span class="s2">    $</span><span class="si">{X_sri_str}</span><span class="s2"> = X_temp</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
    <span class="c1"># create a precomputed instruction generator</span>
    <span class="n">precompute</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">PrecomputedInstructions</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="s1">&#39;fall_sri&#39;</span><span class="p">,</span>
                           <span class="n">instructions</span><span class="o">=</span><span class="n">sri_instructions</span><span class="p">,</span>
                           <span class="n">pre_instructions</span><span class="o">=</span><span class="p">[</span>
                               <span class="n">precompute</span><span class="p">(</span><span class="n">Tval</span><span class="p">,</span> <span class="n">T_str</span><span class="p">,</span> <span class="s1">&#39;VAL&#39;</span><span class="p">),</span>
                               <span class="n">precompute</span><span class="p">(</span><span class="n">Tinv</span><span class="p">,</span> <span class="n">T_str</span><span class="p">,</span> <span class="s1">&#39;INV&#39;</span><span class="p">)],</span>
                           <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                           <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">,</span>
                           <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                           <span class="n">manglers</span><span class="o">=</span><span class="p">[</span><span class="n">lp_pregen</span><span class="o">.</span><span class="n">fmax</span><span class="p">()]</span> <span class="o">+</span>
                           <span class="n">lp_pregen</span><span class="o">.</span><span class="n">power_function_manglers</span><span class="p">(</span>
                               <span class="n">loopy_opts</span><span class="p">,</span> <span class="p">[</span><span class="n">pos_power_func</span><span class="p">,</span> <span class="n">gen_power_func</span><span class="p">]),</span>
                           <span class="n">preambles</span><span class="o">=</span><span class="n">lp_pregen</span><span class="o">.</span><span class="n">power_function_preambles</span><span class="p">(</span>
                               <span class="n">loopy_opts</span><span class="p">,</span> <span class="p">[</span><span class="n">pos_power_func</span><span class="p">,</span> <span class="n">gen_power_func</span><span class="p">]))]</span></div>


<div class="viewcode-block" id="get_lind_kernel"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.get_lind_kernel">[docs]</a><span class="k">def</span> <span class="nf">get_lind_kernel</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates instructions, kernel arguements, and data for the Lindeman</span>
<span class="sd">    falloff evaluation kernel</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not none, this kernel is being used for testing.</span>
<span class="sd">        Hence we need to size the arrays accordingly</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl_list : list of :class:`knl_info`</span>
<span class="sd">        The generated infos for feeding into the kernel generator</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check for empty</span>
    <span class="k">if</span> <span class="n">namestore</span><span class="o">.</span><span class="n">lind_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># set of equations is irrelevant for non-derivatives</span>

    <span class="n">kernel_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># add problem size</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># create Fi array / str</span>

    <span class="n">mapstore</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">lind_map</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>

    <span class="n">Fi_lp</span><span class="p">,</span> <span class="n">Fi_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">Fi</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>
    <span class="n">kernel_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Fi_lp</span><span class="p">)</span>

    <span class="c1"># create instruction set</span>
    <span class="n">lind_instructions</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    $</span><span class="si">{Fi_str}</span><span class="s2"> = 1 {id=Fi_init}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">Fi_str</span><span class="o">=</span><span class="n">Fi_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="s1">&#39;fall_lind&#39;</span><span class="p">,</span>
                           <span class="n">instructions</span><span class="o">=</span><span class="n">lind_instructions</span><span class="p">,</span>
                           <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                           <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">,</span>
                           <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                           <span class="n">silenced_warnings</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;write_race(Fi_init)&#39;</span><span class="p">])]</span></div>


<div class="viewcode-block" id="get_simple_arrhenius_rates"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.get_simple_arrhenius_rates">[docs]</a><span class="k">def</span> <span class="nf">get_simple_arrhenius_rates</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">falloff</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates instructions, kernel arguements, and data for specialized forms</span>
<span class="sd">    of simple (non-pressure dependent) rate constants</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not none, this kernel is being used for testing.</span>
<span class="sd">        Hence we need to size the arrays accordingly</span>
<span class="sd">    falloff : bool</span>
<span class="sd">        If true, generate rate kernel for the falloff rates, i.e. either</span>
<span class="sd">        k0 or kinf depending on whether the reaction is falloff or chemically</span>
<span class="sd">        activated</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl_list : list of :class:`knl_info`</span>
<span class="sd">        The generated infos for feeding into the kernel generator</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># find options, sizes, etc.</span>
    <span class="k">if</span> <span class="n">falloff</span><span class="p">:</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;fall&#39;</span>

        <span class="c1"># check for empty falloff (if so, return empty)</span>
        <span class="k">if</span> <span class="n">namestore</span><span class="o">.</span><span class="n">fall_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">mapstore</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">fall_map</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>
        <span class="c1"># define the rtype iteration domain</span>

        <span class="k">def</span> <span class="nf">get_rdomain</span><span class="p">(</span><span class="n">rtype</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rtype</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_fall</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_fall</span><span class="p">,</span>\
                    <span class="n">namestore</span><span class="o">.</span><span class="n">num_fall</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">namestore</span><span class="p">,</span> <span class="s1">&#39;fall_rtype_</span><span class="si">{}</span><span class="s1">_inds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rtype</span><span class="p">)),</span>\
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">namestore</span><span class="p">,</span> <span class="s1">&#39;fall_rtype_</span><span class="si">{}</span><span class="s1">_inds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rtype</span><span class="p">)),</span>\
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">namestore</span><span class="p">,</span> <span class="s1">&#39;fall_rtype_</span><span class="si">{}</span><span class="s1">_num&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rtype</span><span class="p">))</span>
        <span class="n">rdomain</span> <span class="o">=</span> <span class="n">get_rdomain</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;simple&#39;</span>
        <span class="n">mapstore</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">simple_map</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>
        <span class="c1"># define the rtype iteration domain</span>

        <span class="k">def</span> <span class="nf">get_rdomain</span><span class="p">(</span><span class="n">rtype</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rtype</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_simple</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">simple_map</span><span class="p">,</span>\
                    <span class="n">namestore</span><span class="o">.</span><span class="n">num_simple</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">namestore</span><span class="p">,</span>
                               <span class="s1">&#39;simple_rtype_</span><span class="si">{}</span><span class="s1">_inds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rtype</span><span class="p">)),</span> \
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">namestore</span><span class="p">,</span>
                            <span class="s1">&#39;simple_rtype_</span><span class="si">{}</span><span class="s1">_map&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rtype</span><span class="p">)),</span> \
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">namestore</span><span class="p">,</span>
                            <span class="s1">&#39;simple_rtype_</span><span class="si">{}</span><span class="s1">_num&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rtype</span><span class="p">))</span>
        <span class="n">rdomain</span> <span class="o">=</span> <span class="n">get_rdomain</span>

    <span class="c1"># first assign the reac types, parameters</span>
    <span class="n">full</span> <span class="o">=</span> <span class="n">loopy_opts</span><span class="o">.</span><span class="n">rate_spec</span> <span class="o">==</span> <span class="n">RateSpecialization</span><span class="o">.</span><span class="n">full</span>
    <span class="n">hybrid</span> <span class="o">=</span> <span class="n">loopy_opts</span><span class="o">.</span><span class="n">rate_spec</span> <span class="o">==</span> <span class="n">RateSpecialization</span><span class="o">.</span><span class="n">hybrid</span>
    <span class="n">fixed</span> <span class="o">=</span> <span class="n">loopy_opts</span><span class="o">.</span><span class="n">rate_spec</span> <span class="o">==</span> <span class="n">RateSpecialization</span><span class="o">.</span><span class="n">fixed</span>
    <span class="n">separated_kernels</span> <span class="o">=</span> <span class="n">loopy_opts</span><span class="o">.</span><span class="n">rate_spec_kernels</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fixed</span> <span class="ow">and</span> <span class="n">separated_kernels</span><span class="p">:</span>
        <span class="n">separated_kernels</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Cannot use separated kernels with a fixed &#39;</span>
                    <span class="s1">&#39;RateSpecialization, disabling...&#39;</span><span class="p">)</span>

    <span class="n">base_kernel_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># add problem size</span>
    <span class="n">base_kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># if we need the rtype array, add it</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">separated_kernels</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fixed</span><span class="p">:</span>
        <span class="n">rtype_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">namestore</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_rtype&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
        <span class="c1"># get domain and corresponing kf inds</span>
        <span class="n">domain</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="n">rdomain</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># add map</span>
        <span class="n">mapstore</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">rtype_attr</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
        <span class="c1"># create</span>
        <span class="n">rtype_lp</span><span class="p">,</span> <span class="n">rtype_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">rtype_attr</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
        <span class="c1"># add</span>
        <span class="n">base_kernel_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rtype_lp</span><span class="p">)</span>

    <span class="c1"># create temperature array / str</span>
    <span class="n">T_arr</span><span class="p">,</span> <span class="n">T_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">T_arr</span><span class="p">,</span> <span class="n">global_ind</span><span class="p">)</span>
    <span class="n">base_kernel_data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T_arr</span><span class="p">)</span>

    <span class="c1"># put rateconst info args in dict for unpacking convenience</span>
    <span class="n">extra_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;kernel_data&#39;</span><span class="p">:</span> <span class="n">base_kernel_data</span><span class="p">,</span>
                  <span class="s1">&#39;var_name&#39;</span><span class="p">:</span> <span class="n">var_name</span><span class="p">}</span>

    <span class="n">Tinv</span> <span class="o">=</span> <span class="s1">&#39;Tinv&#39;</span>
    <span class="n">logT</span> <span class="o">=</span> <span class="s1">&#39;logT&#39;</span>
    <span class="n">Tval</span> <span class="o">=</span> <span class="s1">&#39;Tval&#39;</span>
    <span class="c1"># create a precomputed instruction generator</span>
    <span class="n">precompute</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">PrecomputedInstructions</span><span class="p">()</span>
    <span class="n">default_preinstructs</span> <span class="o">=</span> <span class="p">{</span><span class="n">Tinv</span><span class="p">:</span>
                            <span class="n">precompute</span><span class="p">(</span><span class="n">Tinv</span><span class="p">,</span> <span class="n">T_str</span><span class="p">,</span> <span class="s1">&#39;INV&#39;</span><span class="p">),</span>
                            <span class="n">logT</span><span class="p">:</span>
                            <span class="n">precompute</span><span class="p">(</span><span class="n">logT</span><span class="p">,</span> <span class="n">T_str</span><span class="p">,</span> <span class="s1">&#39;LOG&#39;</span><span class="p">),</span>
                            <span class="n">Tval</span><span class="p">:</span>
                            <span class="n">precompute</span><span class="p">(</span><span class="n">Tval</span><span class="p">,</span> <span class="n">T_str</span><span class="p">,</span> <span class="s1">&#39;VAL&#39;</span><span class="p">)}</span>

    <span class="c1"># generic kf assigment str</span>
    <span class="n">kf_assign</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;$</span><span class="si">{kf_str}</span><span class="s2"> = $</span><span class="si">{rate}</span><span class="s2"> {id=rate_eval0, </span><span class="se">\</span>
<span class="s2">                         nosync=$</span><span class="si">{deps}</span><span class="s2">}&quot;</span><span class="p">)</span>
    <span class="n">expkf_assign</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;$</span><span class="si">{kf_str}</span><span class="s2"> = exp($</span><span class="si">{rate}</span><span class="s2">) {id=rate_eval$</span><span class="si">{id}</span><span class="s2">, </span><span class="se">\</span>
<span class="s2">                            nosync=$</span><span class="si">{deps}</span><span class="s2">}&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get_instructions</span><span class="p">(</span><span class="n">rtype</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">kernel_data</span><span class="p">,</span> <span class="n">beta_iter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">single_kernel_rtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Tval</span><span class="o">=</span><span class="n">Tval</span><span class="p">,</span> <span class="n">logT</span><span class="o">=</span><span class="n">logT</span><span class="p">,</span>
                           <span class="n">Tinv</span><span class="o">=</span><span class="n">Tinv</span><span class="p">,</span> <span class="n">specializations</span><span class="o">=</span><span class="nb">set</span><span class="p">()):</span>
        <span class="c1"># get domain</span>
        <span class="n">domain</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="n">rdomain</span><span class="p">(</span><span class="n">rtype</span><span class="p">)</span>

        <span class="c1"># use the single_kernel_rtype to find instructions</span>
        <span class="k">if</span> <span class="n">rtype</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rtype</span> <span class="o">=</span> <span class="n">single_kernel_rtype</span>

        <span class="c1"># get attrs</span>
        <span class="n">A_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">namestore</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_A&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
        <span class="n">b_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">namestore</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_beta&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
        <span class="n">Ta_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">namestore</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_Ta&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
        <span class="n">kf_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">namestore</span><span class="p">,</span> <span class="s1">&#39;kf&#39;</span> <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span> <span class="k">else</span> <span class="s1">&#39;kf_fall&#39;</span><span class="p">)</span>

        <span class="c1"># ensure the map inds are keyed off the num</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">separated_kernels</span> <span class="ow">or</span> <span class="n">fixed</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">falloff</span><span class="p">:</span>
            <span class="n">mapper</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">inds</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>

        <span class="c1"># add maps</span>
        <span class="n">mapper</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">A_attr</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
        <span class="n">mapper</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">b_attr</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
        <span class="n">mapper</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">Ta_attr</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
        <span class="n">mapper</span><span class="o">.</span><span class="n">check_and_add_transform</span><span class="p">(</span><span class="n">kf_attr</span><span class="p">,</span> <span class="n">inds</span><span class="p">)</span>

        <span class="c1"># create A / b / ta</span>
        <span class="n">A_lp</span><span class="p">,</span> <span class="n">A_str</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">A_attr</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
        <span class="n">b_lp</span><span class="p">,</span> <span class="n">b_str</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">b_attr</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
        <span class="n">Ta_lp</span><span class="p">,</span> <span class="n">Ta_str</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">Ta_attr</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
        <span class="n">kf_lp</span><span class="p">,</span> <span class="n">kf_str</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">kf_attr</span><span class="p">,</span> <span class="o">*</span><span class="n">default_inds</span><span class="p">)</span>

        <span class="c1"># add arrays</span>
        <span class="n">kernel_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">A_lp</span><span class="p">,</span> <span class="n">b_lp</span><span class="p">,</span> <span class="n">Ta_lp</span><span class="p">,</span> <span class="n">kf_lp</span><span class="p">])</span>

        <span class="c1"># get rate equations</span>
        <span class="n">rate_eqn_pre</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
            <span class="s2">&quot;$</span><span class="si">{A_str}</span><span class="s2"> + $</span><span class="si">{logT}</span><span class="s2"> * $</span><span class="si">{b_str}</span><span class="s2"> - $</span><span class="si">{Ta_str}</span><span class="s2"> * $</span><span class="si">{Tinv}</span><span class="s2">&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="n">rate_eqn_pre_noTa</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
            <span class="s2">&quot;$</span><span class="si">{A_str}</span><span class="s2"> + $</span><span class="si">{logT}</span><span class="s2"> * $</span><span class="si">{b_str}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="n">rate_eqn_pre_nobeta</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
            <span class="s2">&quot;$</span><span class="si">{A_str}</span><span class="s2"> - $</span><span class="si">{Ta_str}</span><span class="s2"> * $</span><span class="si">{Tinv}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span>
            <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>

        <span class="k">def</span> <span class="nf">__deps</span><span class="p">(</span><span class="n">assign</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">single_kernel_rtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># not a combined kernel</span>
                <span class="k">return</span> <span class="s1">&#39; &#39;</span>
            <span class="k">elif</span> <span class="n">assign</span> <span class="o">==</span> <span class="n">expkf_assign</span><span class="p">:</span>
                <span class="n">rate_evals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="n">full</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">hybrid</span> <span class="k">else</span> \
                    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">rate_evals</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">rate_evals</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">specializations</span><span class="p">)</span>
                <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rate_eval</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rate_evals</span><span class="p">]</span>
                <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">rate_evals</span><span class="p">:</span>
                    <span class="c1"># add beta iter deps</span>
                    <span class="n">deps</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;a*&#39;</span><span class="p">]</span>
                <span class="n">deps</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">deps</span> <span class="k">if</span> <span class="n">deps</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">assign</span> <span class="o">==</span> <span class="n">kf_assign</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;rate_eval*:a*&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;rate_eval*&#39;</span>

        <span class="n">preambles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">manglers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># the simple formulation</span>
        <span class="k">if</span> <span class="n">fixed</span> <span class="ow">or</span> <span class="p">(</span><span class="n">hybrid</span> <span class="ow">and</span> <span class="n">rtype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">full</span> <span class="ow">and</span> <span class="n">rtype</span> <span class="o">==</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">retv</span> <span class="o">=</span> <span class="n">expkf_assign</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">rate_eqn_pre</span><span class="p">),</span>
                                                <span class="n">deps</span><span class="o">=</span><span class="n">__deps</span><span class="p">(</span><span class="n">expkf_assign</span><span class="p">),</span>
                                                <span class="nb">id</span><span class="o">=</span><span class="n">rtype</span><span class="p">)</span>
        <span class="c1"># otherwise check type and return appropriate instructions with</span>
        <span class="c1"># array strings substituted in</span>
        <span class="k">elif</span> <span class="n">rtype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">retv</span> <span class="o">=</span> <span class="n">kf_assign</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="n">A_str</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">__deps</span><span class="p">(</span><span class="n">kf_assign</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">rtype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">beta_iter</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">power_func</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">power_function</span><span class="p">(</span>
                    <span class="n">loopy_opts</span><span class="o">.</span><span class="n">lang</span><span class="p">,</span> <span class="n">is_integer_power</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_positive_power</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">beta_iter_str</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                &lt;int32&gt; b_end = abs($</span><span class="si">{b_str}</span><span class="s2">)</span>
<span class="s2">                kf_temp = kf_temp * $</span><span class="si">{power_func}</span><span class="s2">(T_iter, b_end) </span><span class="se">\</span>
<span class="s2">                    {id=a4, dep=a3:a2:a1}</span>
<span class="s2">                $</span><span class="si">{kf_str}</span><span class="s2"> = kf_temp {id=rate_eval1, dep=a4, nosync=$</span><span class="si">{deps}</span><span class="s2">}</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">b_str</span><span class="o">=</span><span class="n">b_str</span><span class="p">,</span> <span class="n">power_func</span><span class="o">=</span><span class="n">power_func</span><span class="p">,</span>
                                     <span class="n">deps</span><span class="o">=</span><span class="n">__deps</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="n">preambles</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lp_pregen</span><span class="o">.</span><span class="n">power_function_preambles</span><span class="p">(</span>
                    <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">power_func</span><span class="p">))</span>
                <span class="n">manglers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lp_pregen</span><span class="o">.</span><span class="n">power_function_manglers</span><span class="p">(</span>
                    <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">power_func</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">beta_iter_str</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
                    <span class="s2">&quot;$</span><span class="si">{kf_str}</span><span class="s2"> = kf_temp * T_iter&quot;</span>
                    <span class="s2">&quot; {id=rate_eval1, dep=a3:a2:a1, nosync=$</span><span class="si">{deps}</span><span class="s2">}&quot;</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">deps</span><span class="o">=</span><span class="n">__deps</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">))</span>

            <span class="n">retv</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                &lt;&gt; T_iter = ${Tval} {id=a1}</span>
<span class="sd">                if ${b_str} &lt; 0</span>
<span class="sd">                    T_iter = Tinv {id=a2, dep=a1}</span>
<span class="sd">                end</span>
<span class="sd">                &lt;&gt;kf_temp = ${A_str} {id=a3}</span>
<span class="sd">                ${beta_iter_str}</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">rtype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">retv</span> <span class="o">=</span> <span class="n">expkf_assign</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span>
                <span class="n">rate</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">rate_eqn_pre_noTa</span><span class="p">),</span> <span class="n">deps</span><span class="o">=</span><span class="n">__deps</span><span class="p">(</span><span class="n">expkf_assign</span><span class="p">),</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">rtype</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rtype</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">retv</span> <span class="o">=</span> <span class="n">expkf_assign</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span>
                <span class="n">rate</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">rate_eqn_pre_nobeta</span><span class="p">),</span> <span class="n">deps</span><span class="o">=</span><span class="n">__deps</span><span class="p">(</span><span class="n">expkf_assign</span><span class="p">),</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">rtype</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Template</span><span class="p">(</span><span class="n">retv</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="n">kf_str</span><span class="o">=</span><span class="n">kf_str</span><span class="p">),</span> <span class="n">preambles</span><span class="p">,</span> <span class="n">manglers</span>

    <span class="c1"># various specializations of the rate form</span>
    <span class="n">specializations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">i_a_only</span> <span class="o">=</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;a_only_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span>
                              <span class="n">instructions</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                              <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                              <span class="o">**</span><span class="n">extra_args</span><span class="p">)</span>

    <span class="c1"># the default is a single multiplication</span>
    <span class="c1"># if needed, this will be expanded to a for-loop multiplier</span>
    <span class="n">i_beta_int</span> <span class="o">=</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;beta_int_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span>
                                <span class="n">instructions</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                                <span class="n">pre_instructions</span><span class="o">=</span><span class="p">[</span>
                                    <span class="n">default_preinstructs</span><span class="p">[</span><span class="n">Tval</span><span class="p">],</span>
                                    <span class="n">default_preinstructs</span><span class="p">[</span><span class="n">Tinv</span><span class="p">]],</span>
                                <span class="o">**</span><span class="n">extra_args</span><span class="p">)</span>
    <span class="n">i_beta_exp</span> <span class="o">=</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="s1">&#39;beta_exp_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span>
                                <span class="n">instructions</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                                <span class="n">pre_instructions</span><span class="o">=</span><span class="p">[</span>
                                    <span class="n">default_preinstructs</span><span class="p">[</span><span class="n">Tinv</span><span class="p">],</span>
                                    <span class="n">default_preinstructs</span><span class="p">[</span><span class="n">logT</span><span class="p">]],</span>
                                <span class="o">**</span><span class="n">extra_args</span><span class="p">)</span>
    <span class="n">i_ta_exp</span> <span class="o">=</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="s1">&#39;ta_exp_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span>
                              <span class="n">instructions</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                              <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                              <span class="n">pre_instructions</span><span class="o">=</span><span class="p">[</span>
        <span class="n">default_preinstructs</span><span class="p">[</span><span class="n">Tinv</span><span class="p">],</span>
        <span class="n">default_preinstructs</span><span class="p">[</span><span class="n">logT</span><span class="p">]],</span>
        <span class="o">**</span><span class="n">extra_args</span><span class="p">)</span>
    <span class="n">i_full</span> <span class="o">=</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="s1">&#39;rateconst_full</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span>
                            <span class="n">instructions</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                            <span class="n">pre_instructions</span><span class="o">=</span><span class="p">[</span>
        <span class="n">default_preinstructs</span><span class="p">[</span><span class="n">Tinv</span><span class="p">],</span>
        <span class="n">default_preinstructs</span><span class="p">[</span><span class="n">logT</span><span class="p">]],</span>
        <span class="o">**</span><span class="n">extra_args</span><span class="p">)</span>

    <span class="c1"># set up the simple arrhenius rate specializations</span>
    <span class="k">if</span> <span class="n">fixed</span><span class="p">:</span>
        <span class="n">specializations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_full</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">specializations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_a_only</span>
        <span class="n">specializations</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_beta_int</span>
        <span class="k">if</span> <span class="n">full</span><span class="p">:</span>
            <span class="n">specializations</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_beta_exp</span>
            <span class="n">specializations</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_ta_exp</span>
            <span class="n">specializations</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_full</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">specializations</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_full</span>

    <span class="c1"># filter out unused specializations</span>
    <span class="k">for</span> <span class="n">rtype</span> <span class="ow">in</span> <span class="n">specializations</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
        <span class="n">domain</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">rdomain</span><span class="p">(</span><span class="n">rtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">domain</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">domain</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="c1"># kernel doesn&#39;t act on anything, don&#39;t add it to output</span>
            <span class="k">del</span> <span class="n">specializations</span><span class="p">[</span><span class="n">rtype</span><span class="p">]</span>

    <span class="c1"># find out if beta iteration needed</span>
    <span class="n">beta_iter</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">b_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">namestore</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_beta&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
    <span class="n">rtype_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">namestore</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_rtype&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
    <span class="c1"># find locations</span>
    <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rtype_attr</span><span class="o">.</span><span class="n">initializer</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">b_vals</span> <span class="o">=</span> <span class="n">b_attr</span><span class="o">.</span><span class="n">initializer</span><span class="p">[</span><span class="n">locs</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">b_vals</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="c1"># if max b exponent &gt; 1, need to iterate</span>
        <span class="n">beta_iter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b_vals</span><span class="p">)))</span>

    <span class="c1"># if single kernel, and not a fixed exponential</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">separated_kernels</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fixed</span><span class="p">:</span>
        <span class="c1"># need to enclose each branch in it&#39;s own if statement</span>
        <span class="n">do_conditional</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">specializations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="n">instruction_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pre</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">man</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">specializations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">do_conditional</span><span class="p">:</span>
                <span class="n">instruction_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s1">&#39;if </span><span class="si">{1}</span><span class="s1"> == </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">rtype_str</span><span class="p">))</span>
            <span class="n">insns</span><span class="p">,</span> <span class="n">preambles</span><span class="p">,</span> <span class="n">manglers</span> <span class="o">=</span> <span class="n">__get_instructions</span><span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">map_domain</span><span class="p">,</span> <span class="n">test_size</span><span class="p">),</span>
                <span class="n">specializations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">kernel_data</span><span class="p">,</span>
                <span class="n">beta_iter</span><span class="p">,</span>
                <span class="n">single_kernel_rtype</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                <span class="n">specializations</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">specializations</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">instruction_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">insns</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()])</span>
            <span class="k">if</span> <span class="n">do_conditional</span><span class="p">:</span>
                <span class="n">instruction_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">preambles</span><span class="p">:</span>
                <span class="n">pre</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">preambles</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">manglers</span><span class="p">:</span>
                <span class="n">man</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">manglers</span><span class="p">)</span>
        <span class="c1"># and combine them</span>
        <span class="n">kernel_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">specializations</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kernel_data</span>
        <span class="n">specializations</span> <span class="o">=</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span>
                           <span class="s1">&#39;rateconst_singlekernel_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span>
                           <span class="n">instructions</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">instruction_list</span><span class="p">),</span>
                           <span class="n">pre_instructions</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span>
                               <span class="n">default_preinstructs</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                           <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                           <span class="n">kernel_data</span><span class="o">=</span><span class="n">kernel_data</span><span class="p">,</span>
                           <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span>
                           <span class="n">preambles</span><span class="o">=</span><span class="n">pre</span><span class="p">,</span>
                           <span class="n">manglers</span><span class="o">=</span><span class="n">man</span><span class="p">,</span>
                           <span class="n">silenced_warnings</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;write_race(rate_eval0)&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;write_race(rate_eval1)&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;write_race(rate_eval2)&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;write_race(rate_eval3)&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;write_race(rate_eval4)&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;write_race(a4)&#39;</span><span class="p">])}</span>

    <span class="n">out_specs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># and do some finalizations for the specializations</span>
    <span class="k">for</span> <span class="n">rtype</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">specializations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># this is handled above</span>
        <span class="k">if</span> <span class="n">rtype</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out_specs</span><span class="p">[</span><span class="n">rtype</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
            <span class="k">continue</span>

        <span class="c1"># turn off warning</span>
        <span class="n">info</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;silenced_warnings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;write_race(rate_eval</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rtype</span><span class="p">),</span>
                                            <span class="s1">&#39;write_race(a4)&#39;</span><span class="p">]</span>

        <span class="n">domain</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="n">rdomain</span><span class="p">(</span><span class="n">rtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">domain</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">domain</span><span class="o">.</span><span class="n">initializer</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="c1"># kernel doesn&#39;t act on anything, don&#39;t add it to output</span>
            <span class="k">continue</span>

        <span class="c1"># next create a mapper for this rtype</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>

        <span class="c1"># set as mapper</span>
        <span class="n">info</span><span class="o">.</span><span class="n">mapstore</span> <span class="o">=</span> <span class="n">mapper</span>

        <span class="c1"># if a specific rtype, get the instructions here</span>
        <span class="k">if</span> <span class="n">rtype</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">instructions</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">preambles</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">manglers</span> <span class="o">=</span> <span class="n">__get_instructions</span><span class="p">(</span>
                <span class="n">rtype</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">kernel_data</span><span class="p">,</span> <span class="n">beta_iter</span><span class="p">,</span>
                <span class="n">specializations</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">specializations</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

        <span class="n">out_specs</span><span class="p">[</span><span class="n">rtype</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">out_specs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>


<div class="viewcode-block" id="get_specrates_kernel"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.get_specrates_kernel">[docs]</a><span class="k">def</span> <span class="nf">get_specrates_kernel</span><span class="p">(</span><span class="n">reacs</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">conp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">auto_diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_full_rop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">mem_limits</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper function that generates kernels for</span>
<span class="sd">       evaluation of reaction rates / rate constants / and species rates</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reacs : list of :class:`ReacInfo`</span>
<span class="sd">        List of species in the mechanism.</span>
<span class="sd">    specs : list of :class:`SpecInfo`</span>
<span class="sd">        List of species in the mechanism.</span>
<span class="sd">    loopy_opts : :class:`loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    conp : bool</span>
<span class="sd">        If true, generate equations using constant pressure assumption</span>
<span class="sd">        If false, use constant volume equations</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not None, this kernel is being used for testing.</span>
<span class="sd">    auto_diff : bool</span>
<span class="sd">        If ``True``, generate files for Adept autodifferention library.</span>
<span class="sd">    output_full_rop : bool</span>
<span class="sd">        If ``True``, output forward and reversse rates of progress</span>
<span class="sd">        Useful in testing, as there are serious floating point errors for</span>
<span class="sd">        net production rates near equilibrium, invalidating direct comparison to</span>
<span class="sd">        Cantera</span>
<span class="sd">    mem_limits: str [&#39;&#39;]</span>
<span class="sd">        Path to a .yaml file indicating desired memory limits that control the</span>
<span class="sd">        desired maximum amount of global / local / or constant memory that</span>
<span class="sd">        the generated pyjac code may allocate.  Useful for testing, or otherwise</span>
<span class="sd">        limiting memory usage during runtime. The keys of this file are the</span>
<span class="sd">        members of :class:`pyjac.kernel_utils.memory_limits.mem_type`</span>
<span class="sd">    kwargs: dict</span>
<span class="sd">        Arguements for the construction of the :class:`kernel_generator`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    kernel_gen : :class:`kernel_generator`</span>
<span class="sd">        The generator responsible for creating the resulting code</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># figure out rates and info</span>
    <span class="n">rate_info</span> <span class="o">=</span> <span class="n">assign_rates</span><span class="p">(</span><span class="n">reacs</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">loopy_opts</span><span class="o">.</span><span class="n">rate_spec</span><span class="p">)</span>

    <span class="c1"># create the namestore</span>
    <span class="n">nstore</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">NameStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">rate_info</span><span class="p">,</span> <span class="n">conp</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>

    <span class="n">kernels</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__add_knl</span><span class="p">(</span><span class="n">knls</span><span class="p">,</span> <span class="n">klist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">klist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">klist</span> <span class="o">=</span> <span class="n">kernels</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">klist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">knls</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">knls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">klist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">knls</span><span class="p">)</span>

    <span class="c1"># Note:</span>
    <span class="c1"># the order in which these kernels get added is important</span>
    <span class="c1"># the kernel generator uses the input order to generate the wrapping</span>
    <span class="c1"># kernel calls</span>
    <span class="c1"># hence, any data dependencies should be expressed in the order added here</span>

    <span class="c1"># reset kernels</span>
    <span class="n">__add_knl</span><span class="p">(</span><span class="n">reset_arrays</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">nstore</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># first, add the concentration kernel</span>
    <span class="n">__add_knl</span><span class="p">(</span><span class="n">get_concentrations</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">nstore</span><span class="p">,</span> <span class="n">conp</span><span class="o">=</span><span class="n">conp</span><span class="p">,</span>
                                 <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># get the simple arrhenius k_gen.knl_info&#39;s</span>
    <span class="n">__add_knl</span><span class="p">(</span><span class="n">get_simple_arrhenius_rates</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span>
                                         <span class="n">nstore</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># check for plog</span>
    <span class="k">if</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;plog&#39;</span><span class="p">][</span><span class="s1">&#39;num&#39;</span><span class="p">]:</span>
        <span class="c1"># generate the plog kernel</span>
        <span class="n">__add_knl</span><span class="p">(</span><span class="n">get_plog_arrhenius_rates</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span>
                                           <span class="n">nstore</span><span class="p">,</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;plog&#39;</span><span class="p">][</span><span class="s1">&#39;max_P&#39;</span><span class="p">],</span>
                                           <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># check for chebyshev</span>
    <span class="k">if</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;cheb&#39;</span><span class="p">][</span><span class="s1">&#39;num&#39;</span><span class="p">]:</span>
        <span class="n">__add_knl</span><span class="p">(</span><span class="n">get_cheb_arrhenius_rates</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span>
                                           <span class="n">nstore</span><span class="p">,</span>
                                           <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;cheb&#39;</span><span class="p">][</span><span class="s1">&#39;num_P&#39;</span><span class="p">]),</span>
                                           <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;cheb&#39;</span><span class="p">][</span><span class="s1">&#39;num_T&#39;</span><span class="p">]),</span>
                                           <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># check for third body terms</span>
    <span class="k">if</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;thd&#39;</span><span class="p">][</span><span class="s1">&#39;num&#39;</span><span class="p">]:</span>
        <span class="c1"># add the initial third body conc eval kernel</span>
        <span class="n">__add_knl</span><span class="p">(</span><span class="n">get_thd_body_concs</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span>
                                     <span class="n">nstore</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># check for falloff</span>
    <span class="k">if</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;fall&#39;</span><span class="p">][</span><span class="s1">&#39;num&#39;</span><span class="p">]:</span>
        <span class="c1"># get the falloff rates</span>
        <span class="n">__add_knl</span><span class="p">(</span><span class="n">get_simple_arrhenius_rates</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span>
                                             <span class="n">nstore</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span>
                                             <span class="n">falloff</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="c1"># and the reduced pressure</span>
        <span class="n">__add_knl</span><span class="p">(</span><span class="n">get_reduced_pressure_kernel</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span>
                                              <span class="n">nstore</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">))</span>
        <span class="c1"># and finally any blending functions (depend on reduced pressure)</span>
        <span class="k">if</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;fall&#39;</span><span class="p">][</span><span class="s1">&#39;lind&#39;</span><span class="p">][</span><span class="s1">&#39;num&#39;</span><span class="p">]:</span>
            <span class="n">__add_knl</span><span class="p">(</span><span class="n">get_lind_kernel</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span>
                                      <span class="n">nstore</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;fall&#39;</span><span class="p">][</span><span class="s1">&#39;troe&#39;</span><span class="p">][</span><span class="s1">&#39;num&#39;</span><span class="p">]:</span>
            <span class="n">__add_knl</span><span class="p">(</span><span class="n">get_troe_kernel</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span>
                                      <span class="n">nstore</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;fall&#39;</span><span class="p">][</span><span class="s1">&#39;sri&#39;</span><span class="p">][</span><span class="s1">&#39;num&#39;</span><span class="p">]:</span>
            <span class="n">__add_knl</span><span class="p">(</span><span class="n">get_sri_kernel</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span>
                                     <span class="n">nstore</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># thermo polynomial dimension</span>
    <span class="n">depends_on</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># check for reverse rates</span>
    <span class="k">if</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;rev&#39;</span><span class="p">][</span><span class="s1">&#39;num&#39;</span><span class="p">]:</span>
        <span class="c1"># add the &#39;b&#39; eval</span>
        <span class="n">__add_knl</span><span class="p">(</span><span class="n">polyfit_kernel_gen</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">loopy_opts</span><span class="p">,</span>
                                     <span class="n">nstore</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>
        <span class="c1"># addd the &#39;b&#39; eval to depnediencies</span>
        <span class="n">depends_on</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kernels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># add Kc / rev rates</span>
        <span class="n">__add_knl</span><span class="p">(</span><span class="n">get_rev_rates</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span>
                                <span class="n">nstore</span><span class="p">,</span>
                                <span class="n">allint</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;net&#39;</span><span class="p">:</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">][</span><span class="s1">&#39;allint&#39;</span><span class="p">]},</span>
                                <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># check for falloff</span>
    <span class="k">if</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;fall&#39;</span><span class="p">][</span><span class="s1">&#39;num&#39;</span><span class="p">]:</span>
        <span class="c1"># and the Pr evals</span>
        <span class="n">__add_knl</span><span class="p">(</span><span class="n">get_rxn_pres_mod</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span>
                                   <span class="n">nstore</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># add ROP</span>
    <span class="n">__add_knl</span><span class="p">(</span><span class="n">get_rop</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span>
                      <span class="n">nstore</span><span class="p">,</span> <span class="n">allint</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;net&#39;</span><span class="p">:</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">][</span><span class="s1">&#39;allint&#39;</span><span class="p">]},</span>
                      <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">))</span>
    <span class="c1"># add ROP net</span>
    <span class="n">__add_knl</span><span class="p">(</span><span class="n">get_rop_net</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span>
                          <span class="n">nstore</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>
    <span class="c1"># add spec rates</span>
    <span class="n">__add_knl</span><span class="p">(</span><span class="n">get_spec_rates</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span>
                             <span class="n">nstore</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># add molar rates</span>
    <span class="n">__add_knl</span><span class="p">(</span><span class="n">get_molar_rates</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">nstore</span><span class="p">,</span> <span class="n">conp</span><span class="o">=</span><span class="n">conp</span><span class="p">,</span>
                              <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">conp</span><span class="p">:</span>
        <span class="c1"># get h / cp evals</span>
        <span class="n">__add_knl</span><span class="p">(</span><span class="n">polyfit_kernel_gen</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">nstore</span><span class="p">,</span>
                                     <span class="n">test_size</span><span class="p">),</span> <span class="n">depends_on</span><span class="p">)</span>
        <span class="n">__add_knl</span><span class="p">(</span><span class="n">polyfit_kernel_gen</span><span class="p">(</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">nstore</span><span class="p">,</span>
                                     <span class="n">test_size</span><span class="p">),</span> <span class="n">depends_on</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># and u / cv</span>
        <span class="n">__add_knl</span><span class="p">(</span><span class="n">polyfit_kernel_gen</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">nstore</span><span class="p">,</span>
                                     <span class="n">test_size</span><span class="p">),</span> <span class="n">depends_on</span><span class="p">)</span>
        <span class="n">__add_knl</span><span class="p">(</span><span class="n">polyfit_kernel_gen</span><span class="p">(</span><span class="s1">&#39;cv&#39;</span><span class="p">,</span> <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">nstore</span><span class="p">,</span>
                                     <span class="n">test_size</span><span class="p">),</span> <span class="n">depends_on</span><span class="p">)</span>
    <span class="c1"># and add to source rates</span>
    <span class="n">__add_knl</span><span class="p">(</span><span class="n">depends_on</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>

    <span class="c1"># and temperature rates</span>
    <span class="n">__add_knl</span><span class="p">(</span><span class="n">get_temperature_rate</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span>
                                   <span class="n">nstore</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span> <span class="n">conp</span><span class="o">=</span><span class="n">conp</span><span class="p">))</span>
    <span class="c1"># and finally the extra variable rates</span>
    <span class="n">__add_knl</span><span class="p">(</span><span class="n">get_extra_var_rates</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">nstore</span><span class="p">,</span> <span class="n">conp</span><span class="o">=</span><span class="n">conp</span><span class="p">,</span>
                                  <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>

    <span class="c1"># get a wrapper for the dependecies</span>
    <span class="n">thermo_in</span><span class="p">,</span> <span class="n">thermo_out</span> <span class="o">=</span> <span class="n">inputs_and_outputs</span><span class="p">(</span><span class="n">conp</span><span class="p">,</span> <span class="n">KernelType</span><span class="o">.</span><span class="n">chem_utils</span><span class="p">)</span>
    <span class="n">thermo_wrap</span> <span class="o">=</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">make_kernel_generator</span><span class="p">(</span><span class="n">kernel_type</span><span class="o">=</span><span class="n">KernelType</span><span class="o">.</span><span class="n">chem_utils</span><span class="p">,</span>
                                              <span class="n">loopy_opts</span><span class="o">=</span><span class="n">loopy_opts</span><span class="p">,</span>
                                              <span class="n">kernels</span><span class="o">=</span><span class="n">depends_on</span><span class="p">,</span>
                                              <span class="n">namestore</span><span class="o">=</span><span class="n">nstore</span><span class="p">,</span>
                                              <span class="n">input_arrays</span><span class="o">=</span><span class="n">thermo_in</span><span class="p">,</span>
                                              <span class="n">output_arrays</span><span class="o">=</span><span class="n">thermo_out</span><span class="p">,</span>
                                              <span class="n">auto_diff</span><span class="o">=</span><span class="n">auto_diff</span><span class="p">,</span>
                                              <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span>
                                              <span class="n">mem_limits</span><span class="o">=</span><span class="n">mem_limits</span>
                                              <span class="p">)</span>

    <span class="n">barriers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">loopy_opts</span><span class="o">.</span><span class="n">depth</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__insert_at</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">knl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kernels</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">knl</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">before</span><span class="p">:</span>
                    <span class="n">barriers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ind</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="s1">&#39;global&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">barriers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;global&#39;</span><span class="p">))</span>
        <span class="c1"># need to add barriers</span>
        <span class="c1"># barrier at third bodies for get_concentrations</span>
        <span class="n">__insert_at</span><span class="p">(</span><span class="s1">&#39;eval_thd_body_concs&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># barrier for reduced pressure based on thd body concs and kf_fall</span>
        <span class="n">__insert_at</span><span class="p">(</span><span class="s1">&#39;red_pres&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># barrier before fall_troe for Pr</span>
        <span class="k">if</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;fall&#39;</span><span class="p">][</span><span class="s1">&#39;num&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;fall&#39;</span><span class="p">][</span><span class="s1">&#39;troe&#39;</span><span class="p">][</span><span class="s1">&#39;num&#39;</span><span class="p">]:</span>
                <span class="c1"># try the fall_sri</span>
                <span class="n">__insert_at</span><span class="p">(</span><span class="s1">&#39;fall_sri&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># put before troe</span>
                <span class="n">__insert_at</span><span class="p">(</span><span class="s1">&#39;fall_troe&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="c1"># barrier before the falloff ci&#39;s for the Fi&#39;s</span>
            <span class="n">__insert_at</span><span class="p">(</span><span class="s1">&#39;ci_fall&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;rev&#39;</span><span class="p">][</span><span class="s1">&#39;num&#39;</span><span class="p">]:</span>
            <span class="c1"># barrier before Kc for b evals</span>
            <span class="n">__insert_at</span><span class="p">(</span><span class="s1">&#39;rateconst_Kc&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loopy_opts</span><span class="o">.</span><span class="n">rop_net_kernels</span><span class="p">:</span>
            <span class="c1"># need sync after each rop_net</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rop_net_rev&#39;</span><span class="p">,</span> <span class="s1">&#39;rop_net_pres_mod&#39;</span><span class="p">]:</span>
                <span class="n">__insert_at</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;rev&#39;</span><span class="p">][</span><span class="s1">&#39;num&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;thd&#39;</span><span class="p">][</span><span class="s1">&#39;num&#39;</span><span class="p">]:</span>
            <span class="c1"># if it&#39;s a fixed rop net, and there are reverse</span>
            <span class="c1"># or third body reactions</span>
            <span class="n">__insert_at</span><span class="p">(</span><span class="s1">&#39;rop_net_fixed&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># barrier at species rates for the net ROP</span>
        <span class="n">__insert_at</span><span class="p">(</span><span class="s1">&#39;spec_rates&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># barrier at molar rates for wdot</span>
        <span class="n">__insert_at</span><span class="p">(</span><span class="s1">&#39;get_molar_rates&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># barrier at temperature rates for thermo parameters</span>
        <span class="n">__insert_at</span><span class="p">(</span><span class="s1">&#39;temperature_rate&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># and at the extra variable rates for Tdot</span>
        <span class="n">__insert_at</span><span class="p">(</span><span class="s1">&#39;get_extra_var_rates&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">input_arrays</span><span class="p">,</span> <span class="n">output_arrays</span> <span class="o">=</span> <span class="n">inputs_and_outputs</span><span class="p">(</span>
        <span class="n">conp</span><span class="p">,</span> <span class="n">output_full_rop</span><span class="o">=</span><span class="n">output_full_rop</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output_full_rop</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;rev&#39;</span><span class="p">][</span><span class="s1">&#39;num&#39;</span><span class="p">]:</span>
            <span class="n">output_arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">output_arrays</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;rop_rev&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rate_info</span><span class="p">[</span><span class="s1">&#39;thd&#39;</span><span class="p">][</span><span class="s1">&#39;num&#39;</span><span class="p">]:</span>
            <span class="n">output_arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">output_arrays</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;pres_mod&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">make_kernel_generator</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="o">=</span><span class="n">loopy_opts</span><span class="p">,</span>
        <span class="n">kernel_type</span><span class="o">=</span><span class="n">KernelType</span><span class="o">.</span><span class="n">species_rates</span><span class="p">,</span>
        <span class="n">kernels</span><span class="o">=</span><span class="n">kernels</span><span class="p">,</span>
        <span class="n">namestore</span><span class="o">=</span><span class="n">nstore</span><span class="p">,</span>
        <span class="n">depends_on</span><span class="o">=</span><span class="p">[</span><span class="n">thermo_wrap</span><span class="p">],</span>
        <span class="n">input_arrays</span><span class="o">=</span><span class="n">input_arrays</span><span class="p">,</span>
        <span class="n">output_arrays</span><span class="o">=</span><span class="n">output_arrays</span><span class="p">,</span>
        <span class="n">auto_diff</span><span class="o">=</span><span class="n">auto_diff</span><span class="p">,</span>
        <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span>
        <span class="n">barriers</span><span class="o">=</span><span class="n">barriers</span><span class="p">,</span>
        <span class="n">mem_limits</span><span class="o">=</span><span class="n">mem_limits</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="polyfit_kernel_gen"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.polyfit_kernel_gen">[docs]</a><span class="k">def</span> <span class="nf">polyfit_kernel_gen</span><span class="p">(</span><span class="n">nicename</span><span class="p">,</span> <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper function that generates kernels for</span>
<span class="sd">       evaluation of various thermodynamic species properties</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nicename : str</span>
<span class="sd">        The variable name to use in generated code</span>
<span class="sd">    loopy_opts : `loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    namestore : :class:`array_creator.NameStore`</span>
<span class="sd">        The namestore / creator for this method</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not None, this kernel is being used for testing.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    knl : :class:`loopy.LoopKernel`</span>
<span class="sd">        The generated loopy kernel for code generation / testing</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check for empty</span>
    <span class="k">if</span> <span class="n">nicename</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">namestore</span><span class="o">.</span><span class="n">rev_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">param_ind</span> <span class="o">=</span> <span class="s1">&#39;dummy&#39;</span>
    <span class="n">loop_index</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
    <span class="c1"># create mapper</span>
    <span class="n">mapstore</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">MapStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">namestore</span><span class="o">.</span><span class="n">num_specs</span><span class="p">,</span> <span class="n">test_size</span><span class="p">,</span> <span class="n">loop_index</span><span class="p">)</span>

    <span class="n">knl_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># add problem size</span>
    <span class="n">knl_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">initial_condition_dimension_vars</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="c1"># get correctly ordered arrays / strings</span>
    <span class="n">a_lo_lp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">a_lo</span><span class="p">,</span> <span class="n">loop_index</span><span class="p">,</span> <span class="n">param_ind</span><span class="p">)</span>
    <span class="n">a_hi_lp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">a_hi</span><span class="p">,</span> <span class="n">loop_index</span><span class="p">,</span> <span class="n">param_ind</span><span class="p">)</span>
    <span class="n">poly_dim</span> <span class="o">=</span> <span class="n">namestore</span><span class="o">.</span><span class="n">a_lo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">T_mid_lp</span><span class="p">,</span> <span class="n">T_mid_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">T_mid</span><span class="p">,</span> <span class="n">loop_index</span><span class="p">)</span>

    <span class="c1"># create the input/temperature arrays</span>
    <span class="n">T_lp</span><span class="p">,</span> <span class="n">T_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">T_arr</span><span class="p">,</span> <span class="n">global_ind</span><span class="p">)</span>
    <span class="n">out_lp</span><span class="p">,</span> <span class="n">out_str</span> <span class="o">=</span> <span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">namestore</span><span class="p">,</span> <span class="n">nicename</span><span class="p">),</span>
                                          <span class="n">global_ind</span><span class="p">,</span> <span class="n">loop_index</span><span class="p">)</span>

    <span class="n">knl_data</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">a_lo_lp</span><span class="p">,</span> <span class="n">a_hi_lp</span><span class="p">,</span> <span class="n">T_mid_lp</span><span class="p">,</span> <span class="n">T_lp</span><span class="p">,</span> <span class="n">out_lp</span><span class="p">])</span>

    <span class="c1"># create string indexes for a_lo/a_hi</span>
    <span class="n">a_lo_strs</span> <span class="o">=</span> <span class="p">[</span><span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">a_lo</span><span class="p">,</span> <span class="n">loop_index</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">poly_dim</span><span class="p">)]</span>
    <span class="n">a_hi_strs</span> <span class="o">=</span> <span class="p">[</span><span class="n">mapstore</span><span class="o">.</span><span class="n">apply_maps</span><span class="p">(</span><span class="n">namestore</span><span class="o">.</span><span class="n">a_hi</span><span class="p">,</span> <span class="n">loop_index</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">poly_dim</span><span class="p">)]</span>
    <span class="c1"># mapping of nicename -&gt; eqn</span>
    <span class="n">eqn_maps</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cp&#39;</span><span class="p">:</span> <span class="n">Template</span><span class="p">(</span>
        <span class="s2">&quot;Ru * (T * (T * (T * (T * $</span><span class="si">{a4}</span><span class="s2"> + $</span><span class="si">{a3}</span><span class="s2">) + $</span><span class="si">{a2}</span><span class="s2">) + $</span><span class="si">{a1}</span><span class="s2">) + $</span><span class="si">{a0}</span><span class="s2">)&quot;</span><span class="p">),</span>
        <span class="s1">&#39;dcp&#39;</span><span class="p">:</span> <span class="n">Template</span><span class="p">(</span>
        <span class="s2">&quot;Ru * (T * (T *(4 * T * $</span><span class="si">{a4}</span><span class="s2"> + 3 * $</span><span class="si">{a3}</span><span class="s2"> ) + 2 * $</span><span class="si">{a2}</span><span class="s2">) + $</span><span class="si">{a1}</span><span class="s2">)&quot;</span><span class="p">),</span>
        <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="n">Template</span><span class="p">(</span>
        <span class="s2">&quot;Ru * (T * (T * (T * (T * (T * $</span><span class="si">{a4}</span><span class="s2"> / 5 + $</span><span class="si">{a3}</span><span class="s2"> / 4) + $</span><span class="si">{a2}</span><span class="s2"> / 3) + &quot;</span>
        <span class="s2">&quot;$</span><span class="si">{a1}</span><span class="s2"> / 2) + $</span><span class="si">{a0}</span><span class="s2">) + $</span><span class="si">{a5}</span><span class="s2">)&quot;</span><span class="p">),</span>
        <span class="s1">&#39;cv&#39;</span><span class="p">:</span> <span class="n">Template</span><span class="p">(</span>
        <span class="s2">&quot;Ru * (T * (T * (T * (T * $</span><span class="si">{a4}</span><span class="s2"> + $</span><span class="si">{a3}</span><span class="s2">) + $</span><span class="si">{a2}</span><span class="s2">) + $</span><span class="si">{a1}</span><span class="s2">) + $</span><span class="si">{a0}</span><span class="s2"> - 1)&quot;</span><span class="p">),</span>
        <span class="s1">&#39;dcv&#39;</span><span class="p">:</span> <span class="n">Template</span><span class="p">(</span>
        <span class="s2">&quot;Ru * (T * (T * (4 * T * $</span><span class="si">{a4}</span><span class="s2"> + 3 * $</span><span class="si">{a3}</span><span class="s2"> ) + 2 * $</span><span class="si">{a2}</span><span class="s2">) + $</span><span class="si">{a1}</span><span class="s2">)&quot;</span><span class="p">),</span>
        <span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="n">Template</span><span class="p">(</span>
        <span class="s2">&quot;Ru * (T * (T * (T * (T * (T * $</span><span class="si">{a4}</span><span class="s2"> / 5 + $</span><span class="si">{a3}</span><span class="s2"> / 4) + $</span><span class="si">{a2}</span><span class="s2"> / 3) + &quot;</span>
        <span class="s2">&quot;$</span><span class="si">{a1}</span><span class="s2"> / 2) + $</span><span class="si">{a0}</span><span class="s2">) - T + $</span><span class="si">{a5}</span><span class="s2">)&quot;</span><span class="p">),</span>
        <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">Template</span><span class="p">(</span>
        <span class="s2">&quot;T * (T * (T * (T * $</span><span class="si">{a4}</span><span class="s2"> / 20 + $</span><span class="si">{a3}</span><span class="s2"> / 12) + $</span><span class="si">{a2}</span><span class="s2"> / 6) + $</span><span class="si">{a1}</span><span class="s2"> / 2) + &quot;</span>
        <span class="s2">&quot;($</span><span class="si">{a0}</span><span class="s2"> - 1) * logT - $</span><span class="si">{a0}</span><span class="s2"> + $</span><span class="si">{a6}</span><span class="s2"> - $</span><span class="si">{a5}</span><span class="s2"> * Tinv&quot;</span><span class="p">),</span>
        <span class="s1">&#39;db&#39;</span><span class="p">:</span> <span class="n">Template</span><span class="p">(</span>
        <span class="s2">&quot;T * (T * (T * $</span><span class="si">{a4}</span><span class="s2"> / 5 + $</span><span class="si">{a3}</span><span class="s2"> / 4) + $</span><span class="si">{a2}</span><span class="s2"> / 3) + $</span><span class="si">{a1}</span><span class="s2"> / 2 + &quot;</span>
        <span class="s2">&quot;Tinv * ($</span><span class="si">{a0}</span><span class="s2"> - 1 + $</span><span class="si">{a5}</span><span class="s2"> * Tinv)&quot;</span><span class="p">)}</span>
    <span class="c1"># create lo / hi equation</span>
    <span class="n">lo_eq</span> <span class="o">=</span> <span class="n">eqn_maps</span><span class="p">[</span><span class="n">nicename</span><span class="p">]</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;a&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="n">a_lo</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a_lo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">a_lo_strs</span><span class="p">)})</span>
    <span class="n">hi_eq</span> <span class="o">=</span> <span class="n">eqn_maps</span><span class="p">[</span><span class="n">nicename</span><span class="p">]</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;a&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="n">a_hi</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a_hi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">a_hi_strs</span><span class="p">)})</span>

    <span class="n">Tval</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>
    <span class="c1"># create a precomputed instruction generator</span>
    <span class="n">precompute</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">PrecomputedInstructions</span><span class="p">()</span>
    <span class="n">preinstructs</span> <span class="o">=</span> <span class="p">[</span><span class="n">precompute</span><span class="p">(</span><span class="n">Tval</span><span class="p">,</span> <span class="n">T_str</span><span class="p">,</span> <span class="s1">&#39;VAL&#39;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">nicename</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]:</span>
        <span class="n">preinstructs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precompute</span><span class="p">(</span><span class="s1">&#39;Tinv&#39;</span><span class="p">,</span> <span class="n">T_str</span><span class="p">,</span> <span class="s1">&#39;INV&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nicename</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
            <span class="n">preinstructs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precompute</span><span class="p">(</span><span class="s1">&#39;logT&#39;</span><span class="p">,</span> <span class="n">T_str</span><span class="p">,</span> <span class="s1">&#39;LOG&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">knl_info</span><span class="p">(</span><span class="n">instructions</span><span class="o">=</span><span class="n">Template</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        if $</span><span class="si">{Tval}</span><span class="s2"> &lt; $</span><span class="si">{T_mid_str}</span><span class="s2"></span>
<span class="s2">            $</span><span class="si">{out_str}</span><span class="s2"> = $</span><span class="si">{lo_eq}</span><span class="s2"> {id=low, nosync=hi}</span>
<span class="s2">        else</span>
<span class="s2">            $</span><span class="si">{out_str}</span><span class="s2"> = $</span><span class="si">{hi_eq}</span><span class="s2"> {id=hi, nosync=low}</span>
<span class="s2">        end</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">safe_substitute</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">()),</span>
                          <span class="n">kernel_data</span><span class="o">=</span><span class="n">knl_data</span><span class="p">,</span>
                          <span class="n">pre_instructions</span><span class="o">=</span><span class="n">preinstructs</span><span class="p">,</span>
                          <span class="n">name</span><span class="o">=</span><span class="s1">&#39;eval_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nicename</span><span class="p">),</span>
                          <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Ru&#39;</span><span class="p">:</span> <span class="n">chem</span><span class="o">.</span><span class="n">RU</span><span class="p">},</span>
                          <span class="n">var_name</span><span class="o">=</span><span class="n">loop_index</span><span class="p">,</span>
                          <span class="n">mapstore</span><span class="o">=</span><span class="n">mapstore</span><span class="p">,</span>
                          <span class="n">silenced_warnings</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;write_race(low)&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;write_race(hi)&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="write_chem_utils"><a class="viewcode-back" href="../../../src/pyjac.core.rate_subs.html#pyjac.core.write_chem_utils">[docs]</a><span class="k">def</span> <span class="nf">write_chem_utils</span><span class="p">(</span><span class="n">reacs</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">loopy_opts</span><span class="p">,</span> <span class="n">conp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auto_diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">mem_limits</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper function that generates kernels for</span>
<span class="sd">       evaluation of species thermodynamic quantities</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reacs : list of :class:`ReacInfo`</span>
<span class="sd">        List of species in the mechanism.</span>
<span class="sd">    specs : list of :class:`SpecInfo`</span>
<span class="sd">        List of species in the mechanism.</span>
<span class="sd">    loopy_opts : :class:`loopy_options` object</span>
<span class="sd">        A object containing all the loopy options to execute</span>
<span class="sd">    conp : bool</span>
<span class="sd">        If true, generate equations using constant pressure assumption</span>
<span class="sd">        If false, use constant volume equations</span>
<span class="sd">    test_size : int</span>
<span class="sd">        If not None, this kernel is being used for testing.</span>
<span class="sd">    auto_diff : bool</span>
<span class="sd">        If ``True``, generate files for Adept autodifferention library.</span>
<span class="sd">    mem_limits: str [&#39;&#39;]</span>
<span class="sd">        Path to a .yaml file indicating desired memory limits that control the</span>
<span class="sd">        desired maximum amount of global / local / or constant memory that</span>
<span class="sd">        the generated pyjac code may allocate.  Useful for testing, or otherwise</span>
<span class="sd">        limiting memory usage during runtime. The keys of this file are the</span>
<span class="sd">        members of :class:`pyjac.kernel_utils.memory_limits.mem_type`</span>
<span class="sd">    kwargs: dict</span>
<span class="sd">        Arguements for the construction of the :class:`kernel_generator`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    kernel_gen : :class:`kernel_generator`</span>
<span class="sd">        The generator responsible for creating the resulting code</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># figure out rates and info</span>
    <span class="n">rate_info</span> <span class="o">=</span> <span class="n">assign_rates</span><span class="p">(</span><span class="n">reacs</span><span class="p">,</span> <span class="n">specs</span><span class="p">,</span> <span class="n">loopy_opts</span><span class="o">.</span><span class="n">rate_spec</span><span class="p">)</span>

    <span class="c1"># create the namestore</span>
    <span class="n">nstore</span> <span class="o">=</span> <span class="n">arc</span><span class="o">.</span><span class="n">NameStore</span><span class="p">(</span><span class="n">loopy_opts</span><span class="p">,</span> <span class="n">rate_info</span><span class="p">,</span> <span class="n">conp</span><span class="p">,</span> <span class="n">test_size</span><span class="p">)</span>

    <span class="c1"># generate the kernels</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">conp</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;cv&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]</span>
    <span class="n">kernels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">nicename</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">kernels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">polyfit_kernel_gen</span><span class="p">(</span><span class="n">nicename</span><span class="p">,</span> <span class="n">loopy_opts</span><span class="p">,</span>
                                          <span class="n">nstore</span><span class="p">,</span> <span class="n">test_size</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">k_gen</span><span class="o">.</span><span class="n">make_kernel_generator</span><span class="p">(</span>
        <span class="n">loopy_opts</span><span class="o">=</span><span class="n">loopy_opts</span><span class="p">,</span>
        <span class="n">kernel_type</span><span class="o">=</span><span class="n">KernelType</span><span class="o">.</span><span class="n">chem_utils</span><span class="p">,</span>
        <span class="n">kernels</span><span class="o">=</span><span class="n">kernels</span><span class="p">,</span>
        <span class="n">namestore</span><span class="o">=</span><span class="n">nstore</span><span class="p">,</span>
        <span class="n">input_arrays</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">],</span>
        <span class="n">output_arrays</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
        <span class="n">auto_diff</span><span class="o">=</span><span class="n">auto_diff</span><span class="p">,</span>
        <span class="n">test_size</span><span class="o">=</span><span class="n">test_size</span><span class="p">,</span>
        <span class="n">mem_limits</span><span class="o">=</span><span class="n">mem_limits</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">kernel_type</span><span class="o">=</span><span class="n">KernelType</span><span class="o">.</span><span class="n">species_rates</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">pyJac</a></h1>



<p class="blurb">Python-based generator of analytical Jacobians for chemical kinetics</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=kyleniemeyer&repo=pyjac&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faqs.html">Frequently asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installing.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../src/index.html">pyJac API</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Nicholas Curtis, Kyle Niemeyer.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    
    <a href="https://github.com/kyleniemeyer/pyjac" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>